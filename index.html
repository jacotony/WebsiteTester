<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book Club — Lite</title>
<style>
  :root{
    /* Neutral slate / indigo — no green */
    --bg: #f7f7fb;
    --card: #ffffff;
    --ink: #0f172a;
    --muted: #475569;
    --line: #e5e7eb;
    --accent: #4f46e5; /* indigo */
    --accent-2: #4338ca;
    --gold: #f59e0b;
    --shadow: 0 10px 24px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  .container{max-width:980px;margin:0 auto;padding:16px}
  .header{ text-align:center; margin-bottom:14px }
  .header h1{ margin:0 0 6px; font-size:1.6rem }
  .header p{ margin:0; color:var(--muted) }

  .user-bar{display:none;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:8px 12px;margin:10px 0}
  .chip{border:1px solid var(--line); background:#f3f4f6; color:#111827; border-radius:999px; padding:2px 8px; font-size:12px}
  .btn{background:var(--accent); border:0; color:#fff; border-radius:12px; font-weight:800; padding:8px 12px; cursor:pointer}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#fff;color:#111827;border:1px solid var(--line)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .nav .btn{background:#111827}
  .nav .btn.active{background:var(--accent)}

  .grid{display:grid;gap:12px}
  .three{grid-template-columns:repeat(3,1fr)}
  @media (max-width:880px){ .three{grid-template-columns:1fr} }

  .card{background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow);border-radius:14px;padding:12px}
  .login{max-width:420px;margin:30px auto}
  .input,.select,.textarea{width:100%;padding:10px;border:1.5px solid var(--line);border-radius:10px;font-size:14px;background:#fff;color:var(--ink)}
  .textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px}
  @media (max-width:720px){ .row,.row3{grid-template-columns:1fr} }

  .feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .post{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:12px}
  .head{display:grid;grid-template-columns:84px 1fr;gap:10px}
  .cover{width:84px;height:120px;border-radius:10px;border:1px solid var(--line);object-fit:cover;background:#f1f5f9}
  .title{font-weight:900}
  .author{font-style:italic;color:var(--muted);font-size:13px;margin:2px 0 6px}
  .recommender{font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  .stars{display:flex;gap:2px}
  .star{font-size:18px;color:#d1d5db;cursor:pointer;background:none;border:0;padding:0}
  .star.filled{color:var(--gold)}
  .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .action{border:1px solid var(--line);background:#fff;border-radius:999px;font-weight:800;padding:6px 10px;cursor:pointer}
  .action.active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .tags{display:flex;flex-wrap:wrap;gap:4px}
  .tag{border:1px solid var(--line);background:#f3f4f6;border-radius:999px;padding:2px 6px;font-size:11px}

  .comments{margin-top:8px}
  .c-head{display:flex;justify-content:space-between;align-items:center}
  .c-list{display:grid;gap:6px;max-height:220px;overflow:auto;margin-top:6px}
  .c-item{border:1px solid var(--line);background:#fafafa;border-radius:8px;padding:8px}
  .c-like{background:none;border:0;color:#1f2937;font-weight:800;cursor:pointer}
  .c-form{display:grid;grid-template-columns:140px 1fr 120px;gap:6px;margin-top:6px}
  @media (max-width:720px){ .c-form{grid-template-columns:1fr} }

  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(6px);transition:.25s;pointer-events:none;z-index:9999}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#b91c1c}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:9998}
  .modal.show{display:flex}
  .modal-card{background:#111827;color:#fff;border-radius:12px;min-width:280px;max-width:520px;width:100%;padding:14px;border:1px solid #222}
  .modal .star{color:#94a3b8}
  .modal .star.filled{color:#fbbf24}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Club — Lite</h1>
      <p>Neutral theme. Local-only. Opens offline.</p>
    </div>

    <div id="user-bar" class="user-bar">
      <div>Welcome, <strong id="current-user-name"></strong> <span class="chip" id="stats-chip"></span></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <div id="nav" class="nav" style="display:none">
      <button class="btn active" id="tab-feed" type="button">Feed</button>
      <button class="btn" id="tab-add" type="button">Add</button>
      <button class="btn" id="tab-lists" type="button">My Lists</button>
    </div>

    <!-- LOGIN -->
    <section id="login" class="login card">
      <h2 style="margin:0 0 8px">Enter your name</h2>
      <p class="small" style="margin:0 0 10px">No accounts, just a name for your lists.</p>
      <input id="login-name" class="input" placeholder="First name" />
      <div style="height:10px"></div>
      <button id="login-btn" class="btn" type="button">Enter</button>
    </section>

    <!-- FEED -->
    <section id="feed" class="card" style="display:none">
      <div class="row3" style="margin-bottom:8px">
        <input id="search" class="input" placeholder="Search title, author, recommender…" />
        <select id="min-rating" class="select">
          <option value="0">Min ★ (Any)</option>
          <option value="5">5★</option>
          <option value="4">4★+</option>
          <option value="3">3★+</option>
        </select>
        <select id="sort-by" class="select">
          <option value="new">Newest</option>
          <option value="likes">Most Likes</option>
          <option value="rating">Highest Rated</option>
          <option value="title">Title A–Z</option>
        </select>
      </div>
      <div class="small" id="result-count" style="margin-bottom:8px"></div>
      <div id="feed-list" class="feed"></div>
    </section>

    <!-- ADD -->
    <section id="add" class="card" style="display:none">
      <h3 style="margin-top:0">Share a Recommendation</h3>
      <div class="row">
        <div>
          <label class="small">Title *</label>
          <input id="f-title" class="input" />
        </div>
        <div>
          <label class="small">Author/Host *</label>
          <input id="f-author" class="input" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label class="small">Category</label>
          <select id="f-genre" class="select">
            <option>Fiction</option><option>Non-Fiction</option><option>Business</option>
            <option>Leadership</option><option>History</option><option>Science</option>
            <option>Technology</option><option>Psychology</option><option>Philosophy</option>
            <option>Health & Fitness</option><option>Podcast</option><option>Other</option>
          </select>
        </div>
        <div>
          <label class="small">Cover (URL)</label>
          <input id="f-image" class="input" placeholder="https://…" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="small">Why I recommend this *</label>
        <textarea id="f-reason" class="textarea" placeholder="Short reason…"></textarea>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <div>
          <label class="small">Tags (comma-separated)</label>
          <input id="f-tags" class="input" placeholder="mystery, fast-paced, …" />
        </div>
        <div>
          <label class="small">Your Rating *</label>
          <div id="add-stars" class="stars" aria-label="rating">
            <button class="star" data-rating="1" type="button">★</button>
            <button class="star" data-rating="2" type="button">★</button>
            <button class="star" data-rating="3" type="button">★</button>
            <button class="star" data-rating="4" type="button">★</button>
            <button class="star" data-rating="5" type="button">★</button>
          </div>
          <div class="small" id="add-rating-tip">Click a star</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <button id="add-submit" class="btn" type="button">Share</button>
    </section>

    <!-- LISTS -->
    <section id="lists" class="card" style="display:none">
      <h3 style="margin-top:0">My Reading Lists</h3>
      <div class="grid three">
        <div class="card">
          <h4>Want to Read</h4>
          <div id="list-wish"></div>
        </div>
        <div class="card">
          <h4>Currently Reading</h4>
          <div id="list-current"></div>
        </div>
        <div class="card">
          <h4>Read</h4>
          <div id="list-read"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Rating Modal -->
  <div id="rate-modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 id="rate-heading" style="margin:0 0 6px">Rate this item</h3>
      <div id="rate-title" class="small" style="margin-bottom:6px"></div>
      <div id="rate-stars" class="stars" style="margin:6px 0 10px">
        <button class="star" data-rating="1" type="button">★</button>
        <button class="star" data-rating="2" type="button">★</button>
        <button class="star" data-rating="3" type="button">★</button>
        <button class="star" data-rating="4" type="button">★</button>
        <button class="star" data-rating="5" type="button">★</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="rate-save" class="btn" type="button">Save</button>
        <button id="rate-cancel" class="btn secondary" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ========= Utilities ========= */
const $ = (s, r) => (r||document).querySelector(s);
const $$ = (s, r) => Array.from((r||document).querySelectorAll(s));
const now = () => Date.now();
const escapeHtml = s => String(s==null?'':s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
const showToast = (msg, isError) => {
  const t = $('#toast'); t.textContent = msg; t.classList.toggle('error', !!isError);
  t.classList.add('show'); clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>t.classList.remove('show'), isError?2800:1600);
};
const save = () => localStorage.setItem('bookclub_lite', JSON.stringify({books,userData,currentUser}));
const load = () => {
  try{ const j=JSON.parse(localStorage.getItem('bookclub_lite')||'{}');
    if(j.books) books=j.books; if(j.userData) userData=j.userData; if(j.currentUser) currentUser=j.currentUser;
  }catch(_e){}
};
function average(book){
  const vals=[]; if(typeof book.rating==='number') vals.push(book.rating);
  (book.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0; return vals.reduce((a,b)=>a+b,0)/vals.length;
}

/* ========= Data ========= */
let currentUser = '';
let currentAddRating = 0;
let rateContext = null;

let books = [
  { id: now()-400000, title:'Project Hail Mary', author:'Andy Weir', genre:'Science',
    recommender:'Ava', image:'', synopsis:'', reason:'Smart, funny, and surprisingly heartfelt.',
    rating:5, userRatings:[], tags:['sci-fi','page-turner'], comments:[], postLikes:1, postLikedBy:['Ava'] },
  { id: now()-200000, title:'Atomic Habits', author:'James Clear', genre:'Productivity',
    recommender:'Leo', image:'', synopsis:'', reason:'Ridiculously practical; small steps that stick.',
    rating:4, userRatings:[], tags:['habits','self-help'], comments:[], postLikes:0, postLikedBy:[] }
];

let userData = {}; // name -> { wishList, currentReading, readList }

function me(){ if(!currentUser) return {wishList:[],currentReading:[],readList:[]};
  userData[currentUser] = userData[currentUser] || {wishList:[],currentReading:[],readList:[]};
  return userData[currentUser];
}

/* ========= Rendering ========= */
function bookCard(b){
  const liked = currentUser && (b.postLikedBy||[]).includes(currentUser);
  const avg = average(b); const rounded = Math.round(avg);
  const mine = me();
  const inRead = !!mine.readList.find(x=>String(x.id)===String(b.id));
  const status = (() => {
    if(mine.readList.find(x=>x.id===b.id)) return '<span class="chip">✅ Completed</span>';
    if(mine.currentReading.find(x=>x.id===b.id)) return '<span class="chip">📖 Reading</span>';
    if(mine.wishList.find(x=>x.id===b.id)) return '<span class="chip">📚 Want</span>';
    return '';
  })();

  return `
  <article class="post" data-id="${b.id}">
    <div class="head">
      ${b.image?`<img class="cover" src="${escapeHtml(b.image)}" alt="">`:`<div class="cover"></div>`}
      <div>
        <div class="title">${escapeHtml(b.title)}</div>
        <div class="author">by ${escapeHtml(b.author)}</div>
        <div class="recommender">Recommended by ${escapeHtml(b.recommender)}</div>
        <div class="small" style="margin:2px 0">${new Date(b.id).toLocaleDateString()} ${status}</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="stars">${Array.from({length:5},(_,i)=>`<span class="star ${i<rounded?'filled':''}">★</span>`).join('')}</div>
          <span class="small">(${avg.toFixed(1)}/5)</span>
        </div>
        <div class="tags" style="margin-top:4px">${(b.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
      </div>
    </div>

    ${b.reason?`<div class="small" style="margin-top:8px"><strong>Why:</strong> ${escapeHtml(b.reason)}</div>`:''}

    <div class="actions">
      <button class="action ${liked?'active':''}" data-action="like" data-id="${b.id}">👍 <span data-like-count>${b.postLikes||0}</span></button>
      <button class="action" data-action="wish" data-id="${b.id}">📚 Want</button>
      <button class="action" data-action="reading" data-id="${b.id}">📖 Reading</button>
      <button class="action" data-action="${inRead?'rate-again':'finish'}" data-id="${b.id}">${inRead?'⭐ Rate Again':'✅ Mark Read'}</button>
      <button class="action" data-action="share" data-id="${b.id}">🔗 Share</button>
    </div>

    <div class="comments">
      <div class="c-head">
        <span class="small"><strong>Comments</strong> (<span data-c-count>${(b.comments||[]).length}</span>)</span>
        <button class="action" data-action="toggle-comments" data-id="${b.id}">Show</button>
      </div>
      <div class="c-list" data-list="${b.id}" style="display:none">
        ${(b.comments||[]).map(c=>`
          <div class="c-item" data-comment-id="${c.id}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
              <span><strong>${escapeHtml(c.commenter||'Anonymous')}</strong> <span class="small">${new Date(c.id).toLocaleDateString()}</span></span>
              <button class="c-like" data-action="like-comment" data-id="${b.id}" data-cid="${c.id}">👍 ${c.likes||0}</button>
            </div>
            <div class="small">${escapeHtml(c.text||'')}</div>
          </div>
        `).join('')}
        <div class="c-form" data-id="${b.id}">
          <input class="input" data-field="name" placeholder="Your name" value="${escapeHtml(currentUser||'')}">
          <input class="input" data-field="text" placeholder="Write a comment…">
          <button class="btn" data-action="add-comment" data-id="${b.id}" type="button">Add Comment</button>
        </div>
      </div>
    </div>
  </article>`;
}

function applyFilters(){
  const term = ($('#search').value||'').toLowerCase().trim();
  const min = parseInt($('#min-rating').value||'0',10);
  const sort = $('#sort-by').value;
  let list = books.slice().map(b => {
    const score = (() => {
      if(!term) return 0;
      const t = term;
      const hay = [b.title,b.author,b.recommender,b.reason].map(x=>String(x||'').toLowerCase()).join(' ');
      let s = 0;
      if(b.title.toLowerCase()===t) s+=100;
      if(b.title.toLowerCase().includes(t)) s+=50;
      if(hay.includes(t)) s+=20;
      (b.tags||[]).forEach(tag => { if(String(tag).toLowerCase().includes(t)) s+=25; });
      return s;
    })();
    return Object.assign({_score:score}, b);
  }).filter(b => {
    if(term && b._score<=0) return false;
    if(min && average(b) < min) return false;
    return true;
  });

  if(term) list.sort((a,b)=> (b._score-a._score) || (b.id-a.id));
  else if(sort==='new') list.sort((a,b)=> b.id-a.id);
  else if(sort==='likes') list.sort((a,b)=> (b.postLikes||0)-(a.postLikes||0));
  else if(sort==='rating') list.sort((a,b)=> average(b)-average(a));
  else if(sort==='title') list.sort((a,b)=> a.title.localeCompare(b.title));

  $('#feed-list').innerHTML = list.map(bookCard).join('');
  $('#result-count').textContent = `${list.length} result${list.length===1?'':'s'}`;
}

function renderLists(){
  const m = me();
  const make = (arr, actions) => arr.length ? arr.map(b => `
    <div class="small" style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--line);padding:6px 0">
      <span><strong>${escapeHtml(b.title)}</strong> — ${escapeHtml(b.author)}</span>
      <span>${actions(b)}</span>
    </div>`).join('') : `<div class="small" style="font-style:italic;color:var(--muted)">Nothing here yet</div>`;

  $('#list-wish').innerHTML = make(m.wishList, b => `
    <button class="btn" data-action="reading" data-id="${b.id}" type="button">Start</button>
    <button class="btn ghost" data-action="remove-wish" data-id="${b.id}" type="button">Remove</button>
  `);

  $('#list-current').innerHTML = make(m.currentReading, b => `
    <button class="btn" data-action="finish" data-id="${b.id}" type="button">Mark Read</button>
    <button class="btn ghost" data-action="remove-current" data-id="${b.id}" type="button">Remove</button>
  `);

  $('#list-read').innerHTML = make(m.readList, b => `
    <span class="chip">${b._rating||0}★</span>
    <button class="btn" data-action="rate-again" data-id="${b.id}" type="button">Rate Again</button>
    <button class="btn ghost" data-action="remove-read" data-id="${b.id}" type="button">Remove</button>
  `);
}

function updateStatsChip(){
  const users = Object.keys(userData).length;
  const read = Object.values(userData).reduce((s,u)=>s+(u.readList||[]).length,0);
  const comments = books.reduce((s,b)=> s+((b.comments||[]).length), 0);
  $('#stats-chip').textContent = `${books.length} items • ${comments} comments • ${read} finished • ${users} users`;
}

/* ========= Modal ========= */
function openRateModal(book, updateExisting){
  rateContext = { id: book.id, updateExisting: !!updateExisting };
  $('#rate-title').textContent = `${book.title} — ${book.author}`;
  $('#rate-heading').textContent = updateExisting ? 'Update your rating' : 'Rate this item';
  let pre = 0;
  const mine = me().readList.find(x=>x.id===book.id);
  if(mine && mine._rating) pre = mine._rating;
  const existing = (book.userRatings||[]).find(r=>r.user===currentUser);
  if(existing && existing.rating) pre = existing.rating;
  currentAddRating = pre||0;
  $$('#rate-stars .star').forEach(st => {
    const v = Number(st.dataset.rating); st.classList.toggle('filled', v<=currentAddRating);
  });
  $('#rate-modal').classList.add('show');
}
function closeRateModal(){ $('#rate-modal').classList.remove('show'); rateContext=null; }

/* ========= Actions ========= */
function addComment(book, text, by){
  book.comments = book.comments || [];
  book.comments.push({ id: now(), commenter: by||'Anonymous', likes: 0, likedBy: [], text: text||'' });
}

function ensureInList(list, item){
  const exists = list.some(x=>String(x.id)===String(item.id));
  if(!exists) list.push(item);
}

function handleGlobalClick(e){
  const btn = e.target.closest('[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const id = Number(btn.getAttribute('data-id'));
  const book = books.find(b=>b.id===id);

  if(action==='toggle-comments'){
    const list = document.querySelector(`[data-list="${id}"]`);
    if(list) list.style.display = (list.style.display==='none'?'grid':'none');
    return;
  }

  if(action==='like'){
    if(!currentUser){ showToast('Log in to like', true); return; }
    book.postLikedBy = book.postLikedBy || [];
    if(book.postLikedBy.includes(currentUser)){
      book.postLikedBy = book.postLikedBy.filter(n=>n!==currentUser);
      book.postLikes = Math.max(0,(book.postLikes||0)-1);
    }else{
      book.postLikedBy.push(currentUser);
      book.postLikes = (book.postLikes||0)+1;
    }
    save(); applyFilters(); updateStatsChip(); return;
  }

  if(action==='wish'){
    if(!currentUser){ showToast('Log in first', true); return; }
    const m = me();
    ensureInList(m.wishList, {id:book.id,title:book.title,author:book.author,_changedAt:now()});
    m.currentReading = m.currentReading.filter(x=>x.id!==book.id);
    m.readList = m.readList.filter(x=>x.id!==book.id);
    save(); renderLists(); applyFilters(); updateStatsChip(); showToast('Added to Want to Read'); return;
  }

  if(action==='reading'){
    if(!currentUser){ showToast('Log in first', true); return; }
    const m = me();
    ensureInList(m.currentReading, {id:book.id,title:book.title,author:book.author,_startedAt:now(),_changedAt:now()});
    m.wishList = m.wishList.filter(x=>x.id!==book.id);
    m.readList = m.readList.filter(x=>x.id!==book.id);
    save(); renderLists(); applyFilters(); updateStatsChip(); showToast('Moved to Currently Reading'); return;
  }

  if(action==='finish' || action==='rate-again'){
    if(!currentUser){ showToast('Log in first', true); return; }
    openRateModal(book, action==='rate-again'); return;
  }

  if(action==='share'){
    const text = `“${book.title}” by ${book.author} — rec by ${book.recommender} (${average(book).toFixed(1)}★)`;
    if(navigator.share) navigator.share({title:book.title,text}).catch(()=>{});
    else if(navigator.clipboard) navigator.clipboard.writeText(text).then(()=>showToast('Copied')).catch(()=>showToast('Copy failed',true));
    else alert(text);
    return;
  }

  if(action==='like-comment'){
    if(!currentUser){ showToast('Log in first', true); return; }
    const cid = Number(btn.getAttribute('data-cid'));
    const c = (book.comments||[]).find(x=>x.id===cid); if(!c) return;
    c.likedBy = c.likedBy || [];
    if(c.likedBy.includes(currentUser)){ c.likedBy=c.likedBy.filter(n=>n!==currentUser); c.likes=Math.max(0,(c.likes||0)-1); }
    else { c.likedBy.push(currentUser); c.likes=(c.likes||0)+1; }
    save(); applyFilters(); return;
  }

  if(action==='add-comment'){
    if(!currentUser){ showToast('Log in first', true); return; }
    const form = document.querySelector(`.c-form[data-id="${id}"]`); if(!form) return;
    const name = String((form.querySelector('[data-field="name"]')||{}).value||currentUser).trim() || currentUser;
    const text = String((form.querySelector('[data-field="text"]')||{}).value||'').trim();
    if(!text){ showToast('Write a comment', true); return; }
    addComment(book, text, name);
    const countEl = form.closest('.comments').querySelector('[data-c-count]');
    if(countEl) countEl.textContent = (book.comments||[]).length;
    (form.querySelector('[data-field="text"]')||{}).value='';
    save(); applyFilters(); updateStatsChip(); return;
  }

  if(action==='remove-wish' || action==='remove-current' || action==='remove-read'){
    const m = me();
    if(action==='remove-wish') m.wishList = m.wishList.filter(x=>x.id!==id);
    if(action==='remove-current') m.currentReading = m.currentReading.filter(x=>x.id!==id);
    if(action==='remove-read') m.readList = m.readList.filter(x=>x.id!==id);
    save(); renderLists(); applyFilters(); updateStatsChip(); return;
  }
}

/* ========= Boot / Wiring ========= */
document.addEventListener('DOMContentLoaded', () => {
  load();

  // Login
  $('#login-btn').addEventListener('click', () => {
    const name = ($('#login-name').value||'').trim();
    if(!name){ showToast('Enter a name', true); return; }
    currentUser = name; me(); save();

    $('#current-user-name').textContent = currentUser;
    $('#user-bar').style.display = 'flex';
    $('#nav').style.display = 'flex';
    $('#login').style.display = 'none';
    $('#feed').style.display = 'block';
    applyFilters(); renderLists(); updateStatsChip();
  });

  $('#logout-btn').addEventListener('click', () => {
    currentUser = ''; save();
    $('#user-bar').style.display = 'none';
    $('#nav').style.display = 'none';
    $('#login').style.display = 'block';
    $('#feed').style.display = 'none';
    $('#add').style.display = 'none';
    $('#lists').style.display = 'none';
  });

  // Tabs
  const setTab = (tab) => {
    $$('#nav .btn').forEach(b=>b.classList.remove('active'));
    if(tab==='feed'){ $('#tab-feed').classList.add('active'); $('#feed').style.display='block'; $('#add').style.display='none'; $('#lists').style.display='none'; applyFilters(); }
    if(tab==='add'){ $('#tab-add').classList.add('active'); $('#feed').style.display='none'; $('#add').style.display='block'; $('#lists').style.display='none'; }
    if(tab==='lists'){ $('#tab-lists').classList.add('active'); $('#feed').style.display='none'; $('#add').style.display='none'; $('#lists').style.display='block'; renderLists(); }
  };
  $('#tab-feed').addEventListener('click', ()=>setTab('feed'));
  $('#tab-add').addEventListener('click', ()=>setTab('add'));
  $('#tab-lists').addEventListener('click', ()=>setTab('lists'));

  // Feed filters
  $('#search').addEventListener('input', applyFilters);
  $('#min-rating').addEventListener('change', applyFilters);
  $('#sort-by').addEventListener('change', applyFilters);

  // Global click actions
  document.addEventListener('click', handleGlobalClick);

  // Add form rating stars
  $$('#add-stars .star').forEach(st => st.addEventListener('click', () => {
    currentAddRating = Number(st.dataset.rating)||0;
    $$('#add-stars .star').forEach(s => s.classList.toggle('filled', Number(s.dataset.rating)<=currentAddRating));
    $('#add-rating-tip').textContent = `You selected ${currentAddRating}★`;
  }));

  // Add submit
  $('#add-submit').addEventListener('click', () => {
    if(!currentUser){ showToast('Log in first', true); return; }
    const title = $('#f-title').value.trim();
    const author = $('#f-author').value.trim();
    const genre = $('#f-genre').value.trim();
    const image = $('#f-image').value.trim();
    const reason = $('#f-reason').value.trim();
    const tags = ($('#f-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,8);
    if(!title || !author || !reason || !currentAddRating){ showToast('Title, author, reason, rating are required', true); return; }

    const book = { id: now(), title, author, genre, recommender: currentUser, image, reason,
                   rating: currentAddRating, userRatings:[], tags, comments:[], postLikes:0, postLikedBy:[] };
    books.unshift(book);
    // add to my read list immediately
    const m = me();
    m.readList.push({ id: book.id, title: book.title, author: book.author, _rating: currentAddRating, _changedAt: now() });
    save();

    // reset form
    $('#f-title').value = ''; $('#f-author').value=''; $('#f-image').value=''; $('#f-reason').value=''; $('#f-tags').value='';
    currentAddRating = 0; $$('#add-stars .star').forEach(s=>s.classList.remove('filled')); $('#add-rating-tip').textContent='Click a star';

    applyFilters(); renderLists(); updateStatsChip(); showToast('Shared!');
  });

  // Rating modal stars
  $$('#rate-stars .star').forEach(st => st.addEventListener('click', () => {
    const v = Number(st.dataset.rating); currentAddRating = v;
    $$('#rate-stars .star').forEach(s => s.classList.toggle('filled', Number(s.dataset.rating)<=v));
  }));
  $('#rate-save').addEventListener('click', () => {
    if(!rateContext){ closeRateModal(); return; }
    const book = books.find(b=>b.id===rateContext.id); if(!book){ closeRateModal(); return; }
    const rating = Number(currentAddRating)||0;
    const m = me();
    const already = m.readList.find(x=>x.id===book.id);
    if(!already){
      m.readList.push({ id: book.id, title: book.title, author: book.author, _rating: rating, _changedAt: now() });
      m.currentReading = m.currentReading.filter(x=>x.id!==book.id);
      m.wishList = m.wishList.filter(x=>x.id!==book.id);
    }else{
      already._rating = rating; already._changedAt = now();
    }
    book.userRatings = book.userRatings || [];
    const ex = book.userRatings.find(r=>r.user===currentUser);
    if(ex) ex.rating = rating; else book.userRatings.push({user:currentUser,rating});
    save(); closeRateModal(); renderLists(); applyFilters(); updateStatsChip(); showToast('Saved rating');
  });
  $('#rate-cancel').addEventListener('click', closeRateModal);
  $('#rate-modal').addEventListener('click', (e)=>{ if(e.target.id==='rate-modal') closeRateModal(); });

  // If we had a saved user, show app
  if(currentUser){
    $('#current-user-name').textContent = currentUser;
    $('#user-bar').style.display='flex';
    $('#nav').style.display='flex';
    $('#login').style.display='none';
    $('#feed').style.display='block';
    applyFilters(); renderLists(); updateStatsChip();
  }else{
    // still render feed (read-only) before login
    $('#feed').style.display='block';
    applyFilters();
  }
});
</script>
</body>
</html>
