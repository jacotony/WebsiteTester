<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>
<meta name="theme-color" content="#564fd6">
<link id="app-manifest" rel="manifest">

<style>
/* =========================
   Soft Oat Theme (no green)
   ========================= */
:root{
  --bg:#f6f3ec;              /* warm background */
  --bg2:#efeae1;             /* subtle gradient stop */
  --panel:#fcfaf5;           /* panels/cards */
  --ink:#17181c;             /* text */
  --muted:#62656e;           /* secondary text */
  --line:#e7e2d9;            /* borders */
  --accent:#564fd6;          /* indigo accent */
  --accent-2:#4338ca;        /* hover/active */
  --chip:#efeff6;            /* chip bg */
  --chip-border:#cbcbe9;
  --gold:#f59e0b;            /* stars */
  --shadow:0 10px 24px rgba(0,0,0,.08);
}

/* Optional dim mode */
body.dim {
  --bg:#111318;
  --bg2:#0d0f14;
  --panel:#181b22;
  --ink:#f3f4f6;
  --muted:#a6adbb;
  --line:#2a2f3a;
  --accent:#7c86ff;
  --accent-2:#5f69ff;
  --chip:#212633;
  --chip-border:#2e3443;
  --shadow:0 10px 24px rgba(0,0,0,.35);
}

*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 50% -200px, var(--bg2) 0%, transparent 55%),
    linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
}

/* Layout */
.container{max-width:1100px;margin:0 auto;padding:14px}
.header{text-align:center;margin-bottom:14px}
.header h1{font-size:1.8rem;margin-bottom:6px}
.header p{opacity:.95;font-size:.95rem}
.user-bar{display:none;justify-content:space-between;align-items:center;background:var(--panel);padding:8px 12px;border-radius:14px;color:var(--ink);border:1px solid var(--line);box-shadow:var(--shadow);margin:10px 0}
.toolbar{display:flex;gap:8px}

/* Buttons */
.pill-btn,.nav-btn,.c-btn{
  background:var(--accent); color:#fff; border:0; padding:8px 12px;
  border-radius:12px; cursor:pointer; font-size:12px; font-weight:800
}
.pill-btn:hover,.nav-btn:hover,.c-btn:hover{filter:brightness(1.06)}
.pill-btn:focus-visible,.nav-btn:focus-visible,.c-btn:focus-visible{outline:3px solid #c7d2fe; outline-offset:2px}
.btn-ghost{ background:var(--panel); color:var(--ink); border:1px solid var(--line) }
.chip{background:var(--chip);border:1px solid var(--chip-border);color:var(--ink);padding:2px 8px;border-radius:999px;font-size:12px}

/* Top row */
.top-row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;margin:8px 0 14px}
.stats{display:flex;gap:8px;flex-wrap:wrap}
.stat{background:var(--panel);border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:8px 10px;box-shadow:var(--shadow);font-size:12px;display:flex;align-items:center;gap:8px;cursor:pointer}
.stat strong{font-size:18px;line-height:1}
.users-pop{position:absolute;background:var(--panel);border:1px solid var(--line);border-radius:8px;box-shadow:var(--shadow);padding:8px 10px;display:none;z-index:40}

/* Leaderboard */
.leaderboard{background:var(--panel);border-radius:12px;padding:10px;box-shadow:var(--shadow);display:grid;grid-template-columns:repeat(3,1fr);gap:10px;border:1px solid var(--line)}
.lb-card{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:var(--panel);box-shadow:var(--shadow)}
.lb-card h3{font-size:14px;margin-bottom:6px}
.lb-list{display:grid;gap:6px}
.lb-row{display:flex;justify-content:space-between;align-items:center;font-size:13px}
.lb-count{background:#eaeafc;border:1px solid #c7c7f6;color:#2d2aa6;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}

/* Content shell */
.content{background:var(--panel);border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--line)}
.prelogin-row{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}

/* Activity */
.activity{border:1px solid var(--line);border-radius:10px;padding:10px;background:var(--panel)}
.activity-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.activity-head h3{font-size:14px}
.activity-body{max-height:180px;overflow:auto}
.activity.compact .activity-body{max-height:120px}
.a-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid #e5e0d6;font-size:13px}
body.dim .a-item{border-bottom-color:#2a2f3a}
.a-item:last-child{border-bottom:none}
.a-badge{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff6e6;color:#9a6b00;font-size:14px}
.a-meta{font-size:11px;color:var(--muted);margin-top:2px}
.pill{border:1px solid var(--line);background:var(--panel);padding:0 6px;border-radius:999px;font-size:11px;margin-left:6px}

/* Navs */
.nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.nav-btn{background:#1f2330}
.nav-btn.active{background:var(--accent)}
.scope-nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px}
.scope-nav .nav-btn{background:#1f2330}
.scope-nav .nav-btn.active{background:var(--accent)}

/* Search bar */
.search{display:grid;grid-template-columns:2fr 1fr repeat(3,1fr);gap:8px;margin:8px 0}
.input,.select,.textarea{width:100%;padding:10px;border:1.5px solid var(--line);border-radius:10px;font-size:14px;background:var(--panel);color:var(--ink)}
.select{background:var(--panel)}
.textarea{min-height:90px;resize:vertical}
.small{font-size:12px;color:var(--muted)}

/* Sections */
.section{display:none}.section.active{display:block}
.feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.post{border:1px solid var(--line);border-radius:16px;background:var(--panel);box-shadow:var(--shadow);padding:14px}
.head{display:grid;grid-template-columns:92px 1fr;align-items:flex-start;gap:12px}
.cover,.cover-ph{width:92px;height:138px;border-radius:10px;border:1px solid var(--line);object-fit:cover;background:#efece6;display:flex;align-items:center;justify-content:center;font-size:11px}
.genre{background:#ecebff;color:#2b287a;border:1px solid #c7c6fd;font-weight:900;border-radius:10px;padding:2px 8px;display:inline-block}
.title{font-size:1.05rem;font-weight:900}
.author{color:var(--muted);font-style:italic;margin:2px 0 4px}
.recommender{font-weight:800;margin-bottom:2px}
.rating-line{display:flex;align-items:center;gap:8px;font-size:12px;margin:2px 0 6px;color:#334155}
.stars{display:flex;gap:2px}
.star{font-size:16px;color:#d1d5db;background:none;border:none;cursor:pointer;padding:0 2px}
.star.filled{color:var(--gold)}
.tags{display:flex;flex-wrap:wrap;gap:4px}
.tag{background:#efece6;border:1px solid var(--line);border-radius:999px;font-weight:800;padding:1px 6px;font-size:11px}

.series-chip{display:inline-block;margin-left:6px;background:#1f2330;color:#fff;border:1px solid #0b1220;padding:2px 8px;border-radius:14px;font-size:11px;font-weight:900}
.status-pill{display:inline-flex;align-items:center;gap:6px;background:#efece6;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;margin:4px 0}
.timeline{display:flex;gap:10px;flex-wrap:wrap;font-size:11px;color:#334155;margin:4px 0 6px}
.timeline .tl{background:#f1eee8;border:1px solid var(--line);border-radius:999px;padding:2px 8px}

/* actions */
.actions{border-top:1px solid var(--line);display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-top:8px}
.action{background:var(--panel);color:#1f2937;border:1px solid var(--line);border-radius:999px;font-weight:900;padding:6px 10px;cursor:pointer}
body.dim .action{color:#e5e7eb}
.action:hover,.action.active{background:#ecebff;border-color:#c7c6fd;color:#2b287a}

/* comments */
.comments{margin-top:6px}
.c-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.c-title{font-weight:900;font-size:13px}
.c-toggle{background:var(--panel);border:1px solid var(--line);border-radius:999px;font-size:11px;padding:4px 10px;cursor:pointer;font-weight:800}
.c-list{display:grid;gap:6px;max-height:260px;overflow:auto}
.c-item{background:#f5f2ec;border:1px solid var(--line);border-radius:8px;padding:8px}
body.dim .c-item{background:#1c2029}
.c-like{background:none;border:none;color:#1f2937;font-size:12px;cursor:pointer;font-weight:800}
body.dim .c-like{color:#e5e7eb}
.c-like.liked{color:#2b287a}
.c-text{font-size:13px}
.c-form{display:grid;grid-template-columns:140px 1fr 120px;gap:6px;margin-top:6px}

/* results bar */
.results-bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px;gap:8px;flex-wrap:nowrap}
.results-right{display:flex;gap:6px;align-items:center;white-space:nowrap}

/* login & forms */
.login{padding:40px 12px;text-align:center}
.login-card{background:var(--panel);padding:28px;border-radius:14px;box-shadow:var(--shadow);max-width:420px;margin:0 auto;border:1px solid var(--line)}

/* Toast & modal */
.toast{position:fixed;bottom:18px;right:18px;background:#1f2330;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:#b74a4a}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

#finish-modal{position:fixed;left:50%;top:18%;transform:translate(-50%,0);background:#1f2330;color:#fff;border-radius:12px;box-shadow:0 14px 32px rgba(0,0,0,.35);padding:14px;display:none;z-index:10000;min-width:280px;max-width:520px;border:1px solid #222}
#finish-modal.show{display:block}
#finish-modal .small{color:#e5e7eb}
#finish-stars .star{color:#94a3b8}
#finish-stars .star.filled{color:#fbbf24}

.loading{opacity:.6;pointer-events:none}

/* Responsive */
@media(max-width:840px){
  .top-row{grid-template-columns:1fr}
  .leaderboard{grid-template-columns:1fr}
  .search{grid-template-columns:1fr 1fr 1fr}
  .c-form{grid-template-columns:1fr}
  .prelogin-row{grid-template-columns:1fr}
}
@media(max-width:640px){
  .search{grid-template-columns:1fr !important}
  .results-bar{flex-wrap:wrap;gap:6px}
  .results-right{width:100%;justify-content:space-between}
  .users-pop{max-width:calc(100vw - 24px);left:12px !important;right:12px !important}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Book Club</h1>
    <p id="scope-subtitle">Find your next favorite book</p>
  </div>

  <div id="user-bar" class="user-bar">
    <span>Welcome, <strong id="current-user-name"></strong>! <span id="stats-chip" class="chip"></span></span>
    <div class="toolbar">
      <button class="pill-btn btn-ghost" id="logout-btn" type="button">Switch User</button>
    </div>
  </div>

  <!-- Scope Tabs -->
  <nav class="scope-nav" id="scope-nav">
    <button class="nav-btn active" id="scope-main-btn" type="button">Main Book Club Feed</button>
    <button class="nav-btn" id="scope-wellness-btn" type="button">Wellness Related Feed</button>
  </nav>

  <div class="top-row">
    <div class="stats" id="stats">
      <div class="stat" id="stat-books" title="Jump to feed"><strong id="total-books">0</strong> items</div>
      <div class="stat"><strong id="total-reviews">0</strong> comments</div>
      <div class="stat"><strong id="avg-rating">0.0</strong> avg â˜…</div>
      <div class="stat" title="Total finished items"><strong id="books-read">0</strong> finished</div>
      <div class="stat" id="users-chip"><strong id="total-users">0</strong> users</div>
      <div id="users-pop" class="users-pop"></div>
    </div>

    <div class="leaderboard" id="leaderboard">
      <div class="lb-card"><h3>Top Recommenders</h3><div id="lb-recommenders" class="lb-list"></div></div>
      <div class="lb-card"><h3>Top Readers</h3><div id="lb-readers" class="lb-list"></div></div>
      <div class="lb-card"><h3>Most Active</h3><div id="lb-active" class="lb-list"></div></div>
    </div>
  </div>

  <main class="content">
    <!-- Pre-login activity -->
    <div id="prelogin-row" class="prelogin-row">
      <section class="activity compact" id="activity-block">
        <div class="activity-head">
          <h3>Activity</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="activity-filter" class="select" style="padding:4px 8px;font-size:12px;min-width:auto">
              <option value="">All</option>
              <option value="share">New</option>
              <option value="list">List Actions</option>
              <option value="finish">Finished</option>
              <option value="five">5â˜… Ratings</option>
              <option value="like">Likes</option>
              <option value="comment">Comments</option>
            </select>
            <button id="activity-toggle" class="pill-btn" type="button">More</button>
          </div>
        </div>
        <div id="activity-list" class="activity-body"></div>
      </section>

      <section class="activity compact" id="trending-wrap">
        <div class="activity-head"><h3>Trending</h3></div>
        <div id="trending-prelogin" class="activity-body"></div>
      </section>
    </div>

    <!-- Main nav -->
    <nav class="nav" id="main-nav" style="display:none">
      <button class="nav-btn active" id="feed-btn" type="button">Feed</button>
      <button class="nav-btn" id="add-btn" type="button">Add</button>
      <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
      <button class="nav-btn" id="prefs-btn" type="button">Preferences</button>
    </nav>

    <!-- Login -->
    <section id="login-section" class="login">
      <form class="login-card" id="login-form">
        <h2>Welcome to Book Club</h2>
        <p class="small" style="margin:6px 0 12px">Enter your first name to use your lists</p>
        <div style="margin:10px 0;background:#f0ece5;padding:8px;border-radius:8px;color:#1b2a23;font-size:12px;border:1px solid var(--line)">
          This site doesnâ€™t auto-log you in on refresh. Type the same name again to see your lists.
        </div>
        <input class="input" type="text" id="username-input" placeholder="Your first name" required style="text-align:center"/>
        <div style="height:8px"></div>
        <button class="nav-btn" type="submit">Enter</button>
      </form>
    </section>

    <!-- App -->
    <section id="main-app" style="display:none">
      <!-- FEED -->
      <section id="feed" class="section active">

        <!-- Recommended strip -->
        <div id="recs" class="recs" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:2px 0 6px">
            <h3 style="font-size:14px">Recommended For You</h3>
            <div style="display:flex;gap:6px;align-items:center">
              <button id="recs-refresh" class="pill-btn" type="button">Refresh</button>
            </div>
          </div>
          <div id="recs-row" class="recs-row" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px"></div>
        </div>

        <div class="search">
          <input type="text" class="input" placeholder="Search title, author, recommenderâ€¦" id="search-input"/>
          <select class="select" id="tag-filter"><option value="">All Tags</option></select>
          <select class="select" id="category-filter"><option value="">All Categories</option></select>
          <select class="select" id="recommender-filter"><option value="">All Recommenders</option></select>
          <select class="select" id="min-rating">
            <option value="0">Min â˜… (Any)</option>
            <option value="5">5â˜…</option>
            <option value="4">4â˜…+</option>
            <option value="3">3â˜…+</option>
          </select>
        </div>

        <div class="results-bar">
          <span class="chip" id="result-count"></span>
          <div class="results-right">
            <label class="small"><input type="checkbox" id="hide-synopses"> Hide synopses</label>
            <label class="small"><input type="checkbox" id="collapse-all"> Collapse comments</label>
            <button id="check-new-btn" class="pill-btn" type="button">Check New Releases</button>
            <select class="select" id="sort-by" style="max-width:180px">
              <option value="new">Newest</option>
              <option value="likes">Most Likes</option>
              <option value="rating">Highest Rated</option>
              <option value="title">Title Aâ€“Z</option>
            </select>
          </div>
        </div>

        <div id="books-feed" class="feed"></div>
      </section>

      <!-- ADD -->
      <section id="add" class="section">
        <div class="lb-card" style="margin-bottom:10px">
          <h3>Share a Recommendation</h3>
          <div class="search" style="grid-template-columns:1fr 1fr 1fr">
            <div>
              <label class="small">Type</label>
              <select id="media-type" class="select">
                <option value="book" selected>Book</option>
                <option value="podcast">Podcast</option>
              </select>
            </div>
            <div class="dropdown" style="position:relative">
              <label class="small">Search</label>
              <input id="book-search" class="input" type="text" placeholder="Search Google Books or Apple Podcastsâ€¦"/>
              <div id="book-results" class="users-pop" style="left:0;right:0;max-height:280px;overflow:auto"></div>
            </div>
            <div>
              <label class="small">Rating (click stars below)</label>
              <div class="stars" id="rating-stars" aria-label="rating stars">
                <button class="star" type="button" data-rating="1">â˜…</button>
                <button class="star" type="button" data-rating="2">â˜…</button>
                <button class="star" type="button" data-rating="3">â˜…</button>
                <button class="star" type="button" data-rating="4">â˜…</button>
                <button class="star" type="button" data-rating="5">â˜…</button>
              </div>
              <div id="rating-feedback" class="small">Click stars to rate (required)</div>
            </div>
          </div>

          <form id="book-form">
            <div class="search" style="grid-template-columns:1fr 1fr 1fr">
              <div><label class="small">Title *</label><input class="input" type="text" id="title" required/></div>
              <div><label class="small">Author/Host *</label><input class="input" type="text" id="author" required/></div>
              <div>
                <label class="small">Category (auto)</label>
                <select class="select" id="genre"></select>
              </div>
            </div>

            <div class="search" style="grid-template-columns:1fr 1fr 1fr">
              <div><label class="small">Series</label><input class="input" type="text" id="series-name" placeholder="Series name"/></div>
              <div><label class="small">Series #</label><input class="input" type="number" id="series-number" min="0" step="1" placeholder="e.g. 1"/></div>
              <div style="display:flex;align-items:flex-end"><label class="small" style="width:100%"><input id="watch-series" type="checkbox"/> Watch this series</label></div>
            </div>

            <div class="search" style="grid-template-columns:1fr 1fr">
              <div><label class="small">Your Name *</label><input class="input" type="text" id="recommender" required/></div>
              <div><label class="small">Cover Image (URL)</label><input class="input" type="url" id="book-image" placeholder="https://â€¦"/></div>
            </div>

            <div><label class="small">Synopsis</label><textarea class="textarea" id="synopsis" placeholder="Descriptionâ€¦"></textarea></div>

            <div>
              <label class="small">Why I recommend this *</label>
              <div class="search" style="grid-template-columns:1fr auto">
                <select id="reason-tone" class="select">
                  <option value="personal">Style: Personal</option>
                  <option value="hook">Style: Hook/Catchy</option>
                  <option value="professional">Style: Professional</option>
                  <option value="concise">Style: Concise</option>
                </select>
                <button id="reason-suggest" type="button" class="nav-btn">Suggest Reason (auto)</button>
              </div>
              <textarea class="textarea" id="reason" placeholder="Your reason (you can auto-generate above)"></textarea>
            </div>

            <div>
              <label class="small">Tags</label>
              <div class="tags-input-container" id="tags-container" style="border:1.5px solid var(--line);border-radius:8px;padding:6px;background:var(--panel)">
                <div id="tags-display" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px"></div>
                <input type="text" class="input" id="tag-input" placeholder="Add tagsâ€¦" enterkeyhint="done" autocomplete="off" style="border:0;padding:6px;background:transparent"/>
                <div class="users-pop" id="tag-suggestions" style="display:none"></div>
              </div>
            </div>

            <div style="height:6px"></div>
            <button type="submit" class="nav-btn">Share</button>
          </form>
        </div>
      </section>

      <!-- MY LISTS -->
      <section id="my-books" class="section">
        <h3 style="margin-bottom:8px">My Reading Lists</h3>
        <div class="lb-card" style="margin-bottom:8px">
          <h4>Want to Read</h4>
          <div id="wish-list"></div>
        </div>
        <div class="lb-card" style="margin-bottom:8px">
          <h4>Currently Reading</h4>
          <div id="current-reading"></div>
        </div>
        <div class="lb-card">
          <h4>Read</h4>
          <div id="read-list"></div>
        </div>
      </section>

      <!-- PREFS -->
      <section id="prefs" class="section">
        <h2 style="margin-bottom:8px;font-size:1.1rem">Preferences</h2>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Appearance</h3>
          <label class="small"><input id="pref-dim" type="checkbox"/> Use Dim Mode</label>
        </div>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Posting & Feed</h3>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <label><input id="pref-post-new" type="checkbox" checked/> Post on <strong>new</strong></label>
            <label><input id="pref-post-finish" type="checkbox" checked/> Post when someone <strong>finishes</strong></label>
            <label><input id="pref-post-5" type="checkbox" checked/> Post for <strong>new 5â˜… ratings</strong></label>
            <button id="prefs-save" class="nav-btn" type="button">Save</button>
          </div>
        </div>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Export / Backup</h3>
          <p class="small">Downloads Excel-friendly CSV + JSON (includes Wellness flag).</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="export-csv-btn" class="nav-btn" type="button">Download CSVs</button>
            <button id="export-json-btn" class="nav-btn" type="button">Download JSON</button>
            <label class="nav-btn" style="cursor:pointer"> Import JSON<input type="file" id="import-json" accept="application/json" style="display:none"> </label>
          </div>
        </div>

        <!-- Admin quick (password gated) -->
        <div class="lb-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Admin Options</h3>
            <button id="toggle-danger" class="pill-btn" type="button">Open Admin Options</button>
          </div>
          <div id="data-management" style="display:none;margin-top:8px">
            <div class="search" style="grid-template-columns:1fr auto">
              <input id="delete-book-id" class="input" placeholder="Delete item by ID">
              <button id="delete-book-btn" class="nav-btn" type="button">Delete Item</button>
            </div>
            <button id="clear-data-btn" class="nav-btn" type="button" style="background:#b74a4a">Clear ALL Data</button>
          </div>
        </div>
      </section>
    </section>
  </main>
</div>

<div id="toast" class="toast"></div>

<!-- rating modal -->
<div id="finish-modal" class="toast">
  <div>
    <h3 id="finish-heading" style="margin-bottom:6px">Rate this item</h3>
    <p id="finish-title" class="small" style="margin-bottom:6px"></p>
    <div class="stars" id="finish-stars" style="margin:6px 0 4px">
      <button class="star" data-rating="1" type="button">â˜…</button>
      <button class="star" data-rating="2" type="button">â˜…</button>
      <button class="star" data-rating="3" type="button">â˜…</button>
      <button class="star" data-rating="4" type="button">â˜…</button>
      <button class="star" data-rating="5" type="button">â˜…</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
      <button class="nav-btn" id="finish-save" type="button">Save</button>
      <button class="nav-btn" id="finish-cancel" type="button" style="background:#b74a4a">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
function rAll(str, search, replacement){ return String(str).split(search).join(replacement); }
function escapeHtml(s){ s=String(s==null?'':s); s=rAll(s,'&','&amp;'); s=rAll(s,'<','&lt;'); s=rAll(s,'>','&gt;'); return s; }
function escapeAttr(s){ return rAll(escapeHtml(s),'"','&quot;'); }
var $ = function(sel, root){ return (root||document).querySelector(sel); };
var $$ = function(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); };
var now=function(){ return new Date().toISOString(); };
var timeAgo=function(iso){ var d=new Date(iso); var s=(Date.now()-d)/1000;
  if(s<60)return String(Math.floor(s))+'s'; var m=s/60; if(m<60)return String(Math.floor(m))+'m';
  var h=m/60; if(h<24)return String(Math.floor(h))+'h'; return String(Math.floor(h/24))+'d'; };
var truncate=function(s,n){ s=String(s||''); n=n||300; return s.length>n? s.slice(0,n-1)+'â€¦' : s; };
function showToast(msg,isError){ var t=$('#toast'); t.textContent=msg; t.classList.toggle('error',!!isError); t.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(function(){ t.classList.remove('show'); }, isError?3200:1800); }
function formatDate(v){ var n=Number(v); var d=new Date(isFinite(n)?n:v); return d.toLocaleDateString(); }

/* ========= Basic Data Stores ========= */
let currentUser='';
let books=[];                 // Main feed
let wellnessBooks=[];         // Wellness feed
let activity=[]; let wellnessActivity=[];
let sitePrefs={postNew:true,postFinish:true,postFive:true,dim:false};
let isLoading=false; let currentTags=[]; let currentRating=0; let finishContext=null; let activityExpanded=false;
let currentScope='main'; // 'main' or 'wellness'
function BOOKS(){ return currentScope==='main' ? books : wellnessBooks; }
function ACTIV(){ return currentScope==='main' ? activity : wellnessActivity; }

/* ========= Theme / Dim ========= */
function applyDim(){ document.body.classList.toggle('dim', !!sitePrefs.dim); }

/* ========= Local save/load ========= */
async function loadAll(){
  if(isLoading) return; isLoading=true;
  try{
    var cached=JSON.parse(localStorage.getItem('bookclub_payload')||'{}');
    books=cached.books||[]; wellnessBooks=cached.wellnessBooks||[];
    activity=cached.activity||[]; wellnessActivity=cached.wellnessActivity||[];
    sitePrefs=Object.assign(sitePrefs,cached.sitePrefs||{});
  }catch(_e){}
  isLoading=false;
}
function saveAll(){
  localStorage.setItem('bookclub_payload', JSON.stringify({books,wellnessBooks,activity,wellnessActivity,sitePrefs}));
}

/* ========= UI Bits ========= */
function updateStats(){
  var src=BOOKS();
  var totalItems=src.length;
  var totalComments=src.reduce((s,b)=> s+((b.comments||[]).length),0);
  var readCount=(JSON.parse(localStorage.getItem('bookclub_payload')||'{}').userData||{});
  $('#total-books').textContent=String(totalItems);
  $('#total-reviews').textContent=String(totalComments);
  $('#avg-rating').textContent=(function(){
    let sum=0,n=0; src.forEach(b=>{ if(typeof b.rating==='number'){sum+=b.rating;n++;} (b.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number'){sum+=r.rating;n++;} });});
    return n?(sum/n).toFixed(1):'0.0';
  })();
  $('#books-read').textContent='â€”';
  $('#total-users').textContent='â€”';
  $('#stats-chip').textContent = `${(books.length+wellnessBooks.length)} items â€¢ ${totalComments} comments`;
}

/* ========= Category options ========= */
function populateCategoryOptions(){
  const opts=[ 'Fiction','Non-Fiction','Biography','Memoir','Self-Help','Professional','Business',
    'Leadership','Entrepreneurship','Marketing','Finance','Personal Development',
    'History','Science','Technology','Psychology','Philosophy','Spirituality/Religion',
    'Health & Fitness','Cooking','Travel','Parenting','Education',
    'Mystery','Thriller','Horror','Romance','Fantasy','Sci-Fi','Dystopian','Young Adult',
    'Classics','Literary Fiction','Poetry','Comics/Graphic Novel','Reference','Podcast','Other'
  ];
  $('#genre').innerHTML=opts.map(o=>`<option value="${o.toLowerCase()}">${o}</option>`).join('');
  const feedCat=$('#category-filter');
  feedCat.innerHTML=['<option value="">All Categories</option>']
    .concat(opts.map(o=>`<option value="${o.toLowerCase()}">${o}</option>`)).join('');
}

/* ========= Tag suggestions ========= */
var tagSuggestions=[ 'sci-fi','fantasy','romance','mystery','thriller','horror','historical-fiction','young-adult','contemporary','classic','literary-fiction','dystopian','leadership','business','productivity','entrepreneurship','marketing','personal-development','psychology','philosophy','history','science','technology','health','fitness','cooking','travel','memoir','comedy','drama','adventure','coming-of-age','family','friendship','war','economics','environment','social-justice','quick-read','page-turner','thought-provoking','emotional','inspiring','educational','practical','reference','beginner-friendly','advanced','true-crime','faith','neuroscience','time-travel','space','post-apocalyptic','podcast' ];
function renderTagsDisplay(){ $('#tags-display').innerHTML=currentTags.map(t=>`<span class="tag" data-tag="${escapeAttr(t)}">${escapeHtml(t)} Ã—</span>`).join(''); }
function addTag(t){ var x=String(t||'').trim().toLowerCase(); if(!x||currentTags.includes(x)) return; currentTags.push(x); renderTagsDisplay(); $('#tag-input').value=''; $('#tag-suggestions').style.display='none'; }

/* ========= Books rendering ========= */
function averageRatingForBook(book){
  var vals=[]; if(typeof book.rating==='number') vals.push(book.rating);
  (book.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0;
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}
function bookCard(book){
  const avg=averageRatingForBook(book);
  const rounded=Math.round(avg||0);
  return `
  <article class="post" id="book-${book.id}" data-id="${book.id}">
    <div class="head">
      ${ book.image ? `<img class="cover" loading="lazy" alt="Cover of ${escapeAttr(book.title)}" src="${escapeAttr(book.image)}"/>` : `<div class="cover-ph">${book.type==='podcast'?'Podcast':'No Cover'}</div>` }
      <div>
        <div class="genre">${ escapeHtml(book.type==='podcast' ? `ðŸŽ§ Podcast${book.genre?': '+book.genre:''}` : (book.genre||'').toUpperCase()) }</div>
        <div class="title">${escapeHtml(book.title)}</div>
        <div class="author">by ${escapeHtml(book.author)}</div>
        <div class="recommender">Recommended by ${escapeHtml(book.recommender)}</div>
        <div class="small">${formatDate(book.id)} ${book._scope==='wellness'?'<span class="chip" style="margin-left:6px">Wellness</span>':''}</div>
        <div class="rating-line">
          <div class="stars">${'â˜…'.repeat(rounded)}${'â˜†'.repeat(5-rounded)}</div>
          <span class="small">(${avg.toFixed(1)}/5)</span>
        </div>
        ${ (book.tags&&book.tags.length)?('<div class="tags">'+book.tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')+'</div>') : '' }
      </div>
    </div>
    ${ book.synopsis?(`<div class="syn" data-syn="${book.id}"><span class="syn-text" data-expanded="false">${escapeHtml(truncate(book.synopsis,280))}</span>${book.synopsis.length>280?` <button class="c-toggle" type="button" data-action="toggle-synopsis" data-id="${book.id}" data-full="${escapeAttr(book.synopsis)}">Read more</button>`:''}</div>`):''}
    ${ book.reason?(`<div class="small" style="margin-top:6px"><strong>Why:</strong> ${escapeHtml(book.reason)}</div>`):''}
    <div class="actions">
      <button class="action" type="button" data-action="wish" data-id="${book.id}">ðŸ“š Want to Read</button>
      <button class="action" type="button" data-action="reading" data-id="${book.id}">ðŸ“– Currently Reading</button>
      <button class="action" type="button" data-action="finish" data-id="${book.id}">âœ… Mark as Read</button>
      <a class="action" href="${escapeAttr(book.type==='podcast'?(book.podcastUrl||'#'):`https://www.goodreads.com/search?q=${encodeURIComponent(book.title+' '+book.author)}&search_type=books`)}" target="_blank" rel="noopener">ðŸ”— Details</a>
    </div>
  </article>`;
}
function renderBooks(){
  const c=$('#books-feed'); const list=BOOKS();
  c.innerHTML = list.length? list.map(bookCard).join('') :
    '<div style="text-align:center;padding:28px;color:var(--muted)"><h3 style="font-size:1rem">No items yet</h3><p class="small">Add a recommendation to get started.</p></div>';
  $('#result-count').textContent=String(list.length)+' result'+(list.length===1?'':'s');
}

/* ========= Filters ========= */
function populateRecommenderFilter(){
  const sel=$('#recommender-filter'); const set={};
  BOOKS().forEach(b=>{ if(b.recommender) set[b.recommender]=1; });
  const names=Object.keys(set).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML=['<option value="">All Recommenders</option>'].concat(names.map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)).join('');
}
function getAllTagsUnique(){
  const set={}; BOOKS().forEach(b=> (b.tags||[]).forEach(t=> set[String(t).toLowerCase()]=1 ));
  return Object.keys(set).sort();
}
function populateTagFilter(){
  const sel=$('#tag-filter'); const all=getAllTagsUnique();
  sel.innerHTML=['<option value="">All Tags</option>'].concat(all.map(t=>`<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`)).join('');
}
function bookSearchScore(b,term){
  if(!term) return 1;
  const t=term.toLowerCase();
  const inStr=s=>String(s||'').toLowerCase();
  const title=inStr(b.title), author=inStr(b.author), rec=inStr(b.recommender), syn=inStr(b.synopsis), rea=inStr(b.reason);
  const tags=(b.tags||[]).map(x=>String(x).toLowerCase());
  let s=0;
  if(title===t) s+=100; if(title.startsWith(t)) s+=60; if(title.includes(t)) s+=30;
  if(author.startsWith(t)) s+=30; if(author.includes(t)) s+=20;
  if(rec.includes(t)) s+=15; if(rea.includes(t)) s+=12; if(syn.includes(t)) s+=10;
  if(tags.some(x=>x.includes(t))) s+=25; return s;
}
function applyFilters(){
  const term=$('#search-input').value.trim();
  const tag=$('#tag-filter').value.trim().toLowerCase();
  const cat=$('#category-filter').value;
  const who=$('#recommender-filter').value;
  const min=parseInt($('#min-rating').value,10)||0;
  const sort=$('#sort-by').value;
  let list=BOOKS()
    .map(b=>{const o={...b,_score:bookSearchScore(b,term)};return o;})
    .filter(b=>{
      if(term && b._score<=0) return false;
      if(cat && b.genre!==cat) return false;
      if(who && b.recommender!==who) return false;
      if(min && averageRatingForBook(b) < min) return false;
      if(tag && !(b.tags||[]).map(x=>String(x).toLowerCase()).includes(tag)) return false;
      return true;
    });
  if(term){ list.sort((a,b)=> (b._score-a._score)||(b.id-a.id)); }
  else if(sort==='new'){ list.sort((a,b)=> b.id-a.id); }
  else if(sort==='likes'){ list.sort((a,b)=> (b.postLikes||0)-(a.postLikes||0)); }
  else if(sort==='rating'){ list.sort((a,b)=> averageRatingForBook(b)-averageRatingForBook(a)); }
  else if(sort==='title'){ list.sort((a,b)=> a.title.localeCompare(b.title)); }
  // render
  $('#books-feed').innerHTML=list.map(bookCard).join('') || '<div style="text-align:center;padding:28px;color:var(--muted)">No matches.</div>';
  $('#result-count').textContent=String(list.length)+' result'+(list.length===1?'':'s');
}

/* ========= External search (Books + Podcasts) ========= */
let lastSearchItems=[];
const searchGoogleBooks = async function(q){
  var box=$('#book-results'); var input=$('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; lastSearchItems=[]; return; }
  try{
    setLoading(input,true);
    const url='https://www.googleapis.com/books/v1/volumes?q='+encodeURIComponent(q.trim())+'&maxResults=10';
    const r=await fetch(url); if(!r.ok) throw new Error('Search failed '+r.status);
    const data=await r.json(); setLoading(input,false);
    lastSearchItems=(data.items||[]).map((it,i)=>{ const v=it.volumeInfo||{};
      return { index:i, type:'book',
        title:v.title||'Unknown Title',
        authors:(v.authors||[]).join(', ')||'Unknown Author',
        cover:(v.imageLinks&&v.imageLinks.thumbnail)||'',
        description:v.description||'',
        categories:v.categories||[],
        published:v.publishedDate||''
      };
    });
    renderSearchDropdown(lastSearchItems);
  }catch(e){ setLoading(input,false); box.innerHTML='<div class="small" style="padding:8px;color:#b74a4a">Search failed. Try again.</div>'; box.style.display='block'; }
};
const searchApplePodcasts = async function(q){
  var box=$('#book-results'); var input=$('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; lastSearchItems=[]; return; }
  try{
    setLoading(input,true);
    const url='https://itunes.apple.com/search?term='+encodeURIComponent(q.trim())+'&entity=podcast&limit=10';
    const r=await fetch(url); if(!r.ok) throw new Error('Search failed '+r.status);
    const data=await r.json(); setLoading(input,false);
    lastSearchItems=(data.results||[]).map((it,i)=>({
      index:i, type:'podcast',
      title:it.collectionName||'Unknown Podcast',
      authors:it.artistName||'Unknown Host',
      cover:it.artworkUrl100||'',
      description:'Podcast â€¢ '+(it.primaryGenreName||'General'),
      categories:[(it.primaryGenreName||'podcast')],
      podcastUrl:it.collectionViewUrl||''
    }));
    renderSearchDropdown(lastSearchItems);
  }catch(e){ setLoading(input,false); box.innerHTML='<div class="small" style="padding:8px;color:#b74a4a">Search failed. Try again.</div>'; box.style.display='block'; }
};
function renderSearchDropdown(items){
  var box=$('#book-results');
  if(!items.length){ box.innerHTML='<div class="small" style="padding:8px">No results</div>'; box.style.display='block'; return; }
  box.innerHTML=items.map(r=>{
    var badge = r.type==='podcast' ? 'ðŸŽ§' : 'ðŸ“š';
    return `<div class="lb-row" data-pick="${r.index}">
      <div style="display:flex;gap:8px;align-items:center">
        ${ r.cover?(`<img src="${escapeAttr(r.cover)}" class="result-cover" style="width:24px;height:24px;border-radius:4px;border:1px solid var(--line);object-fit:cover">`):'<div style="width:24px;height:24px;border-radius:4px;background:#e9ecef"></div>'}
        <div><strong>${badge} ${escapeHtml(r.title)}</strong><div class="small">${escapeHtml(r.authors)}</div></div>
      </div>
      ${(r.categories&&r.categories.length)?(`<span class="lb-count">${escapeHtml(String(r.categories[0]))}</span>`):''}
    </div>`;
  }).join('');
  box.style.display='block';
}
function setLoading(el,loading){
  if(!el)return; el.classList.toggle('loading',!!loading);
  var sp=el.parentNode && el.parentNode.querySelector('.spinner');
  if(loading && !sp){ var span=document.createElement('span'); span.className='spinner'; el.parentNode && el.parentNode.insertBefore(span, el); }
  else if(!loading && sp){ sp.parentNode && sp.parentNode.removeChild(sp); }
}

/* ========= Category AUTO-POPULATE ========= */
function inferCategory(rawCats, synopsis, type){
  if(type==='podcast') return 'podcast';
  const cats=(rawCats||[]).map(x=>String(x).toLowerCase());
  const text=String(synopsis||'').toLowerCase();
  const has=(arr,words)=>words.some(w=>arr.some(c=>c.includes(w))||text.includes(w));
  if(has(cats,['fantasy','sword','dragon','magic'])) return 'fantasy';
  if(has(cats,['science fiction','sci-fi','space','speculative'])) return 'sci-fi';
  if(has(cats,['mystery','detective','crime','whodunnit'])) return 'mystery';
  if(has(cats,['thriller','suspense','spy'])) return 'thriller';
  if(has(cats,['horror','ghost','haunted'])) return 'horror';
  if(has(cats,['romance','love'])) return 'romance';
  if(has(cats,['young adult','ya'])) return 'young adult';
  if(has(cats,['dystopian','post-apocalyptic'])) return 'dystopian';
  if(has(cats,['history'])) return 'history';
  if(has(cats,['science'])) return 'science';
  if(has(cats,['technology','computer','software'])) return 'technology';
  if(has(cats,['psychology','behavior'])) return 'psychology';
  if(has(cats,['philosophy'])) return 'philosophy';
  if(has(cats,['self-help','self help'])) return 'self-help';
  if(has(cats,['personal development'])) return 'personal development';
  if(has(cats,['business','management','entrepreneur'])) return 'business';
  if(has(cats,['biography'])) return 'biography';
  if(has(cats,['memoir'])) return 'memoir';
  if(has(cats,['poetry'])) return 'poetry';
  if(has(cats,['graphic','comics'])) return 'comics/graphic novel';
  if(has(cats,['literary'])) return 'literary fiction';
  if(has(cats,['religion','spiritual'])) return 'spirituality/religion';
  if(has(cats,['health','fitness','wellness','nutrition','sleep'])) return 'health & fitness';
  if(has(cats,['cook','cooking','food'])) return 'cooking';
  if(has(cats,['education'])) return 'education';
  if(has(cats,['parenting'])) return 'parenting';
  if(has(cats,['travel'])) return 'travel';
  if(has(cats,['finance','investing'])) return 'finance';
  // high-level fiction/non-fiction fallback
  if(has(cats,['fiction'])) return 'fiction';
  if(has(cats,['nonfiction','non-fiction'])) return 'non-fiction';
  return 'other';
}

/* ========= Recs / trivial stubs ========= */
function computeAndRenderRecs(){
  const wrap=document.getElementById('recs');
  if(!currentUser){ wrap.style.display='none'; return; }
  const row=document.getElementById('recs-row');
  const pool=BOOKS().slice(0,6);
  row.innerHTML=pool.map(b=>`
    <div class="lb-card" style="text-align:center">
      ${b.image?`<img src="${escapeAttr(b.image)}" alt="" style="width:100%;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">`:''}
      <div style="font-weight:800;margin-top:6px">${escapeHtml(b.title)}</div>
      <div class="small" style="color:var(--muted)">${escapeHtml(b.author)}</div>
      <button class="pill-btn" type="button" data-action="wish" data-id="${b.id}" style="margin-top:6px">Add</button>
    </div>`).join('');
  wrap.style.display='block';
}

/* ========= Boot ========= */
document.addEventListener('DOMContentLoaded', async function(){
  await loadAll();
  applyDim();
  populateCategoryOptions(); populateRecommenderFilter(); populateTagFilter();
  renderBooks(); updateStats();

  /* scope */
  $('#scope-main-btn').addEventListener('click', function(){ currentScope='main'; this.classList.add('active'); $('#scope-wellness-btn').classList.remove('active'); $('#scope-subtitle').textContent='Find your next favorite book'; populateRecommenderFilter(); populateTagFilter(); applyFilters(); });
  $('#scope-wellness-btn').addEventListener('click', function(){ currentScope='wellness'; this.classList.add('active'); $('#scope-main-btn').classList.remove('active'); $('#scope-subtitle').textContent='Wellness recommendations & resources'; populateRecommenderFilter(); populateTagFilter(); applyFilters(); });

  /* nav */
  $('#feed-btn').addEventListener('click', ()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $('#feed').classList.add('active'); applyFilters(); });
  $('#add-btn').addEventListener('click', ()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $('#add').classList.add('active'); });
  $('#my-books-btn').addEventListener('click', ()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $('#my-books').classList.add('active'); });
  $('#prefs-btn').addEventListener('click', ()=>{ $$('.section').forEach(s=>s.classList.remove('active')); $('#prefs').classList.add('active'); });

  /* login */
  $('#login-form').addEventListener('submit', function(e){
    e.preventDefault();
    const name=($('#username-input').value||'').trim(); if(!name) return;
    currentUser=name; $('#current-user-name').textContent=currentUser;
    $('#user-bar').style.display='flex'; $('#login-section').style.display='none'; $('#main-app').style.display='block'; $('#main-nav').style.display='flex';
    $('#recommender').value=currentUser; $('#prelogin-row').style.display='grid';
    computeAndRenderRecs();
  });
  $('#logout-btn').addEventListener('click', function(){
    currentUser=''; $('#user-bar').style.display='none'; $('#main-app').style.display='none'; $('#login-section').style.display='block'; $('#prelogin-row').style.display='none'; $('#main-nav').style.display='none';
  });

  /* activity expand/filter (prelogin sample only) */
  $('#activity-toggle').addEventListener('click', function(){ activityExpanded=!activityExpanded; });
  $('#activity-filter').addEventListener('change', function(){});

  /* filters */
  $('#search-input').addEventListener('input', applyFilters);
  $('#tag-filter').addEventListener('change', applyFilters);
  $('#category-filter').addEventListener('change', applyFilters);
  $('#recommender-filter').addEventListener('change', applyFilters);
  $('#min-rating').addEventListener('change', applyFilters);
  $('#sort-by').addEventListener('change', applyFilters);
  $('#collapse-all').addEventListener('change', renderBooks);
  $('#hide-synopses').addEventListener('change', renderBooks);
  $('#recs-refresh').addEventListener('click', computeAndRenderRecs);

  /* unified search box */
  let debounceT=null;
  function doUnifiedSearch(q){ ($('#media-type').value==='podcast') ? searchApplePodcasts(q) : searchGoogleBooks(q); }
  $('#book-search').addEventListener('input',function(e){ clearTimeout(debounceT); debounceT=setTimeout(()=>doUnifiedSearch(e.target.value),300); });
  $('#media-type').addEventListener('change', function(){
    $('#book-search').placeholder = this.value==='podcast' ? 'Search Apple Podcastsâ€¦' : 'Search Google Booksâ€¦';
    $('#book-results').style.display='none'; $('#book-results').innerHTML=''; lastSearchItems=[];
    if(this.value==='podcast'){ $('#genre').value='podcast'; }
  });

  /* pick from dropdown => fill form + AUTO-CATEGORY */
  document.addEventListener('click',function(e){
    const el=e.target.closest && e.target.closest('[data-pick]');
    if(!el) return;
    const i=Number(el.getAttribute('data-pick')); const it=lastSearchItems[i]; if(!it) return;
    $('#title').value=it.title; $('#author').value=it.authors; $('#book-image').value=it.cover||''; $('#synopsis').value=it.description||'';
    // infer category and set it
    const inferred = inferCategory(it.categories, it.description, it.type);
    const genreSel = $('#genre'); if(genreSel){ genreSel.value = inferred; }
    // tags
    currentTags=[]; if(it.categories && it.categories.length) currentTags=currentTags.concat(it.categories.slice(0,3).map(x=>String(x).toLowerCase()));
    renderTagsDisplay();
    // For podcasts, store link + ensure category
    if(it.type==='podcast'){
      $('#media-type').value='podcast';
      $('#book-form').dataset.podcastUrl = it.podcastUrl || '';
      if($('#genre').value!=='podcast') $('#genre').value='podcast';
      if(!currentTags.includes('podcast')) currentTags.unshift('podcast');
      renderTagsDisplay();
    } else {
      $('#media-type').value='book';
      $('#book-form').dataset.podcastUrl='';
    }
    $('#book-results').style.display='none';
  });

  /* tag UI */
  $('#tags-display').addEventListener('click', function(e){
    var x=e.target.closest && e.target.closest('.tag'); if(!x) return;
    var t=x.getAttribute('data-tag'); currentTags=currentTags.filter(y=>y!==t); renderTagsDisplay();
  });
  $('#tag-input').addEventListener('input',function(e){
    var q=(e.target.value||'').toLowerCase().trim(); var s=$('#tag-suggestions');
    if(!q){s.style.display='none';return;}
    var items=tagSuggestions.filter(t=>t.includes(q) && !currentTags.includes(t)).slice(0,8);
    s.innerHTML=items.map(t=>`<div class="lb-row" data-tagpick="${t}"><div>${t}</div></div>`).join('');
    s.style.display=items.length?'block':'none';
  });
  document.addEventListener('click',function(e){
    var t=e.target.closest && e.target.closest('[data-tagpick]');
    if(t){ addTag(t.getAttribute('data-tagpick')); $('#tag-suggestions').style.display='none'; }
  });
  (function(){
    var tagInput = document.getElementById('tag-input'); if(!tagInput) return;
    function commitTag(){ var val=(tagInput.value||'').trim(); if(val) addTag(val); }
    tagInput.addEventListener('keydown', function(e){
      var key=e.key||''; if(key==='Enter' || e.keyCode===13 || key===',' || key==='Tab'){ e.preventDefault(); commitTag(); }
    });
  })();

  /* rating stars (Add form) */
  $$('#rating-stars .star').forEach(star=>{
    star.addEventListener('click', function(){
      var val=Number(star.getAttribute('data-rating'));
      currentRating=val;
      $$('#rating-stars .star').forEach(s=> s.classList.toggle('filled', Number(s.getAttribute('data-rating'))<=val));
      $('#rating-feedback').textContent='You selected '+val+' star'+(val===1?'':'s')+'.';
    });
  });

  /* Save new rec */
  $('#book-form').addEventListener('submit', function(e){
    e.preventDefault();
    if(!currentUser){ showToast('Please log in first.', true); return; }
    var title=$('#title').value.trim(), author=$('#author').value.trim();
    var genre=$('#genre').value, recommender=(($('#recommender').value)||currentUser).trim();
    var image=$('#book-image').value.trim(), synopsis=$('#synopsis').value.trim(), reason=$('#reason').value.trim();
    var seriesName=($('#series-name').value||'').trim(); var seriesNumber=($('#series-number').value||'').trim();
    var mediaType = ($('#media-type').value||'book');
    if(!title||!author||!reason||!currentRating){ showToast('Title, author/host, rating, and reason are required.',true); return; }
    var book={id:Date.now(),
      type: mediaType, title, author, genre, recommender, image, synopsis, reason,
      rating:currentRating, userRatings:[], tags:currentTags.slice(), comments:[], postLikes:0, postLikedBy:[], _scope:currentScope,
      seriesName:seriesName || '', seriesNumber:seriesNumber || ''
    };
    if(mediaType==='podcast'){
      var link = $('#book-form').dataset.podcastUrl || '';
      if(link){ book.podcastUrl = link; }
      if(!book.genre || book.genre==='other') book.genre = 'podcast';
      if(book.tags.indexOf('podcast')===-1) book.tags.unshift('podcast');
    }
    BOOKS().unshift(book);
    // reset
    $('#book-form').reset(); currentTags=[]; renderTagsDisplay(); currentRating=0;
    $$('#rating-stars .star').forEach(s=> s.classList.remove('filled'));
    $('#rating-feedback').textContent='Click stars to rate (required)';
    $('#book-results').style.display='none'; $('#book-form').dataset.podcastUrl='';
    saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); updateStats(); showToast('Shared!');
  });

  /* Comments & actions on feed (wish/reading/finish + synopsis toggle) */
  document.addEventListener('click',function(e){
    var btn=e.target.closest && e.target.closest('[data-action]');
    if(!btn) return;
    var action=btn.getAttribute('data-action'); var bookId=btn.getAttribute('data-id');
    const findBook=id=> BOOKS().concat(currentScope==='main'?wellnessBooks:books).find(b=>String(b.id)===String(id));
    if(action==='toggle-synopsis'){
      var full=btn.getAttribute('data-full')||''; var wrap=document.querySelector('.syn[data-syn="'+bookId+'"]');
      if(!wrap) return; var span=wrap.querySelector('.syn-text'); if(!span) return;
      var expanded=span.getAttribute('data-expanded')==='true';
      if(expanded){ span.textContent = (full.length>280? full.slice(0,279)+'â€¦' : full); span.setAttribute('data-expanded','false'); btn.textContent='Read more'; }
      else{ span.textContent = full; span.setAttribute('data-expanded','true'); btn.textContent='Show less'; }
      return;
    }
    if(action==='wish' || action==='reading' || action==='finish'){
      if(!currentUser){ showToast('Log in first.', true); return; }
      var b=findBook(bookId); if(!b) return;
      if(action==='finish'){ // quick modal for rating again
        finishContext = {bookId:b.id}; currentRating = b.userRatings?.find(r=>r.user===currentUser)?.rating || (b.rating||0);
        $('#finish-title').textContent = b.title+' â€” '+b.author;
        $$('#finish-stars .star').forEach(star=>{ var val=Number(star.getAttribute('data-rating')); star.classList.toggle('filled', val<=currentRating); });
        $('#finish-modal').classList.add('show');
        return;
      }
      showToast(action==='wish'?'Added to Want to Read':'Moved to Currently Reading');
      return;
    }
  });
  $('#finish-save').addEventListener('click', function(){
    try{
      if(!finishContext){ $('#finish-modal').classList.remove('show'); return; }
      var all=books.concat(wellnessBooks); var book=all.find(b=>String(b.id)===String(finishContext.bookId)); if(!book){ $('#finish-modal').classList.remove('show'); return; }
      var rating = isFinite(currentRating) ? currentRating : 0;
      book.userRatings = book.userRatings || [];
      var ex = book.userRatings.find(r=>r.user===currentUser);
      if(ex) ex.rating = rating; else book.userRatings.push({user:currentUser,rating});
      saveAll(); $('#finish-modal').classList.remove('show'); applyFilters(); updateStats(); showToast('Marked as read!');
    }catch(e){ console.warn(e); $('#finish-modal').classList.remove('show'); showToast('Saved locally.',true); }
  });
  $('#finish-cancel').addEventListener('click', ()=> $('#finish-modal').classList.remove('show'));
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') $('#finish-modal').classList.remove('show'); });

  /* Prefs */
  $('#prefs-save').addEventListener('click', function(){
    sitePrefs.postNew=$('#pref-post-new').checked;
    sitePrefs.postFinish=$('#pref-post-finish').checked;
    sitePrefs.postFive=$('#pref-post-5').checked;
    sitePrefs.dim=$('#pref-dim').checked;
    saveAll(); applyDim(); showToast('Preferences saved.');
  });

  /* Admin (simple) */
  const ADMIN_PASSWORD='Prob1234';
  $('#toggle-danger').addEventListener('click', function(){
    var dm=$('#data-management');
    if(dm.style.display==='none' || !dm.style.display){
      var pw=prompt('Enter admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
      dm.style.display='block';
    }else{ dm.style.display='none'; }
  });
  $('#delete-book-btn').addEventListener('click', function(){
    var idStr=$('#delete-book-id').value.trim(); if(!idStr){ showToast('Enter an ID',true); return; }
    var id=Number(idStr);
    var before=(books.length+wellnessBooks.length);
    books = books.filter(b=>b.id!==id);
    wellnessBooks = wellnessBooks.filter(b=>b.id!==id);
    if((books.length+wellnessBooks.length)===before){ showToast('No item with that ID found',true); return; }
    saveAll(); applyFilters(); updateStats(); showToast('Item deleted.');
  });
  $('#clear-data-btn').addEventListener('click', function(){
    if(prompt('Type ERASE to confirm:')!=='ERASE') return;
    books=[]; wellnessBooks=[]; activity=[]; wellnessActivity=[];
    saveAll(); applyFilters(); updateStats(); showToast('All data cleared.');
  });

  /* Check new releases (stub) */
  $('#check-new-btn').addEventListener('click', function(){ showToast('Checked series (demo)'); });

  /* Install prompt: keep quiet on file:// */
});

/* tiny helpers used above */
function escapeAttr(s){ return (''+s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
</script>
</body>
</html>
