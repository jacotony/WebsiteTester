<!DOCTYPE html>
<html lang="en">
<style id="plotlines-theme">
/* ===== Plotlines look: neutral slate + crisp cards ===== */
:root{
  /* keep your variables but neutralize the palette */
  --pine:#4f46e5;           /* indigo for accents (no green) */
  --spruce:#0f172a;         /* slate-900 */
  --sage:#e5e7eb;           /* gray-200 */
  --silver:#cbd5e1;         /* slate-300 */
  --mist:#f8fafc;           /* slate-50 */
  --accent:#4f46e5;         /* indigo-600 */
  --ink:#111827;            /* gray-900 */
  --muted:#6b7280;          /* gray-500 */
  --line:#e5e7eb;           /* gray-200 */
  --gold:#f59e0b;           /* amber-500 */
  --shadow:0 10px 24px rgba(15,23,42,.08);
}

/* kill the green gradient */
body{ background:var(--mist) !important; color:var(--ink) }

/* header subtitle = clear scope pill */
.header p#scope-subtitle{
  display:inline-flex; align-items:center; gap:8px;
  background:#fff; border:1px solid var(--line); border-radius:999px;
  padding:4px 10px; font-weight:800; color:#1f2937;
}
html[data-scope="main"]  .header p#scope-subtitle{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3 }
html[data-scope="wellness"] .header p#scope-subtitle{ background:#ecfeff; border-color:#a5f3fc; color:#0c4a6e }

/* make scope tabs clean */
.scope-nav .nav-btn{
  background:#ffffff !important; color:#1f2937 !important; border:1px solid var(--line) !important;
  border-radius:10px; font-weight:900;
}
.scope-nav .nav-btn.active{
  background:#eef2ff !important; border-color:#c7d2fe !important; color:#3730a3 !important;
}

/* hide Preferences tab in the main nav */
#prefs-btn{ display:none !important; }

/* ===== FEED ‚Üí true card grid like Plotlines ===== */
.feed{
  display:grid !important;
  grid-template-columns: repeat(auto-fill, minmax(320px,1fr)) !important;
  gap:16px !important;
}

/* Card */
.post{
  border:1px solid var(--line) !important;
  border-left:none !important;
  border-radius:16px !important;
  background:#fff !important;
  box-shadow:var(--shadow) !important;
  padding:14px !important;
}

/* Card header ‚Üí cover left, text right (compact, tidy) */
.post .head{
  display:grid !important;
  grid-template-columns: 92px 1fr !important;
  align-items:flex-start !important;
  gap:12px !important;
}
.cover, .cover-ph{
  width:92px !important; height:138px !important; border-radius:10px !important;
  border:1px solid var(--line) !important;
}

/* Metadata styles (Plotlines-like typography) */
.genre{
  background:#eef2ff !important; color:#312e81 !important; border:1px solid #c7d2fe !important;
  font-weight:900 !important; border-radius:10px !important;
}
.title{ font-size:1.05rem !important; font-weight:900 !important; color:#0f172a !important; }
.author{ color:#475569 !important; font-style:normal !important; }
.recommender{ color:#111827 !important; font-weight:800 !important; }
.small{ color:#64748b !important; }

/* rating stars line */
.stars .star, .stars{ color:var(--gold) !important; }
.rating-line .small{ color:#475569 !important; }

/* tags + chips */
.tag{
  background:#f1f5f9 !important; border:1px solid var(--line) !important; color:#0f172a !important;
  border-radius:999px !important; font-weight:800 !important;
}

/* action buttons = minimal pills */
.actions{ border-top:1px solid var(--line) !important; border-bottom:none !important; }
.action{
  background:#ffffff !important; color:#1f2937 !important; border:1px solid var(--line) !important;
  border-radius:999px !important; font-weight:900 !important;
}
.action:hover, .action.active{ background:#eef2ff !important; border-color:#c7d2fe !important; color:#3730a3 !important; }

/* comments surface */
.c-item{ background:#f8fafc !important; border:1px solid var(--line) !important; }

/* stat chips / leaderboards cleaned up */
.stat{ background:#fff !important; border:1px solid var(--line) !important; color:#1f2937 !important; box-shadow:var(--shadow) !important; }
.lb-card{ background:#fff !important; border:1px solid var(--line) !important; box-shadow:var(--shadow) !important; }

/* inputs/buttons (no green) */
.nav-btn, .pill-btn, .c-btn{
  background:var(--accent) !important; border:0 !important; color:#fff !important;
  border-radius:12px !important; font-weight:900 !important;
}
.nav-btn.active{ background:#4338ca !important; }

/* collapse comments toggle button */
.c-toggle{
  background:#ffffff !important; color:#1f2937 !important; border:1px solid var(--line) !important;
  border-radius:999px !important; font-weight:800 !important;
}
</style>

  <head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>

<!-- PWA / Home-screen meta -->
<meta name="theme-color" content="#2f4a3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Book Club">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link id="app-manifest" rel="manifest">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAADYCAQAAAAzSx0mAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE="/>

<style>
:root{
  --pine:#1f3b31; --spruce:#2e5648; --sage:#9aaea0; --silver:#c2c7c9; --mist:#f0e2d7; --accent:#c68663;
  --ink:#233a33; --muted:#4a5550; --line:#d7dfdb; --gold:#b8860b; --glass:rgba(255,255,255,.18); --glass-2:rgba(255,255,255,.28);
  --shadow:0 14px 28px rgba(0,0,0,.10);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
  background: radial-gradient(1200px 600px at 50% -200px, var(--mist) 0%, transparent 60%),
              linear-gradient(135deg,var(--spruce) 0%,var(--pine) 45%,var(--sage) 100%);
  min-height:100vh;padding:14px;color:var(--ink)
}
.container{max-width:1100px;margin:0 auto}
.header{color:#fff;text-align:center;margin-bottom:14px}
.header h1{font-size:1.8rem;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,.25)}
.header p{opacity:.95;font-size:.95rem}
.user-bar{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:6px 12px;border-radius:14px;color:#fff;margin:10px 0;backdrop-filter:blur(10px);border:1px solid var(--glass-2)}
.toolbar{display:flex;gap:6px}
.pill-btn{ background:var(--pine); border:2px solid #0d1b16; color:#fff; padding:6px 12px; border-radius:999px; cursor:pointer;font-size:12px;font-weight:700 }
.pill-btn:hover{filter:brightness(1.08)}
.pill-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}
.status-chip{margin-left:8px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.6);opacity:.9}

.top-row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;margin:8px 0 14px}
.stats{display:flex;gap:8px;flex-wrap:wrap}
.stat{background:var(--glass);padding:8px 10px;border-radius:12px;color:#fff;border:1px solid var(--glass-2);backdrop-filter:blur(12px);font-size:12px;display:flex;align-items:center;gap:8px;cursor:pointer}
.stat strong{font-size:18px;line-height:1}
.users-pop{position:absolute;background:#fff;border:1px solid #e6ece8;border-radius:8px;box-shadow:0 10px 22px rgba(0,0,0,.12);padding:8px 10px;display:none;z-index:40}

.leaderboard{background:#faf9f6;border-radius:12px;padding:10px;box-shadow:var(--shadow);display:grid;grid-template-columns:repeat(3,1fr);gap:10px;border:1px solid var(--line)}
.lb-card{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f7f9f8}
.lb-card h3{font-size:14px;color:#1b2a23;margin-bottom:6px}
.lb-list{display:grid;gap:6px}
.lb-row{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#20362c}
.lb-count{background:#e8efe9;border:1px solid #b9c9bf;color:#1b2a23;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}

.content{background:#fbfbf7;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--line)}
.prelogin-row{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.activity{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:0;background:#f9fbfa}
.activity-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.activity-head h3{font-size:14px;color:#1b2a23}
.activity-body{max-height:180px;overflow:auto}
.activity.compact .activity-body{max-height:120px}
.a-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid #edf3ef;font-size:13px;color:#233a33}
.a-item:last-child{border-bottom:none}
.a-badge{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff6e6;font-size:14px}
.a-meta{font-size:11px;color:#6b7771;margin-top:2px}
.pill{border:1px solid #b9c9bf;background:#f1f6f3;color:#1b2a23;padding:0 6px;border-radius:999px;font-size:11px;margin-left:6px}

/* navs */
.nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.nav-btn{ background:var(--pine); color:#fff; border:2px solid #0d1b16; padding:8px 14px;border-radius:22px;cursor:pointer;transition:.2s;font-size:13px;font-weight:800 }
.nav-btn:hover,.nav-btn.active{filter:brightness(1.1)}
.nav-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}

/* scope nav */
.scope-nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px}
.scope-nav .nav-btn{background:#143127}
.scope-nav .nav-btn.active{filter:brightness(1.15)}

.search{display:grid;grid-template-columns:2fr 1fr repeat(3,1fr);gap:8px;margin:8px 0}
.chip{background:#e8efe9;border:1px solid #b9c9bf;color:#13211b;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}

.section{display:none}.section.active{display:block}
.feed{display:flex;flex-direction:column;gap:12px}
.post{border:1px solid var(--line);border-left:6px solid #1b3a30;border-radius:12px;padding:14px;box-shadow:0 8px 16px rgba(0,0,0,.06);background:#fffefb}
.head{display:flex;gap:12px;align-items:flex-start}
.cover{width:78px;height:116px;object-fit:cover;border-radius:8px;border:1px solid #e6ece8;flex-shrink:0}
.cover-ph{width:78px;height:116px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#2d3436;flex-shrink:0}

.info{flex:1}
.genre{background:var(--pine);color:#fff;padding:2px 8px;border-radius:14px;font-size:11px;font-weight:800;display:inline-block;margin-bottom:6px;border:2px solid #0d1b16}
.title{font-size:1.12rem;font-weight:900;color:var(--ink);line-height:1.2}
.author{color:#2a3a33;font-style:italic;margin:2px 0 4px;font-size:13px}
.recommender{font-size:.95rem;color:#234338;font-weight:800;margin-bottom:4px}
.rating-line{display:flex;align-items:center;gap:8px;font-size:12px;margin:2px 0 6px;color:#2a3a33}
.stars{display:flex;gap:2px}
.star{font-size:16px;color:#d0d5cf;background:none;border:none;cursor:pointer;padding:0 2px}
.star.filled{color:var(--gold)}
.tags{display:flex;flex-wrap:wrap;gap:4px}
.tag{background:#eef4ef;border:1px solid #b9c9bf;color:#1b2a23;padding:1px 6px;border-radius:999px;font-size:11px;font-weight:700}

/* PlotLines bits */
.series-chip{display:inline-block;margin-left:6px;background:#143127;color:#fff;border:2px solid #0d1b16;padding:2px 8px;border-radius:14px;font-size:11px;font-weight:900}
.status-pill{display:inline-flex;align-items:center;gap:6px;background:#e8efe9;border:1px solid #b9c9bf;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;color:#1b2a23;margin:4px 0}
.timeline{display:flex;gap:10px;flex-wrap:wrap;font-size:11px;color:#355046;margin:4px 0 6px}
.timeline .tl{background:#f3f7f4;border:1px solid #d2ded5;border-radius:999px;padding:2px 8px}

/* rec strip + coming soon */
.recs{display:none;margin:4px 0 10px}
.recs.show{display:block}
.recs-row{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.rec-card{border:1px solid var(--line);background:#fffefb;border-radius:10px;padding:8px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
.rec-title{font-size:12px;font-weight:800;color:#1e2f27;line-height:1.2;margin-top:4px}
.rec-btn{ margin-top:6px; width:100%; background:#1f3b31; color:#fff; border:2px solid #0d1b16; padding:6px 8px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer }
#coming-soon-box{display:none;margin-bottom:10px}

/* comments */
.comments{margin-top:6px}
.c-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.c-title{font-weight:900;color:#27443a;font-size:13px}
.c-toggle{background:#fff;border:2px solid var(--pine);border-radius:999px;font-size:11px;padding:4px 10px;cursor:pointer;color:#pine;font-weight:800}
.c-toggle:hover{background:var(--pine);color:#fff}
.c-list{display:grid;gap:6px;max-height:260px;overflow:auto}
.c-item{background:#f5f8f6;border:1px solid #dbe5de;border-radius:8px;padding:8px}
.c-headline{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:13px}
.c-name{font-weight:900;color:#27443a}
.c-like{background:none;border:none;color:#355e4e;font-size:12px;cursor:pointer;font-weight:800}
.c-like.liked{color:#173328}
.c-text{color:#2a3a33;font-size:13px}
.c-form{display:grid;grid-template-columns:140px 1fr 120px;gap:6px;margin-top:6px}
.c-input,.c-textarea{padding:8px;border:2px solid var(--line);border-radius:8px;font-size:13px;background:#fffefb}
.c-btn{background:var(--pine);color:#fff;border:2px solid #0d1b16;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900}

.login{padding:40px 12px;text-align:center}
.login-card{background:#faf9f6;padding:28px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.12);max-width:420px;margin:0 auto;border:1px solid var(--line)}
.input,.select,.textarea{width:100%;padding:10px;border:2px solid var(--line);border-radius:8px;font-size:15px;transition:.2s border-color;color:var(--ink);background:#fffefb}
.textarea{resize:vertical;min-height:90px}
.input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--pine)}
.select{background:#fffefb}
.small{font-size:12px;color:#2b3832}

.toast{position:fixed;bottom:18px;right:18px;background:#1d1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:#b74a4a}

.loading{opacity:.6;pointer-events:none}

#finish-modal{ right:auto; left:50%; pointer-events:auto; }
#finish-modal.show{ transform:translate(-50%,0); }
#finish-modal .small{ color:#e8ecef; }
#finish-modal { pointer-events: auto; }
#finish-modal.show { transform: translate(-50%, 0); }

.spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

.results-bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px;gap:8px;flex-wrap:nowrap}
.results-right{display:flex;gap:6px;align-items:center;white-space:nowrap}

@media(max-width:840px){
  .top-row{grid-template-columns:1fr}
  .leaderboard{grid-template-columns:1fr}
  .search{grid-template-columns:1fr 1fr 1fr}
  .c-form{grid-template-columns:1fr}
  .prelogin-row{grid-template-columns:1fr}
  .recs-row{grid-template-columns:repeat(3,1fr)}
}
@media (max-width:640px){
  .search{ grid-template-columns:1fr !important; }
  .results-bar{ flex-wrap:wrap; gap:6px; }
  .results-right{ width:100%; justify-content:space-between; }
  .users-pop{ max-width:calc(100vw - 24px); left:12px !important; right:12px !important; }
  .recs-row{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Book Club</h1>
    <p id="scope-subtitle">Find your next favorite book</p>
  </div>

  <div id="user-bar" class="user-bar">
    <span>Welcome, <strong id="current-user-name"></strong>!</span>
    <div class="toolbar">
      <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
    </div>
  </div>

  <!-- Scope Tabs -->
  <nav class="scope-nav" id="scope-nav">
    <button class="nav-btn active" id="scope-main-btn" type="button">Fun Books</button>
    <button class="nav-btn" id="scope-wellness-btn" type="button">Wellness Related</button>
  </nav>

  <div class="top-row">
    <div class="stats" id="stats">
      <div class="stat" id="stat-books" title="Jump to feed">
        <strong id="total-books">0</strong> items
      </div>
      <div class="stat"><strong id="total-reviews">0</strong> comments</div>
      <div class="stat"><strong id="avg-rating">0.0</strong> avg ‚òÖ</div>
      <div class="stat" title="Total finished items"><strong id="books-read">0</strong> finished</div>
      <div class="stat" id="users-chip">
        <strong id="total-users">0</strong> users
      </div>
      <div id="users-pop" class="users-pop"></div>
    </div>

    <div class="leaderboard" id="leaderboard">
      <div class="lb-card">
        <h3>Top Recommenders</h3>
        <div id="lb-recommenders" class="lb-list"></div>
      </div>
      <div class="lb-card">
        <h3>Top Readers</h3>
        <div id="lb-readers" class="lb-list"></div>
      </div>
      <div class="lb-card">
        <h3>Most Active</h3>
        <div id="lb-active" class="lb-list"></div>
      </div>
    </div>
  </div>

  <main class="content">

    <!-- Pre-login activity -->
    <div id="prelogin-row" class="prelogin-row">
      <section class="activity compact" id="activity-block">
        <div class="activity-head">
          <h3>Activity</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="activity-filter" class="select" style="padding:4px 8px;font-size:12px;min-width:auto">
              <option value="">All</option>
              <option value="share">New</option>
              <option value="list">List Actions</option>
              <option value="finish">Finished</option>
              <option value="five">5‚òÖ Ratings</option>
              <option value="like">Likes</option>
              <option value="comment">Comments</option>
            </select>
            <button id="activity-toggle" class="pill-btn" type="button">More</button>
          </div>
        </div>
        <div id="activity-list" class="activity-body"></div>
      </section>

      <section class="activity compact" id="trending-wrap">
        <div class="activity-head">
          <h3>Trending</h3>
        </div>
        <div id="trending-prelogin" class="activity-body"></div>
      </section>
    </div>

    <!-- Main nav -->
    <nav class="nav" id="main-nav">
      <button class="nav-btn active" id="feed-btn" type="button">Feed</button>
      <button class="nav-btn" id="add-btn" type="button">Add</button>
      <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
      <button class="nav-btn" id="prefs-btn" type="button">Preferences</button>
    </nav>

    <!-- Login -->
    <section id="login-section" class="login">
      <form class="login-card" id="login-form">
        <h2>Welcome to Book Club</h2>
        <p class="small" style="margin:6px 0 12px">Enter your first name to use your lists</p>
        <div style="margin-bottom:10px;background:#f7f8f8;padding:8px;border-radius:8px;color:#1b2a23;font-size:12px;border:1px solid var(--line)">
          This site doesn‚Äôt auto-log you in on refresh. Type the same name again to see your lists.
        </div>
        <input class="input" type="text" id="username-input" placeholder="Your first name" required style="text-align:center"/>
        <div style="height:8px"></div>
        <button class="nav-btn" type="submit">Enter</button>
      </form>
    </section>

    <!-- App -->
    <section id="main-app" style="display:none">
      <!-- FEED -->
      <section id="feed" class="section active">

        <!-- Recommended strip (PlotLines) -->
        <div id="recs" class="recs">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:2px 0 6px">
            <h3 style="font-size:14px;color:#1b2a23">Recommended For You</h3>
            <div style="display:flex;gap:6px;align-items:center">
              <button id="recs-refresh" class="pill-btn" type="button">Refresh</button>
            </div>
          </div>
          <div id="recs-row" class="recs-row"></div>
        </div>

        <div class="search">
          <input type="text" class="input" placeholder="Search title, author, recommender‚Ä¶" id="search-input"/>
          <select class="select" id="tag-filter"><option value="">All Tags</option></select>
          <select class="select" id="category-filter"><option value="">All Categories</option></select>
          <select class="select" id="recommender-filter"><option value="">All Recommenders</option></select>
          <select class="select" id="min-rating">
            <option value="0">Min ‚òÖ (Any)</option>
            <option value="5">5‚òÖ</option>
            <option value="4">4‚òÖ+</option>
            <option value="3">3‚òÖ+</option>
          </select>
        </div>

        <div class="results-bar">
          <span class="chip" id="result-count"></span>
          <div class="results-right">
            <label class="small"><input type="checkbox" id="hide-synopses"> Hide synopses</label>
            <label class="small"><input type="checkbox" id="collapse-all"> Collapse comments</label>
            <button id="check-new-btn" class="pill-btn" type="button" title="Check watched series for upcoming releases">Check New Releases</button>
            <select class="select" id="sort-by" style="max-width:180px">
              <option value="new">Newest</option>
              <option value="likes">Most Likes</option>
              <option value="rating">Highest Rated</option>
              <option value="title">Title A‚ÄìZ</option>
            </select>
          </div>
        </div>

        <!-- Coming Soon (PlotLines) -->
        <div id="coming-soon-box" class="lb-card">
          <h3>Coming Soon</h3>
          <div id="coming-soon-list" class="lb-list"></div>
        </div>

        <div id="books-feed" class="feed"></div>
      </section>

      <!-- ADD -->
      <section id="add" class="section">
        <div class="lb-card" style="margin-bottom:10px">
          <h3>Share a Recommendation</h3>

          <!-- media type + unified search -->
          <div class="search" style="grid-template-columns:1fr 1fr 1fr">
            <div>
              <label class="small">Type</label>
              <select id="media-type" class="select">
                <option value="book" selected>Book</option>
                <option value="podcast">Podcast</option>
              </select>
            </div>

            <div class="dropdown" style="position:relative">
              <label class="small">Search</label>
              <input id="book-search" class="input" type="text" placeholder="Search Google Books or Apple Podcasts‚Ä¶"/>
              <div id="book-results" class="users-pop" style="left:0;right:0;max-height:280px;overflow:auto"></div>
            </div>

            <div>
              <label class="small">Rating (click stars below)</label>
              <div class="stars" id="rating-stars" aria-label="rating stars">
                <button class="star" type="button" data-rating="1">‚òÖ</button>
                <button class="star" type="button" data-rating="2">‚òÖ</button>
                <button class="star" type="button" data-rating="3">‚òÖ</button>
                <button class="star" type="button" data-rating="4">‚òÖ</button>
                <button class="star" type="button" data-rating="5">‚òÖ</button>
              </div>
              <div id="rating-feedback" class="small">Click stars to rate (required)</div>
            </div>
          </div>

          <form id="book-form">
            <div class="search" style="grid-template-columns:1fr 1fr 1fr">
              <div><label class="small">Title *</label><input class="input" type="text" id="title" required/></div>
              <div><label class="small">Author/Host *</label><input class="input" type="text" id="author" required/></div>
              <div>
                <label class="small">Category</label>
                <select class="select" id="genre"></select>
              </div>
            </div>

            <!-- PlotLines: Series meta -->
            <div class="search" style="grid-template-columns:1fr 1fr 1fr">
              <div><label class="small">Series</label><input class="input" type="text" id="series-name" placeholder="Series name"/></div>
              <div><label class="small">Series #</label><input class="input" type="number" id="series-number" min="0" step="1" placeholder="e.g. 1"/></div>
              <div style="display:flex;align-items:flex-end"><label class="small" style="width:100%"><input id="watch-series" type="checkbox"/> Watch this series</label></div>
            </div>

            <div class="search" style="grid-template-columns:1fr 1fr">
              <div><label class="small">Your Name *</label><input class="input" type="text" id="recommender" required/></div>
              <div><label class="small">Cover Image (URL)</label><input class="input" type="url" id="book-image" placeholder="https://‚Ä¶"/></div>
            </div>

            <div><label class="small">Synopsis</label><textarea class="textarea" id="synopsis" placeholder="Description‚Ä¶"></textarea></div>

            <div>
              <label class="small">Why I recommend this * <span class="small" style="opacity:.8">(Choose a style below and click ‚ÄúSuggest Reason‚Äù to auto-generate text, then edit)</span></label>
              <div class="search" style="grid-template-columns:1fr auto">
                <select id="reason-tone" class="select" aria-label="Style for auto-generate">
                  <option value="personal">Style: Personal</option>
                  <option value="hook">Style: Hook/Catchy</option>
                  <option value="professional">Style: Professional</option>
                  <option value="concise">Style: Concise</option>
                </select>
                <button id="reason-suggest" type="button" class="nav-btn" title="Auto-generate reason text">Suggest Reason (auto)</button>
              </div>
              <textarea class="textarea" id="reason" placeholder="Your reason (you can auto-generate above)"></textarea>
            </div>

            <div>
              <label class="small">Tags</label>
              <div class="tags-input-container" id="tags-container" style="border:2px solid var(--line);border-radius:8px;padding:6px;background:#fffefb">
                <div id="tags-display" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px"></div>
                <input type="text" class="input" id="tag-input" placeholder="Add tags‚Ä¶" enterkeyhint="done" autocomplete="off" style="border:0;padding:6px;background:transparent"/>
                <div class="users-pop" id="tag-suggestions" style="display:none"></div>
              </div>
            </div>

            <div style="height:6px"></div>
            <button type="submit" class="nav-btn">Share</button>
          </form>
        </div>
      </section>

      <!-- MY LISTS -->
      <section id="my-books" class="section">
        <h3 style="margin-bottom:8px">My Reading Lists</h3>
        <div class="lb-card" style="margin-bottom:8px">
          <h4>Want to Read</h4>
          <div id="wish-list"></div>
        </div>
        <div class="lb-card" style="margin-bottom:8px">
          <h4>Currently Reading</h4>
          <div id="current-reading"></div>
        </div>
        <div class="lb-card">
          <h4>Read</h4>
          <div id="read-list"></div>
        </div>
      </section>

      <!-- PREFS -->
      <section id="prefs" class="section">
        <h2 style="margin-bottom:8px;color:var(--ink);font-size:1.1rem">Preferences</h2>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Posting & Feed</h3>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <label><input id="pref-post-new" type="checkbox" checked/> Post on <strong>new</strong></label>
            <label><input id="pref-post-finish" type="checkbox" checked/> Post when someone <strong>finishes</strong></label>
            <label><input id="pref-post-5" type="checkbox" checked/> Post for <strong>new 5‚òÖ ratings</strong></label>
            <button id="prefs-save" class="nav-btn" type="button">Save</button>
          </div>
        </div>

        <!-- PlotLines: Cloud Sync -->
        <div class="lb-card" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Cloud Sync (JSONBin)</h3>
            <span id="cloud-status" class="chip">Default bin</span>
          </div>
          <div class="search" style="grid-template-columns:1fr 1fr auto auto">
            <input id="cloud-api-key" class="input" placeholder="X-Master-Key (optional)"/>
            <input id="cloud-bin-id" class="input" placeholder="Bin ID (optional)"/>
            <button id="cloud-save" class="nav-btn" type="button">Save Config</button>
            <button id="cloud-clear" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="cloud-create" class="nav-btn" type="button">Create New Bin</button>
            <button id="cloud-pull" class="nav-btn" type="button">Pull</button>
            <button id="cloud-push" class="nav-btn" type="button">Push</button>
          </div>
        </div>

        <!-- PlotLines: Watched Series -->
        <div class="lb-card" style="margin-bottom:10px">
          <h3>Watched Series</h3>
          <div id="watched-series-list" class="lb-list"></div>
        </div>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Install on Your Phone</h3>
          <p class="small">Add Book Club to your home screen so it opens like an app.</p>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="install-app-btn" class="nav-btn" type="button">Install App</button>
            <span id="install-status" class="chip">Not installed</span>
          </div>
          <details id="ios-steps" style="margin-top:6px">
            <summary>iPhone / iPad steps</summary>
            <ol style="margin:6px 0 0 18px">
              <li>Open this page in <strong>Safari</strong>.</li>
              <li>Tap <strong>Share</strong> ‚Üí <strong>Add to Home Screen</strong>.</li>
              <li>Tap <strong>Add</strong>.</li>
            </ol>
            <p class="small">On iOS Chrome: Share ‚Üí ‚ÄúAdd to Home Screen‚Äù.</p>
          </details>
        </div>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Writing Assistant</h3>
          <p class="small">Use built-in suggestions, or paste an OpenAI API key to upgrade results. The key is stored only on this device.</p>
          <div class="search" style="grid-template-columns:1fr auto auto">
            <input id="openai-key" class="input" placeholder="sk-‚Ä¶ (optional)"/>
            <button id="save-openai-key" class="nav-btn" type="button">Save Key</button>
            <button id="clear-openai-key" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear</button>
          </div>
        </div>

        <div class="lb-card" style="margin-bottom:10px">
          <h3>Export / Backup</h3>
          <p class="small">Downloads Excel-friendly CSV + JSON (includes Wellness flag).</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="export-csv-btn" class="nav-btn" type="button">Download CSVs</button>
            <button id="export-json-btn" class="nav-btn" type="button">Download JSON</button>
            <label class="nav-btn" style="cursor:pointer"> Import JSON<input type="file" id="import-json" accept="application/json" style="display:none"> </label>
          </div>
        </div>

        <!-- Keep your original Admin Options BUT add a link to separate admin page -->
        <div class="lb-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Admin Options</h3>
            <div style="display:flex;gap:6px;align-items:center">
              <button id="open-admin-page" class="pill-btn" type="button" title="Opens separate admin page">Open Admin Page</button>
              <button id="toggle-danger" class="pill-btn" type="button">Open Admin Options</button>
            </div>
          </div>
          <div id="data-management" style="display:none;margin-top:8px">
            <div style="display:grid;gap:8px">
              <button id="clear-data-btn" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear ALL Data</button>
              <div class="search" style="grid-template-columns:1fr 1fr auto">
                <input id="rename-from" class="input" placeholder="Rename / merge: From name">
                <input id="rename-to" class="input" placeholder="To name">
                <button id="rename-user-btn" class="nav-btn" type="button">Rename / Merge</button>
              </div>
              <div class="search" style="grid-template-columns:1fr auto">
                <input id="delete-book-id" class="input" placeholder="Delete item by ID">
                <button id="delete-book-btn" class="nav-btn" type="button">Delete Item</button>
              </div>
              <div class="search" style="grid-template-columns:1fr auto auto">
                <input id="activity-days" class="input" placeholder="Purge activity older than N days (current tab)">
                <button id="purge-activity-btn" class="nav-btn" type="button">Purge Activity</button>
                <button id="delete-last-activity-btn" class="nav-btn" type="button">Delete Most Recent Activity</button>
              </div>
              <div class="search" style="grid-template-columns:1fr auto">
                <input id="pref-teams-url" class="input" type="url" placeholder="Teams Incoming Webhook URL"/>
                <button id="save-teams-btn" class="nav-btn" type="button">Save Teams URL</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>
</div>

<!-- Separate Admin Page (not a main tab) -->
<section id="admin-page" class="section" style="display:none;max-width:1100px;margin:12px auto">
  <div class="content">
    <div class="lb-card" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Admin</h2>
        <button id="admin-back" class="pill-btn" type="button">‚Üê Back</button>
      </div>
    </div>

    <div class="lb-card" style="margin-bottom:10px">
      <h3>Data Management</h3>
      <div style="display:grid;gap:8px">
        <button id="a-clear-data-btn" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear ALL Data</button>
        <div class="search" style="grid-template-columns:1fr 1fr auto">
          <input id="a-rename-from" class="input" placeholder="Rename / merge: From name">
          <input id="a-rename-to" class="input" placeholder="To name">
          <button id="a-rename-user-btn" class="nav-btn" type="button">Rename / Merge</button>
        </div>
        <div class="search" style="grid-template-columns:1fr auto">
          <input id="a-delete-book-id" class="input" placeholder="Delete item by ID">
          <button id="a-delete-book-btn" class="nav-btn" type="button">Delete Item</button>
        </div>
        <div class="search" style="grid-template-columns:1fr auto auto">
          <input id="a-activity-days" class="input" placeholder="Purge activity older than N days (current tab)">
          <button id="a-purge-activity-btn" class="nav-btn" type="button">Purge Activity</button>
          <button id="a-delete-last-activity-btn" class="nav-btn" type="button">Delete Most Recent Activity</button>
        </div>
        <div class="search" style="grid-template-columns:1fr auto">
          <input id="a-pref-teams-url" class="input" type="url" placeholder="Teams Incoming Webhook URL"/>
          <button id="a-save-teams-btn" class="nav-btn" type="button">Save Teams URL</button>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast"></div>

<!-- rating modal -->
<div id="finish-modal" class="toast" style="left:50%;transform:translate(-50%,0);bottom:auto;top:20%;max-width:520px">
  <div>
    <h3 id="finish-heading" style="margin-bottom:6px">Rate this item</h3>
    <p id="finish-title" class="small" style="margin-bottom:6px"></p>
    <div class="stars" id="finish-stars" style="margin:6px 0 4px">
      <button class="star" data-rating="1" type="button">‚òÖ</button>
      <button class="star" data-rating="2" type="button">‚òÖ</button>
      <button class="star" data-rating="3" type="button">‚òÖ</button>
      <button class="star" data-rating="4" type="button">‚òÖ</button>
      <button class="star" data-rating="5" type="button">‚òÖ</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
      <button class="nav-btn" id="finish-save" type="button">Save</button>
      <button class="nav-btn" id="finish-cancel" type="button" style="background:#b74a4a;border-color:#5c1f1f">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===== Helpers with old-browser safety ===== */
function rAll(str, search, replacement){ return String(str).split(search).join(replacement); }
function escapeHtml(s){ s=String(s==null?'':s); s=rAll(s,'&','&amp;'); s=rAll(s,'<','&lt;'); s=rAll(s,'>','&gt;'); return s; }
function escapeAttr(s){ return rAll(escapeHtml(s),'"','&quot;'); }

/* ========= JSONBin Storage & State ========= */
/* Default (baked-in). Cloud Sync in Prefs can override these at runtime. */
const JSONBIN_API = 'https://api.jsonbin.io/v3';
const DEFAULT_BIN_ID = '68b8be9e43b1c97be935f1da';
const DEFAULT_API_KEY = '$2a$10$1k.Aw1WU5YTjSlKmSLGQ3eK6gaEhRB/j.FzTEtMp7Ardqd7vI4i4C';
const ADMIN_PASSWORD = 'Prob1234';

let currentUser='';
let books=[];                 // Fun books (primary)
let wellnessBooks=[];         // Wellness items
let comingSoon=[];            // upcoming from watched series (fun)
let wellnessComingSoon=[];    // upcoming from watched series (wellness)
let userData={};
let activity=[];              // Fun activity
let wellnessActivity=[];      // Wellness activity
let sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true,openaiKey:'',
               cloudApiKey:'',cloudBinId:'', watchedSeries:[]};

let isLoading=false;
let currentTags = [];
let currentRating=0;
let finishContext=null;
let activityExpanded=false;
let lastSearchItems=[];
let deferredPrompt=null;

/* Scope handling */
let currentScope='main'; // 'main' or 'wellness'
function BOOKS(){ return currentScope==='main' ? books : wellnessBooks; }
function ACTIV(){ return currentScope==='main' ? activity : wellnessActivity; }
function UPCOMING(){ return currentScope==='main' ? comingSoon : wellnessComingSoon; }
function OTHER_BOOKS(){ return currentScope==='main' ? wellnessBooks : books; } // used by cross-lookup

/* ========= Utilities ========= */
var $ = function(sel, root){ return (root||document).querySelector(sel); };
var $$ = function(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); };
var now=function(){ return new Date().toISOString(); };
var timeAgo=function(iso){
  var d=new Date(iso); var s=(Date.now()-d)/1000;
  if(s<60)return String(Math.floor(s))+'s';
  var m=s/60; if(m<60)return String(Math.floor(m))+'m';
  var h=m/60; if(h<24)return String(Math.floor(h))+'h';
  return String(Math.floor(h/24))+'d';
};
var truncate=function(s,n){ s=String(s||''); n=n||300; return s.length>n? s.slice(0,n-1)+'‚Ä¶' : s; };
var setLoading=function(el,loading){
  if(!el)return; el.classList.toggle('loading',!!loading);
  var sp=el.querySelector && el.querySelector('.spinner');
  if(loading && !sp){ var span=document.createElement('span'); span.className='spinner'; el.prepend(span); }
  else if(!loading && sp){ sp.parentNode && sp.parentNode.removeChild(sp); }
};
var showToast=function(msg,isError){
  var t=$('#toast'); t.textContent=msg; t.classList.toggle('error',!!isError); t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t=setTimeout(function(){ t.classList.remove('show'); }, isError?3200:1800);
};
var formatDate=function(v){ var n=Number(v); var d=new Date(isFinite(n)?n:v); return d.toLocaleDateString(); };

/* ========= Local & Remote ========= */
function effectiveApiKey(){ return (sitePrefs.cloudApiKey||'').trim() || DEFAULT_API_KEY; }
function effectiveBin(){ return (sitePrefs.cloudBinId||'').trim() || DEFAULT_BIN_ID; }

async function loadAll(){
  if(isLoading) return; isLoading = true;
  try{ // local cache
    var cached = JSON.parse(localStorage.getItem('bookclub_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.wellnessBooks) wellnessBooks = cached.wellnessBooks;
    if(cached.userData) userData = cached.userData;
    if(cached.activity) activity = cached.activity;
    if(cached.wellnessActivity) wellnessActivity = cached.wellnessActivity;
    if(cached.sitePrefs) for(var k in cached.sitePrefs){ sitePrefs[k]=cached.sitePrefs[k]; }
    if(cached.comingSoon) comingSoon=cached.comingSoon;
    if(cached.wellnessComingSoon) wellnessComingSoon=cached.wellnessComingSoon;
  }catch(_e){}

  try{ // remote (effective bin / key)
    const r = await fetch(JSONBIN_API+'/b/'+effectiveBin()+'/latest',{headers:{'X-Master-Key':effectiveApiKey()}});
    if(!r.ok) throw new Error(await r.text());
    const data=await r.json();
    const record=data.record||{};
    books=record.books||books||[];
    wellnessBooks=record.wellnessBooks||wellnessBooks||[];
    userData=record.userData||userData||{};
    activity=record.activity||activity||[];
    wellnessActivity=record.wellnessActivity||wellnessActivity||[];
    comingSoon=record.comingSoon||comingSoon||[];
    wellnessComingSoon=record.wellnessComingSoon||wellnessComingSoon||[];
    for(var k2 in (record.sitePrefs||{})){ sitePrefs[k2]=record.sitePrefs[k2]; }
    localStorage.setItem('bookclub_payload', JSON.stringify({books,wellnessBooks,userData,activity,wellnessActivity,sitePrefs,comingSoon,wellnessComingSoon}));
  }catch(e){
    console.warn('Using local data; sync failed.', e);
  }
  isLoading=false;
}
async function saveAll(pushToCloud){
  try{
    localStorage.setItem('bookclub_payload', JSON.stringify({books,wellnessBooks,userData,activity,wellnessActivity,sitePrefs,comingSoon,wellnessComingSoon}));
  }catch(_e){}
  try{
    if(pushToCloud===false) return;
    const payload={books,wellnessBooks,userData,activity,wellnessActivity,sitePrefs,comingSoon,wellnessComingSoon};
    await fetch(JSONBIN_API+'/b/'+effectiveBin(),{ method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':effectiveApiKey()}, body:JSON.stringify(payload) });
  }catch(e){ console.warn('Remote save failed',e); }
}
function defaultUser(){ return {readList:[],wishList:[],currentReading:[]}; }
function ensureUser(name){ if(!userData[name]) userData[name]=defaultUser(); }
function me(){ return userData[currentUser]||defaultUser(); }

/* ========= PWA ========= */
function setupPWA(){
  try{
    const manifest={name:"Book Club",short_name:"Book Club",start_url:".",display:"standalone",background_color:"#ffffff",theme_color:"#2f4a3e",icons:[{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABQFZ1hAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE=",sizes:"192x192",type:"image/png"}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const url=URL.createObjectURL(blob);
    const link=$('#app-manifest'); if(link) link.href=url;
    if('serviceWorker' in navigator && (location.protocol==='https:' || location.hostname==='localhost')){
      const sw="self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('bc-v1').then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))})";
      const swUrl=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
      navigator.serviceWorker.register(swUrl).catch(function(){});
    }
    const status=$('#install-status');
    const standalone=window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true;
    if(status) status.textContent=standalone?'Installed':'Not installed';
    window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredPrompt=e; if(status) status.textContent='Install available';});
  }catch(_e){}
}

/* ========= Teams ========= */
async function postToTeams(type,text){
  const url=(sitePrefs.teamsWebhook||'').trim(); if(!url) return;
  const allow=(type==='share'&&sitePrefs.postNew)||(type==='finish'&&sitePrefs.postFinish)||(type==='five'&&sitePrefs.postFive);
  if(!allow) return;
  try{ await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}); }catch(_e){}
}

/* ========= Activity ========= */
function mergeOrPostActivity(entry){
  var arr = ACTIV();
  var last=arr[0];
  if(last && last.payload && entry.payload && last.payload.user===entry.payload.user && last.payload.title===entry.payload.title && (Date.now()-new Date(last.at).getTime())<120000){
    last.type='multi';
    var acts = (last.payload.actions||[]).concat([entry.type]);
    var dedup = {};
    last.payload.actions = acts.filter(function(x){ if(dedup[x])return false; dedup[x]=1; return true; });
    if(typeof entry.payload.rating!=='undefined'){ last.payload.rating = entry.payload.rating; }
    last.at=now();
  }else{
    arr.unshift({type:entry.type,payload:entry.payload,id:Date.now()+Math.random(),likes:0,likedBy:[],at:now()});
    if(arr.length>300) arr.length=300;
  }
  renderActivity(); saveAll();
}
function postActivity(type,payload){ mergeOrPostActivity({type:type,payload:payload}); }
function activityIcon(type){ var map={share:'üì£',finish:'üèÅ','five':'üèÜ','list':'üóÇÔ∏è','like':'üëç',comment:'üí¨',multi:'‚ú®'}; return map[type]||'üìù'; }

/* ========= Ratings ========= */
function ratingCount(book){
  var base = typeof book.rating === 'number' ? 1 : 0;
  var extra = (book.userRatings && book.userRatings.length) || 0;
  return base + extra;
}
function averageRatingForBook(book){
  var vals=[]; if(typeof book.rating==='number') vals.push(book.rating);
  (book.userRatings||[]).forEach(function(r){ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0;
  return vals.reduce(function(a,b){return a+b;},0)/vals.length;
}

/* ========= Tags ========= */
var tagSuggestions = [
 'sci-fi','fantasy','romance','mystery','thriller','horror','historical-fiction',
 'young-adult','contemporary','classic','literary-fiction','dystopian',
 'leadership','business','productivity','entrepreneurship','marketing',
 'personal-development','psychology','philosophy','history','science',
 'technology','health','fitness','cooking','travel','memoir',
 'comedy','drama','adventure','coming-of-age','family',
 'friendship','war','politics','economics','environment','social-justice',
 'quick-read','page-turner','thought-provoking','emotional','inspiring',
 'educational','practical','reference','beginner-friendly','advanced',
 'true-crime','faith','christian','catholic','prayer','neuroscience','time-travel','space','post-apocalyptic','podcast'
];
function renderTagsDisplay(){
  var c=$('#tags-display');
  c.innerHTML=currentTags.map(function(t){return '<span class="tag" data-tag="'+escapeAttr(t)+'">'+escapeHtml(t)+' √ó</span>';}).join('');
}
function addTag(t){
  var x=(t||'').trim().toLowerCase(); if(!x||currentTags.indexOf(x)>-1) return;
  currentTags.push(x); renderTagsDisplay();
  var ti=$('#tag-input'); if(ti) ti.value='';
  var sug=$('#tag-suggestions'); if(sug) sug.style.display='none';
}
function autoTagsFrom(book){
  var list=new Set(book.categories||[]);
  var s=String(book.synopsis||'').toLowerCase();
  var map = [
    [/science[\s-]?fiction|spaceship|space\s|alien|astrophysics/,'sci-fi'],
    [/fantasy|dragon|magic|sorcer|wizard|fae/,'fantasy'],
    [/mystery|detective|whodunnit|whodunit|sleuth/,'mystery'],
    [/thriller|conspiracy|chase|assassin/,'thriller'],
    [/romance|love\sstory|enemies to lovers/,'romance'],
    [/horror|haunted|possession|demon|ghost/,'horror'],
    [/young adult|ya\b/,'young-adult'],
    [/dystopian|post[-\s]?apocalyptic|apocalypse/,'dystopian'],
    [/time[-\s]?travel/,'time-travel'],
    [/space|cosmos/,'space'],
    [/history|historical/,'history'],
    [/memoir|autobiograph/,'memoir'],
    [/true\s?crime/,'true-crime'],
    [/leadership|manager|team/,'leadership'],
    [/business|startup|founder|marketing|sales/,'business'],
    [/productivity|habits|workflow|time management/,'productivity'],
    [/psychology|behavior|cognitive|neuroscience/,'psychology'],
    [/neuroscience/,'neuroscience'],
    [/philosophy|ethic|stoic/,'philosophy'],
    [/faith|prayer|catholic|christian|saint/,'faith'],
    [/podcast/,'podcast'],
    [/health|fitness|resilience|wellness|sleep|stress/,'health']
  ];
  map.forEach(function(pair){ if(pair[0].test(s)) list.add(pair[1]); });
  if(book.genre) list.add(book.genre);
  currentTags=Array.from(new Set(currentTags.concat(Array.from(list).map(function(x){return String(x).toLowerCase();})))).slice(0,8);
  renderTagsDisplay();
}

/* ========= PlotLines: Series Helpers ========= */
function watchSeriesName(name){
  name=String(name||'').trim(); if(!name) return;
  if(sitePrefs.watchedSeries.indexOf(name)===-1){ sitePrefs.watchedSeries.push(name); saveAll(); renderWatchedSeries(); showToast('Watching series: '+name); }
}
function unwatchSeriesName(name){
  sitePrefs.watchedSeries = sitePrefs.watchedSeries.filter(function(x){ return x!==name; });
  saveAll(); renderWatchedSeries(); showToast('Removed: '+name);
}
function renderWatchedSeries(){
  var list=$('#watched-series-list');
  var items=sitePrefs.watchedSeries||[];
  if(!items.length){ list.innerHTML='<div class="small" style="color:#2b3832">Nothing yet ‚Äî watch a series from a card or the Add form.</div>'; return; }
  list.innerHTML=items.map(function(n){
    return '<div class="lb-row"><div>'+escapeHtml(n)+'</div><button class="pill-btn" type="button" data-unwatch="'+escapeAttr(n)+'">Remove</button></div>';
  }).join('');
}

/* ========= Rendering ========= */
function goodreadsUrl(book){
  var q = ((book.title||'')+' '+(book.author||'')).trim();
  return 'https://www.goodreads.com/search?q='+encodeURIComponent(q)+'&search_type=books';
}
function mediaUrl(book){
  if(book.type==='podcast'){
    if(book.podcastUrl) return book.podcastUrl;
    var q=((book.title||'')+' '+(book.author||'')).trim();
    return 'https://podcasts.apple.com/search?term='+encodeURIComponent(q);
  }
  return goodreadsUrl(book);
}
function bookCoverBlock(book){
  var link = mediaUrl(book);
  if(book.image){
    return '<a href="'+escapeAttr(link)+'" target="_blank" rel="noopener noreferrer"><img class="cover" loading="lazy" alt="Cover of '+escapeHtml(book.title)+'" src="'+escapeAttr(book.image)+'"/></a>';
  }
  return '<a href="'+escapeAttr(link)+'" target="_blank" rel="noopener noreferrer" class="cover-ph">'+(book.type==='podcast'?'Podcast':'No Cover')+'</a>';
}
function youStatus(book){
  if(!currentUser) return '';
  var mine=me();
  var r=mine.readList.find(function(x){return String(x.id)===String(book.id);});
  var cr=mine.currentReading.find(function(x){return String(x.id)===String(book.id);});
  var w=mine.wishList.find(function(x){return String(x.id)===String(book.id);});
  function chip(b){ return b && b._wellness ? ' <span class="chip">Wellness</span>' : ''; }
  if(r){
    var urObj=(book.userRatings||[]).find(function(x){return x.user===currentUser;});
    var stars= (urObj?urObj.rating:undefined);
    if(stars==null) stars = (r._rating||0);
    return '<div class="status-pill">‚úÖ Completed'+(stars?(' ‚Äî '+stars+'‚òÖ'):'')+chip(r)+'</div>';
  }
  if(cr) return '<div class="status-pill">üìñ Currently Reading'+chip(cr)+'</div>';
  if(w)  return '<div class="status-pill">üìö Want to Read'+chip(w)+'</div>';
  return '';
}
function myTimeline(book){
  if(!currentUser) return '';
  var m=me();
  var info = {started: null, finished: null};
  var r=m.readList.find(function(x){return String(x.id)===String(book.id);});
  var c=m.currentReading.find(function(x){return String(x.id)===String(book.id);});
  if(r){ info.finished = r._finishedAt || r._changedAt || null; }
  if(c){ info.started = c._startedAt || c._changedAt || null; }
  var bits=['<div class="timeline">'];
  bits.push('<span class="tl">Added '+formatDate(book.id)+'</span>');
  if(info.started) bits.push('<span class="tl">Started '+formatDate(info.started)+'</span>');
  if(info.finished) bits.push('<span class="tl">Finished '+formatDate(info.finished)+'</span>');
  bits.push('</div>');
  return bits.join('');
}
function likedByLine(arr){ arr=arr||[]; if(!arr.length) return ''; return '<div class="small"><em>Liked by:</em> '+escapeHtml(arr.join(', '))+'</div>'; }
function tagChips(tags){ if(!tags||!tags.length) return ''; return '<div class="tags">'+tags.map(function(t){return '<span class="tag">'+escapeHtml(t)+'</span>';}).join('')+'</div>'; }
function seriesChip(book){
  if(!book.seriesName) return '';
  var n = escapeHtml(book.seriesName);
  var num = (book.seriesNumber!=null && book.seriesNumber!=='') ? ' #'+escapeHtml(book.seriesNumber) : '';
  return '<span class="series-chip">Series: '+n+num+'</span>';
}
function synBlock(book){
  if(!book.synopsis) return '';
  if($('#hide-synopses') && $('#hide-synopses').checked) return '';
  var long = book.synopsis.length>280;
  var short = truncate(book.synopsis, 280);
  return [
    '<div class="syn" data-syn="'+book.id+'">',
    '<span class="syn-text" data-expanded="false">'+escapeHtml(short)+'</span>',
    long?(' <button class="c-toggle" type="button" data-action="toggle-synopsis" data-id="'+book.id+'" data-full="'+escapeAttr(book.synopsis)+'">Read more</button>'):'',
    '</div>'
  ].join('');
}
function typePill(book){
  if(book.type==='podcast') return 'üéß Podcast'+(book.genre?': '+escapeHtml(book.genre):'');
  return escapeHtml(book.genre||'');
}
function bookCard(book){
  var liked=currentUser && (book.postLikedBy||[]).indexOf(currentUser)>-1;
  var avg=averageRatingForBook(book);
  var rounded=Math.round(avg||0);
  var count=ratingCount(book);
  var sysCollapsed = ($('#collapse-all') && $('#collapse-all').checked) ? 'style="display:none"' : '';
  var mineRead = currentUser && me().readList.some(function(x){return String(x.id)===String(book.id);});
  return [
    '<article class="post" id="book-'+book.id+'" data-id="'+book.id+'">',
      '<div class="head">', bookCoverBlock(book), '<div class="info">',
        '<div class="genre">'+ typePill(book) + seriesChip(book) +'</div>',
        '<div class="title">'+escapeHtml(book.title)+'</div>',
        '<div class="author">by '+escapeHtml(book.author)+'</div>',
        '<div class="recommender">Recommended by '+escapeHtml(book.recommender)+'</div>',
        '<div class="small" style="color:#20362c">Recommended on '+formatDate(book.id)+(book._scope==='wellness'?' ‚Ä¢ <span class="chip">Wellness</span>':'')+'</div>',
        '<div class="rating-line">',
          '<div class="stars">'+Array(rounded+1).join('‚òÖ')+Array(5-rounded+1).join('‚òÜ')+'</div>',
          '<span class="small">('+avg.toFixed(1)+'/5 ‚Ä¢ '+count+' rating'+(count===1?'':'s')+')</span>',
        '</div>',
        tagChips(book.tags), youStatus(book), myTimeline(book),
      '</div></div>',
      synBlock(book),
      (book.reason?('<div class="why"><div class="reason-title">Why '+escapeHtml(book.recommender)+' recommends it</div>'+escapeHtml(book.reason)+'</div>'):''),
      '<div class="actions">',
        '<button class="action '+(liked?'active':'')+'" type="button" data-action="like" data-id="'+book.id+'">üëç <span data-like-count>'+(book.postLikes||0)+'</span></button>',
        '<button class="action" type="button" data-action="wish" data-id="'+book.id+'">üìö Want to Read</button>',
        '<button class="action" type="button" data-action="reading" data-id="'+book.id+'">üìñ Currently Reading</button>',
        '<button class="action" type="button" data-action="'+(mineRead?'rate-again':'finish')+'" data-id="'+book.id+'">'+(mineRead?'‚≠ê Rate Again':'‚úÖ Mark as Read')+'</button>',
        '<button class="action" type="button" data-action="similar" data-id="'+book.id+'">üß≠ Find Similar</button>',
        '<button class="action" type="button" data-action="share" data-id="'+book.id+'">üîó Share</button>',
        (book.seriesName?'<button class="action" type="button" data-action="watch-series" data-ser="'+escapeAttr(book.seriesName)+'">üëÄ Watch Series</button>':'<button class="action" type="button" data-action="set-series" data-id="'+book.id+'">üîß Set Series</button>'),
        (book.seriesName?'<button class="action" type="button" data-action="add-series-books" data-ser="'+escapeAttr(book.seriesName)+'">‚ûï Add Series Books</button>':''),
      '</div>',
      likedByLine(book.postLikedBy),
      '<div class="comments">',
        '<div class="c-head">',
          '<span class="c-title">Comments <span class="small">(' + ((book.comments&&book.comments.length)||0) + ')</span></span>',
          '<button class="c-toggle" type="button" data-action="toggle-comments" data-id="'+book.id+'">See Comments</button>',
        '</div>',
        '<div class="c-list" '+sysCollapsed+' data-list="'+book.id+'">',
          ((book.comments||[]).map(function(c){
            return [
              '<div class="c-item" data-comment-id="'+c.id+'">',
                '<div class="c-headline">',
                  '<span class="c-name">'+escapeHtml(c.commenter||'Anonymous')+' <span class="small" style="color:#20362c;margin-left:6px">'+formatDate(c.id)+'</span></span>',
                  '<button class="c-like '+(((c.likedBy||[]).indexOf(currentUser)>-1)?'liked':'')+'" type="button" data-action="like-comment" data-id="'+book.id+'" data-cid="'+c.id+'">üëç '+(c.likes||0)+'</button>',
                '</div>',
                '<div class="c-text">'+escapeHtml(c.text||'')+'</div>',
              '</div>'
            ].join('');
          }).join('')),
          '<div class="c-form" data-id="'+book.id+'">',
            '<input type="text" class="c-input" data-field="name" value="'+escapeAttr(currentUser)+'" placeholder="Your name"/>',
            '<input type="text" class="c-textarea" data-field="text" placeholder="Write your comment‚Ä¶"/>',
            '<button class="c-btn" type="button" data-action="add-comment" data-id="'+book.id+'">Add Comment</button>',
          '</div>',
        '</div>',
      '</div>',
    '</article>'
  ].join('');
}

function renderActivity(){
  var list=$('#activity-list');
  var filter=$('#activity-filter').value;
  var cap=activityExpanded?40:12;
  var src=ACTIV();
  var filtered=filter?src.filter(function(a){return a.type===filter;}):src;
  if(!filtered.length){list.innerHTML='<div class="a-item"><div class="a-badge">üëã</div><div>No activity yet ‚Äî share something!</div></div>';return;}
  list.innerHTML=filtered.slice(0,cap).map(function(a){
    var type=a.type,payload=a.payload,at=a.at,likes=a.likes||0;
    var user = escapeHtml(payload.user);
    var title = '<em>'+escapeHtml(payload.title)+'</em>';
    var text='';
    if(type==='share') text='<strong>'+user+'</strong> shared '+title+' ('+(payload.rating||'‚Äî')+'‚òÖ)';
    else if(type==='finish') text='<strong>'+user+'</strong> finished '+title+' ‚Äî '+(payload.rating||'‚Äî')+'‚òÖ';
    else if(type==='five') text='<strong>'+user+'</strong> rated '+title+' <strong>5‚òÖ</strong>';
    else if(type==='list') text='<strong>'+user+'</strong> '+escapeHtml(payload.action)+' '+title;
    else if(type==='comment') text='<strong>'+user+'</strong> commented on '+title;
    else if(type==='like') text='<strong>'+user+'</strong> liked '+title;
    else if(type==='multi'){
      var acts = {}; (payload.actions||[]).forEach(function(x){acts[x]=1;});
      var rated = (typeof payload.rating!=='undefined');
      if(acts.share && (acts.finish || acts.five || rated)){ text = '<strong>'+user+'</strong> recommended '+title+' and rated it '+(payload.rating||5)+'‚òÖ'; }
      else if(acts.share){ text = '<strong>'+user+'</strong> recommended '+title; }
      else{ text = '<strong>'+user+'</strong> updated '+title; }
    }
    return '<div class="a-item"><div class="a-badge">'+activityIcon(type)+'</div><div><div>'+text+'</div><div class="a-meta">'+timeAgo(at)+' ago <span class="pill">'+likes+' üëç</span></div></div></div>';
  }).join('');
  $('#activity-toggle').textContent=activityExpanded?'Less':'More';
}

let currentBooks=[]; // rendered list for current scope
function renderBooks(){
  // coming soon
  renderComingSoon();
  // recs
  computeAndRenderRecs();

  var c=$('#books-feed');
  if(!currentBooks.length){
    c.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)"><h3 style="font-size:1rem;color:#2a3a33">No items found</h3><p class="small">Adjust search/filters or add a new recommendation.</p></div>';
    $('#result-count').textContent='0 results';return;
  }
  c.innerHTML=currentBooks.map(bookCard).join('');
  $('#result-count').textContent=String(currentBooks.length)+' result'+(currentBooks.length===1?'':'s');
}

function renderMyLists(){
  var data=me();
  function chip(b){ return b && b._wellness ? ' <span class="chip">Wellness</span>' : ''; }
  function make(arr,actions){
    return arr.length?arr.map(function(b){
      return '<div class="lb-row" data-id="'+b.id+'"><div><strong>'+escapeHtml(b.title)+'</strong> by '+escapeHtml(b.author)+chip(b)+'</div><div>'+actions(b)+'</div></div>';
    }).join(''):'<p class="small" style="font-style:italic">Nothing here yet</p>';
  }
  $('#current-reading').innerHTML=make(data.currentReading,function(b){
    return '<button class="pill-btn" type="button" data-action="finish" data-id="'+b.id+'">Mark Read</button> <button class="pill-btn" type="button" data-action="remove-current" data-id="'+b.id+'">Remove</button>';
  });
  $('#wish-list').innerHTML=make(data.wishList,function(b){
    return '<button class="pill-btn" type="button" data-action="reading" data-id="'+b.id+'">Start</button> <button class="pill-btn" type="button" data-action="remove-wish" data-id="'+b.id+'">Remove</button>';
  });
  $('#read-list').innerHTML=make(data.readList,function(b){
    return '<span class="chip">'+(b._rating||0)+'‚òÖ</span> <button class="pill-btn" type="button" data-action="rate-again" data-id="'+b.id+'">Rate Again</button> <button class="pill-btn" type="button" data-action="remove-read" data-id="'+b.id+'">Remove</button>';
  });
}

/* ========= Stats / Leaderboard / Trending ========= */
function updateStats(){
  var src=BOOKS();
  var sum=0,n=0;
  src.forEach(function(b){
    if(typeof b.rating==='number'){sum+=b.rating;n++;}
    (b.userRatings||[]).forEach(function(r){ if(typeof r.rating==='number'){sum+=r.rating;n++;} });
  });
  var totalItems=src.length;
  var totalComments=src.reduce(function(s,b){return s+(((b.comments&&b.comments.length)||0));},0);
  var globalAvg=n?(sum/n):0;
  var readCount=Object.keys(userData||{}).reduce(function(s,k){var u=userData[k]||{}; return s + ((u.readList&&u.readList.length)||0);},0);
  var usersCount=Object.keys(userData||{}).length;
  $('#total-books').textContent=String(totalItems);
  $('#total-reviews').textContent=String(totalComments);
  $('#avg-rating').textContent=globalAvg.toFixed(1);
  $('#books-read').textContent=String(readCount);
  $('#total-users').textContent=String(usersCount);
  var list=Object.keys(userData||{}).sort(function(a,b){return a.localeCompare(b);});
  $('#users-pop').innerHTML=list.map(function(nm){return '<div>'+escapeHtml(nm)+'</div>';}).join('');
  renderLB(); renderTrending(); populateTagFilter();
}
function renderLB(){
  var src=BOOKS();
  function notSystem(name){ return String(name||'').trim().toLowerCase()!=='system'; }
  function addRows(container,arr,unit,empty){
    if(!arr.length){container.innerHTML='<div class="small" style="color:#2b3832">'+empty+'</div>';return;}
    container.innerHTML=arr.map(function(item){ return '<div class="lb-row"><div>'+escapeHtml(item[0])+'</div><span class="lb-count">'+item[1]+' '+unit+'</span></div>'; }).join('');
  }
  var recs={}; src.forEach(function(b){var n=b.recommender; if(n) recs[n]=(recs[n]||0)+1;});
  var recsSorted=Object.keys(recs).filter(notSystem).map(function(k){return [k,recs[k]];}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
  addRows($('#lb-recommenders'),recsSorted, (recsSorted[0]&&recsSorted[0][1]===1)?'item':'items','No shares yet');

  var reads={}; Object.keys(userData||{}).forEach(function(n){ if(notSystem(n)) reads[n]=(userData[n].readList||[]).length; });
  var readsSorted=Object.keys(reads).filter(function(n){return reads[n]>0;}).map(function(n){return [n,reads[n]];}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
  addRows($('#lb-readers'),readsSorted,'finished','No finished items yet');

  var active={};
  Object.keys(userData||{}).forEach(function(n){
    if(notSystem(n)) active[n]=((userData[n].readList||[]).length)+((userData[n].currentReading||[]).length)+((userData[n].wishList||[]).length);
  });
  src.forEach(function(b){
    (b.comments||[]).forEach(function(c){ var n=c.commenter||'Anonymous'; if(notSystem(n)) active[n]=(active[n]||0)+1; });
    (b.postLikedBy||[]).forEach(function(n){ if(notSystem(n)) active[n]=(active[n]||0)+1; });
  });
  var actSorted=Object.keys(active).map(function(n){return [n,active[n]];}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
  addRows($('#lb-active'),actSorted,'actions','No activity yet');
}
function trendingScore(b){ var comments = (b.comments&&b.comments.length) || 0; var likes = b.postLikes || 0; var ratings = ratingCount(b); return comments*2 + likes*1.5 + ratings; }
function renderTrending(){
  var src=BOOKS();
  var top = src.slice().sort(function(a,b){return trendingScore(b)-trendingScore(a);}).slice(0,3);
  function makeRows(arr){
    if(!arr.length) return '<div class="small" style="color:#2b3832">No activity yet</div>';
    return arr.map(function(b){
      var img = b.image ? '<img src="'+escapeAttr(b.image)+'" alt="" style="width:28px;height:42px;border-radius:6px;border:1px solid #e6ece8;object-fit:cover">' : '<div style="width:28px;height:42px;border-radius:6px;background:#e9ecef"></div>';
      return '<div class="lb-row" data-jump="'+b.id+'"><div style="display:flex;align-items:center;gap:8px">'+img+'<div><div><strong>'+escapeHtml(b.title)+'</strong></div><div class="small" style="color:#20362c">'+escapeHtml(b.author)+'</div></div></div><span class="lb-count">'+Math.round(trendingScore(b))+' actions</span></div>';
    }).join('');
  }
  $('#trending-prelogin').innerHTML = makeRows(top);
}

/* ========= Search/Filter ========= */
function getUniqueRecommenders(){
  var set={}; BOOKS().forEach(function(b){ if(b.recommender) set[b.recommender]=1; }); return Object.keys(set).sort(function(a,b){return a.localeCompare(b);});
}
function populateRecommenderFilter(){
  var sel=$('#recommender-filter'); var cur=sel.value;
  var opts=['<option value="">All Recommenders</option>'].concat(getUniqueRecommenders().map(function(n){return '<option value="'+escapeAttr(n)+'">'+escapeHtml(n)+'</option>'; }));
  sel.innerHTML=opts.join(''); if(getUniqueRecommenders().indexOf(cur)>-1) sel.value=cur;
}
function populateCategoryOptions(){
  var opts=[ 'Fiction','Non-Fiction','Biography','Memoir','Self-Help','Professional','Business',
    'Leadership','Entrepreneurship','Marketing','Finance','Personal Development',
    'History','Science','Technology','Psychology','Philosophy','Spirituality/Religion',
    'Health & Fitness','Cooking','Travel','Parenting','Education',
    'Mystery','Thriller','Horror','Romance','Fantasy','Sci-Fi','Dystopian','Young Adult',
    'Classics','Literary Fiction','Poetry','Comics/Graphic Novel','Reference','Podcast','Other'
  ];
  $('#genre').innerHTML=opts.map(function(o){return '<option value="'+escapeAttr(o.toLowerCase())+'">'+escapeHtml(o)+'</option>';}).join('');
  var feedCat=$('#category-filter');
  feedCat.innerHTML=['<option value="">All Categories</option>'].concat(opts.map(function(o){return '<option value="'+escapeAttr(o.toLowerCase())+'">'+escapeHtml(o)+'</option>'; })).join('');
}
function getAllTagsUnique(){
  var set={}; BOOKS().forEach(function(b){ (b.tags||[]).forEach(function(t){ set[String(t).toLowerCase()]=1; }); }); return Object.keys(set).sort();
}
function populateTagFilter(){
  var sel=$('#tag-filter'); if(!sel) return; var cur=sel.value; var all=getAllTagsUnique();
  sel.innerHTML=['<option value="">All Tags</option>'].concat(all.map(function(t){return '<option value="'+escapeAttr(t)+'">'+escapeHtml(t)+'</option>'; })).join('');
  if(all.indexOf(cur)>-1) sel.value=cur;
}
function bookSearchScore(b,t){
  if(!t) return 1;
  var term=String(t).toLowerCase();
  function inStr(s){ return String(s||'').toLowerCase(); }
  var score=0;
  var title=inStr(b.title), author=inStr(b.author), rec=inStr(b.recommender), syn=inStr(b.synopsis), rea=inStr(b.reason);
  var tags=(b.tags||[]).map(function(x){return String(x).toLowerCase();});
  if(title===term) score+=100;
  if(title.indexOf(term)===0) score+=60;
  if(title.indexOf(term)>-1) score+=30;
  if(author.indexOf(term)===0) score+=30;
  if(author.indexOf(term)>-1) score+=20;
  if(rec.indexOf(term)>-1) score+=15;
  if(rea.indexOf(term)>-1) score+=12;
  if(syn.indexOf(term)>-1) score+=10;
  if(tags.some(function(x){return x.indexOf(term)>-1;})) score+=25;
  return score;
}
function applyFilters(){
  var term=$('#search-input').value.trim();
  var tagTerm=$('#tag-filter').value.trim().toLowerCase();
  var cat=$('#category-filter').value;
  var who=$('#recommender-filter').value;
  var min=parseInt($('#min-rating').value,10)||0;
  var sort=$('#sort-by').value;
  var src=BOOKS();
  var list=src
    .map(function(b){ var o={}; for(var k in b) o[k]=b[k]; o._score=bookSearchScore(b,term); return o; })
    .filter(function(b){
      if(term && b._score<=0) return false;
      if(cat && b.genre!==cat) return false;
      if(who && b.recommender!==who) return false;
      if(min && averageRatingForBook(b) < min) return false;
      if(tagTerm && (b.tags||[]).map(function(t){return String(t).toLowerCase();}).indexOf(tagTerm)===-1) return false;
      return true;
    });
  if(term){ list.sort(function(a,b){ return (b._score-a._score) || (b.id-a.id); }); }
  else if(sort==='new'){ list.sort(function(a,b){ return b.id-a.id; }); }
  else if(sort==='likes'){ list.sort(function(a,b){ return (b.postLikes||0)-(a.postLikes||0); }); }
  else if(sort==='rating'){ list.sort(function(a,b){ return averageRatingForBook(b)-averageRatingForBook(a); }); }
  else if(sort==='title'){ list.sort(function(a,b){ return a.title.localeCompare(b.title); }); }
  currentBooks=list; renderBooks();
}

/* ========= Google Books + Apple Podcasts Search ========= */
const searchGoogleBooks = async function(q){
  var box=$('#book-results'); var input=$('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; lastSearchItems=[]; return; }
  try{
    setLoading(input,true);
    const url='https://www.googleapis.com/books/v1/volumes?q='+encodeURIComponent(q.trim())+'&maxResults=10';
    const r=await fetch(url); if(!r.ok) throw new Error('Search failed '+r.status);
    const data=await r.json(); setLoading(input,false);
    lastSearchItems=(data.items||[]).map(function(it,i){
      var v=it.volumeInfo||{};
      return { index:i, type:'book',
        title:v.title||'Unknown Title',
        authors:(v.authors||[]).join(', ')||'Unknown Author',
        cover:(v.imageLinks&&v.imageLinks.thumbnail)||'',
        description:v.description||'',
        categories:v.categories||[],
        published:v.publishedDate||''
      };
    });
    renderSearchDropdown(lastSearchItems);
  }catch(e){
    setLoading(input,false); console.warn(e);
    box.innerHTML='<div class="small" style="padding:8px;color:#b74a4a">Search failed. Try again.</div>'; box.style.display='block';
  }
};
const searchApplePodcasts = async function(q){
  var box=$('#book-results'); var input=$('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; lastSearchItems=[]; return; }
  try{
    setLoading(input,true);
    const url='https://itunes.apple.com/search?term='+encodeURIComponent(q.trim())+'&entity=podcast&limit=10';
    const r=await fetch(url); if(!r.ok) throw new Error('Search failed '+r.status);
    const data=await r.json(); setLoading(input,false);
    lastSearchItems=(data.results||[]).map(function(it,i){
      return { index:i, type:'podcast',
        title:it.collectionName||'Unknown Podcast',
        authors:it.artistName||'Unknown Host',
        cover:it.artworkUrl100||'',
        description:'Podcast ‚Ä¢ '+(it.primaryGenreName||'General'),
        categories:[(it.primaryGenreName||'podcast')],
        podcastUrl:it.collectionViewUrl||''
      };
    });
    renderSearchDropdown(lastSearchItems);
  }catch(e){
    setLoading(input,false); console.warn(e);
    box.innerHTML='<div class="small" style="padding:8px;color:#b74a4a">Search failed. Try again.</div>'; box.style.display='block';
  }
};
function renderSearchDropdown(items){
  var box=$('#book-results');
  if(!items.length){ box.innerHTML='<div class="small" style="padding:8px">No results</div>'; box.style.display='block'; return; }
  box.innerHTML=items.map(function(r){
    var badge = r.type==='podcast' ? 'üéß' : 'üìö';
    return '<div class="lb-row" data-pick="'+r.index+'"><div style="display:flex;gap:8px;align-items:center">'+
      (r.cover?('<img src="'+escapeAttr(r.cover)+'" class="result-cover" style="width:24px;height:24px;border-radius:4px;border:1px solid #e6ece8;object-fit:cover">'):'<div style="width:24px;height:24px;border-radius:4px;background:#e9ecef"></div>')+
      '<div><strong>'+badge+' '+escapeHtml(r.title)+'</strong><div class="small">'+escapeHtml(r.authors)+'</div></div></div>'+
      ((r.categories&&r.categories.length)?('<span class="lb-count">'+escapeHtml(String(r.categories[0]))+'</span>'):'')+
      '</div>';
  }).join('');
  box.style.display='block';
}

/* ========= Export / Import ========= */
function download(name, text, mime){ mime = mime || 'text/csv;charset=utf-8;'; var blob=new Blob([text],{type:mime}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); }
function toCsvRow(arr){ function escCsvStr(s){ return String(s==null?'':s).replace(/"/g,'""'); } return arr.map(function(v){return '"'+escCsvStr(v)+'"';}).join(','); }
function exportCsvs(){
  var all = []
    .concat((books||[]).map(function(b){ var c=Object.assign({},b); c._scope='fun'; return c; }))
    .concat((wellnessBooks||[]).map(function(b){ var c=Object.assign({},b); c._scope='wellness'; return c; }));
  var header = toCsvRow(['id','title','author','type','genre','recommender','image','avg_rating','ratings_count','tags','synopsis','reason','scope','series','series_number']);
  var rows = all.map(function(b){ return toCsvRow([b.id,b.title,b.author,b.type||'book',b.genre,b.recommender,b.image||'',averageRatingForBook(b).toFixed(2),ratingCount(b),(b.tags||[]).join('|'),(b.synopsis||''),(b.reason||''),b._scope||'',b.seriesName||'',b.seriesNumber||'']);});
  download('items.csv',[header].concat(rows).join('\n'));
  var commentsHeader = toCsvRow(['book_id','book_title','comment_id','commenter','likes','text','system','scope']);
  var commentsRows = all.reduce(function(acc,b){ return acc.concat((b.comments||[]).map(function(c){return toCsvRow([b.id,b.title,c.id,c.commenter||'',c.likes||0,c.text||'',c.system?1:0,b._scope||'']);})); },[]);
  download('comments.csv',[commentsHeader].concat(commentsRows).join('\n'));
}
function exportJson(){ download('bookclub-export.json',JSON.stringify({books,wellnessBooks,userData,activity,wellnessActivity,sitePrefs,comingSoon,wellnessComingSoon},null,2),'application/json'); }
function importJson(file){
  var fr=new FileReader();
  fr.onload=function(){
    try{
      var data=JSON.parse(fr.result);
      if(data.books) books=data.books;
      if(data.wellnessBooks) wellnessBooks=data.wellnessBooks;
      if(data.userData) userData=data.userData;
      if(data.activity) activity=data.activity;
      if(data.wellnessActivity) wellnessActivity=data.wellnessActivity;
      if(data.sitePrefs) for(var k in data.sitePrefs){ sitePrefs[k]=data.sitePrefs[k]; }
      if(data.comingSoon) comingSoon=data.comingSoon;
      if(data.wellnessComingSoon) wellnessComingSoon=data.wellnessComingSoon;
      saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats(); renderWatchedSeries(); showToast('Import complete');
    }catch(e){ showToast('Invalid JSON',true); }
  };
  fr.readAsText(file);
}

/* ========= Modal ========= */
function openFinishModal(book){
  finishContext = {bookId: book.id};
  var urObj = (book.userRatings||[]).find(function(r){return r.user===currentUser;});
  var mineEntry = me().readList.find(function(x){return String(x.id) === String(book.id);});
  currentRating = (urObj?urObj.rating:undefined);
  if(currentRating==null) currentRating = (mineEntry && mineEntry._rating) || 0;
  $('#finish-title').textContent = book.title+' ‚Äî '+book.author;
  $$('#finish-stars .star').forEach(function(star){ var val=Number(star.getAttribute('data-rating')); star.classList.toggle('filled', val<=currentRating); });
  $('#finish-modal').classList.add('show');
}
function closeFinishModal(){ $('#finish-modal').classList.remove('show'); finishContext=null; }

/* ========= Writing assistant ========= */
function localReason(o){
  var title=o.title, author=o.author, genre=o.genre, synopsis=o.synopsis, tone=o.tone, tags=o.tags;
  var bits=[], clean=function(s){ return String(s||'').replace(/\s+/g,' ').trim(); };
  var s=clean(synopsis); var hook = s ? s.split(/(?<=[.!?])\s+/).slice(0,1).join(' ') : '';
  if(tone==='hook'){ bits.push('Quick rec: '+title+' is a '+genre+' that grabs you fast and doesn‚Äôt let go.'); }
  else if(tone==='professional'){ bits.push(title+' distills '+genre+' ideas into clear, practical takeaways.'); }
  else if(tone==='concise'){ bits.push(title+' is a sharp '+genre+' that‚Äôs worth your time.'); }
  else { bits.push('I loved how '+title+' by '+author+' blends '+genre+' themes into something memorable.'); }
  if(hook) bits.push(hook);
  if(tags) bits.push('Great for fans of '+tags+'.');
  return clean(bits.join(' '));
}
async function suggestReason(tone){
  var title=$('#title').value.trim(), author=$('#author').value.trim();
  var genre=$('#genre').value, synopsis=$('#synopsis').value.trim();
  var tags=(currentTags||[]).slice(0,6).join(', ');
  var fallback = localReason({title:title,author:author,genre:genre,synopsis:synopsis,tone:tone,tags:tags});
  var key=(sitePrefs.openaiKey||'').trim(); if(!key) return fallback;
  try{
    const prompt='Write a '+tone+' 2-3 sentence recommendation for "'+title+'" by '+author+'. Category '+genre+'. Tags: '+(tags||'‚Äî')+'. Use ~80 words. No spoilers. Avoid slang.';
    const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:prompt}],temperature:0.7,max_tokens:180})});
    if(!r.ok) throw new Error(await r.text());
    const j=await r.json();
    return (j && j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content && j.choices[0].message.content.trim()) || fallback;
  }catch(e){ console.warn(e); return fallback; }
}

/* ========= Recs & Coming Soon ========= */
function computeAndRenderRecs(){
  var recsWrap=$('#recs'); var row=$('#recs-row');
  if(!currentUser){ recsWrap.classList.remove('show'); row.innerHTML=''; return; }
  var mine=me();
  var haveIds={}; [].concat(mine.readList,mine.wishList,mine.currentReading).forEach(function(x){ if(x) haveIds[String(x.id)]=1; });
  var tagCounts={};
  (mine.readList||[]).forEach(function(x){
    var b=findBookById(x.id); if(!b) return;
    (b.tags||[]).forEach(function(t){ tagCounts[t]=(tagCounts[t]||0)+1; });
  });
  var topTags=Object.keys(tagCounts).sort(function(a,b){return (tagCounts[b]||0)-(tagCounts[a]||0);}).slice(0,4);
  var pool=BOOKS().filter(function(b){
    if(haveIds[String(b.id)]) return false;
    if(b.recommender===currentUser) return false;
    var ok = averageRatingForBook(b) >= 3.5;
    if(!ok) return false;
    if(!topTags.length) return true;
    return (b.tags||[]).some(function(t){ return topTags.indexOf(String(t).toLowerCase())>-1; });
  }).slice(0,6);
  if(!pool.length){ recsWrap.classList.remove('show'); row.innerHTML=''; return; }
  row.innerHTML=pool.map(function(b){
    return '<div class="rec-card" data-id="'+b.id+'">'+
      (b.image?'<img src="'+escapeAttr(b.image)+'" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid #e6ece8">':'')+
      '<div class="rec-title">'+escapeHtml(b.title)+'</div>'+
      '<div class="small" style="color:#20362c">'+escapeHtml(b.author)+'</div>'+
      '<button class="rec-btn" type="button" data-action="wish" data-id="'+b.id+'">Add</button>'+
    '</div>';
  }).join('');
  recsWrap.classList.add('show');
}
function renderComingSoon(){
  var arr=UPCOMING()||[];
  var box=$('#coming-soon-box'); var list=$('#coming-soon-list');
  if(!arr.length){ box.style.display='none'; list.innerHTML=''; return; }
  list.innerHTML=arr.slice(0,6).map(function(it){
    return '<div class="lb-row"><div><strong>'+escapeHtml(it.title)+'</strong> <span class="small" style="color:#2b3832">by '+escapeHtml(it.author)+'</span><span class="chip" style="margin-left:6px">Series: '+escapeHtml(it.series)+'</span></div><span class="lb-count">'+escapeHtml(it.release)+'</span></div>';
  }).join('');
  box.style.display='block';
}

/* ========= Scope Switch ========= */
function setScope(s){
  currentScope = (s==='wellness') ? 'wellness' : 'main';
  $('#scope-main-btn').classList.toggle('active', currentScope==='main');
  $('#scope-wellness-btn').classList.toggle('active', currentScope==='wellness');
  $('#scope-subtitle').textContent = currentScope==='wellness' ? 'Wellness recommendations & resources' : 'Find your next favorite book';
  populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats();
}

/* ========= Admin Page Routing ========= */
function openAdminPage(){
  document.body.scrollTop = document.documentElement.scrollTop = 0;
  $('#admin-page').style.display='block';
  $('.container').style.display='none';
  location.hash = '#admin';
}
function closeAdminPage(){
  $('#admin-page').style.display='none';
  $('.container').style.display='block';
  if(location.hash==='#admin') history.replaceState(null,'',location.pathname+location.search);
}

/* ========= Boot ========= */
document.addEventListener('DOMContentLoaded', async function(){
  await loadAll();
  setupPWA();
  $('#login-section').style.display='block';
  $('#main-app').style.display='none';
  $('#user-bar').style.display='none';
  $('#prelogin-row').style.display='none';
  $('#main-nav').style.display='none';

  populateCategoryOptions(); populateRecommenderFilter(); populateTagFilter();
  applyFilters(); renderActivity(); renderMyLists(); updateStats(); renderWatchedSeries();

  // header chips & nav
  $('#stat-books').addEventListener('click', function(){ openSection('feed'); window.scrollTo({top:0,behavior:'smooth'}); });
  $('#users-chip').addEventListener('mouseenter', function(){ var p=$('#users-pop'); p.style.display='block'; var r=$('#users-chip').getBoundingClientRect(); p.style.position='fixed'; p.style.left=(r.left)+'px'; p.style.top=(r.bottom+6)+'px'; });
  $('#users-pop').addEventListener('mouseleave', function(){ $('#users-pop').style.display='none'; });

  // scope
  $('#scope-main-btn').addEventListener('click', function(){ setScope('main'); });
  $('#scope-wellness-btn').addEventListener('click', function(){ setScope('wellness'); });

  // subnav
  $('#feed-btn').addEventListener('click', function(){ openSection('feed'); applyFilters(); });
  $('#add-btn').addEventListener('click', function(){ openSection('add'); });
  $('#my-books-btn').addEventListener('click', function(){ openSection('my-books'); renderMyLists(); });
  $('#prefs-btn').addEventListener('click', function(){ openSection('prefs'); });

  // login
  $('#login-form').addEventListener('submit', function(e){
    e.preventDefault();
    var name=($('#username-input').value||'').trim(); if(!name) return;
    currentUser=name; ensureUser(currentUser);
    $('#current-user-name').textContent=currentUser;
    $('#user-bar').style.display='flex';
    $('#login-section').style.display='none';
    $('#main-app').style.display='block';
    $('#main-nav').style.display='flex';
    $('#recommender').value=currentUser;
    $('#prelogin-row').style.display='grid';
    renderMyLists(); updateStats(); applyFilters(); renderActivity(); computeAndRenderRecs();
  });
  $('#logout-btn').addEventListener('click', function(){
    currentUser=''; $('#user-bar').style.display='none'; $('#main-app').style.display='none';
    $('#login-section').style.display='block'; $('#prelogin-row').style.display='none'; $('#main-nav').style.display='none'; computeAndRenderRecs();
  });

  // activity UI
  $('#activity-toggle').addEventListener('click', function(){ activityExpanded=!activityExpanded; renderActivity(); });
  $('#activity-filter').addEventListener('change', renderActivity);

  // filters
  $('#search-input').addEventListener('input', applyFilters);
  $('#tag-filter').addEventListener('change', applyFilters);
  $('#category-filter').addEventListener('change', applyFilters);
  $('#recommender-filter').addEventListener('change', applyFilters);
  $('#min-rating').addEventListener('change', applyFilters);
  $('#sort-by').addEventListener('change', applyFilters);
  $('#collapse-all').addEventListener('change', renderBooks);
  $('#hide-synopses').addEventListener('change', renderBooks);

  // recs refresh
  $('#recs-refresh').addEventListener('click', computeAndRenderRecs);

  // search (books or podcasts)
  var debounceT=null;
  function doUnifiedSearch(q){
    var t=$('#media-type').value;
    if(t==='podcast') searchApplePodcasts(q);
    else searchGoogleBooks(q);
  }
  $('#book-search').addEventListener('input',function(e){
    clearTimeout(debounceT); debounceT=setTimeout(function(){doUnifiedSearch(e.target.value);},300);
  });
  $('#media-type').addEventListener('change', function(){
    $('#book-search').placeholder = this.value==='podcast' ? 'Search Apple Podcasts‚Ä¶' : 'Search Google Books‚Ä¶';
    $('#book-results').style.display='none'; $('#book-results').innerHTML='';
    lastSearchItems=[];
  });

  document.addEventListener('click',function(e){
    var pick=e.target.closest && e.target.closest('[data-pick]');
    if(pick){
      var i=Number(pick.getAttribute('data-pick'));
      var it=lastSearchItems[i]; if(!it) return;
      $('#title').value=it.title;
      $('#author').value=it.authors;
      $('#book-image').value=it.cover||'';
      $('#synopsis').value=it.description||'';
      if(it.type==='podcast'){ $('#media-type').value='podcast'; }
      currentTags=[]; if(it.categories && it.categories.length) currentTags=currentTags.concat(it.categories.slice(0,3).map(function(x){return String(x).toLowerCase();}));
      renderTagsDisplay();
      autoTagsFrom({categories:it.categories,genre:$('#genre').value,synopsis:$('#synopsis').value});
      $('#book-results').style.display='none';
      // stash podcast link
      $('#book-form').dataset.podcastUrl = it.podcastUrl || '';
    }
  });
  var bs = document.getElementById('book-search');
  if(bs){ bs.addEventListener('keydown', function(e){ if((e.key||'')==='Enter' || e.keyCode===13) e.preventDefault(); }); }

  // tag interactions
  $('#tags-display').addEventListener('click', function(e){
    var x=e.target.closest && e.target.closest('.tag'); if(!x) return;
    var t=x.getAttribute('data-tag'); currentTags=currentTags.filter(function(y){return y!==t;}); renderTagsDisplay();
  });
  $('#tag-input').addEventListener('input',function(e){
    var q=(e.target.value||'').toLowerCase().trim(); var s=$('#tag-suggestions');
    if(!q){s.style.display='none';return;}
    var items=tagSuggestions.filter(function(t){return t.indexOf(q)>-1 && currentTags.indexOf(t)===-1;}).slice(0,8);
    s.innerHTML=items.map(function(t){return '<div class="lb-row" data-tagpick="'+t+'"><div>'+t+'</div></div>';}).join('');
    s.style.display=items.length?'block':'none';
  });
  document.addEventListener('click',function(e){
    var t=e.target.closest && e.target.closest('[data-tagpick]');
    if(t){ addTag(t.getAttribute('data-tagpick')); var s=$('#tag-suggestions'); if(s) s.style.display='none'; }
  });
  $('#synopsis').addEventListener('blur', function(){ autoTagsFrom({categories:[],genre:$('#genre').value,synopsis:$('#synopsis').value}); });
  (function(){
    var tagInput = document.getElementById('tag-input'); if(!tagInput) return;
    function commitTag(){ var val=(tagInput.value||'').trim(); if(val) addTag(val); }
    tagInput.addEventListener('keydown', function(e){
      var key=e.key||''; if(key==='Enter' || String(key).toLowerCase()==='go' || e.keyCode===13 || key===',' || key==='Tab'){ e.preventDefault(); commitTag(); }
    });
  })();

  // rating stars
  $$('#rating-stars .star').forEach(function(star){
    star.addEventListener('click', function(){
      var val=Number(star.getAttribute('data-rating'));
      currentRating=val;
      $$('#rating-stars .star').forEach(function(s){ s.classList.toggle('filled', Number(s.getAttribute('data-rating'))<=val); });
      $('#rating-feedback').textContent='You selected '+val+' star'+(val===1?'':'s')+'.';
    });
  });
  $$('#finish-stars .star').forEach(function(star){
    star.addEventListener('click', function(){
      var val=Number(star.getAttribute('data-rating'));
      currentRating=val;
      $$('#finish-stars .star').forEach(function(s){ s.classList.toggle('filled', Number(s.getAttribute('data-rating'))<=val); });
    });
  });

  // finish modal actions
  $('#finish-save').addEventListener('click', function(){
    try{
      if(!finishContext){ closeFinishModal(); return; }
      var book=findBookById(finishContext.bookId); if(!book){ closeFinishModal(); return; }
      var rating = isFinite(currentRating) ? currentRating : 0;
      ensureUser(currentUser);
      var mine = me();
      var idStr = String(book.id);
      var already = mine.readList.some(function(x){return String(x.id)===idStr;});
      var nowTs = Date.now();
      if(!already){
        mine.readList.push({id:book.id,title:book.title,author:book.author,_rating:rating,_wellness:(book._scope==='wellness'),_finishedAt:nowTs,_changedAt:nowTs});
        mine.currentReading = mine.currentReading.filter(function(x){return String(x.id)!==idStr;});
        mine.wishList = mine.wishList.filter(function(x){return String(x.id)!==idStr;});
      }else{
        var rec = mine.readList.find(function(x){return String(x.id)===idStr;}); rec._rating = rating; rec._finishedAt = nowTs; rec._changedAt = nowTs;
      }
      book.userRatings = book.userRatings || [];
      var ex = book.userRatings.find(function(r){return r.user===currentUser;});
      if(ex) ex.rating = rating; else book.userRatings.push({user:currentUser,rating:rating});

      var payload={user:currentUser,title:book.title,author:book.author}; if(rating>0) payload.rating=rating;
      mergeOrPostActivity({type:'finish',payload:payload});
      addActionComment(book, currentUser+' finished this '+(book.type==='podcast'?'podcast':'book')+(rating>0?(' ‚Äî '+rating+'‚òÖ'):''), currentUser);
      if(rating===5){ mergeOrPostActivity({type:'five',payload:{user:currentUser,title:book.title,author:book.author,rating:5}}); postToTeams('five', currentUser+' rated "'+book.title+'" 5‚òÖ'); }
      postToTeams('finish', currentUser+' finished "'+book.title+'"'+(rating>0?(' ‚Äî '+rating+'‚òÖ'):'')); saveAll(); closeFinishModal(); renderMyLists(); applyFilters(); updateStats(); showToast('Marked as read!');
    }catch(e){ console.warn(e); closeFinishModal(); showToast('Saved locally. If something looks off, refresh.',true); }
  });
  $('#finish-cancel').addEventListener('click', closeFinishModal);
  document.addEventListener('keydown',function(e){ if(e.key==='Escape' && $('#finish-modal').classList.contains('show')) closeFinishModal(); });
  document.addEventListener('click',function(e){ var m = $('#finish-modal'); if(!m || !m.classList.contains('show')) return; if(!m.contains(e.target)) closeFinishModal(); });

  // submit new recommendation
  $('#book-form').addEventListener('submit', function(e){
    e.preventDefault();
    if(!currentUser){ showToast('Please log in first.', true); return; }
    var title=$('#title').value.trim(), author=$('#author').value.trim();
    var genre=$('#genre').value, recommender=(($('#recommender').value)||currentUser).trim();
    var image=$('#book-image').value.trim(), synopsis=$('#synopsis').value.trim(), reason=$('#reason').value.trim();
    var seriesName=($('#series-name').value||'').trim();
    var seriesNumber=($('#series-number').value||'').trim();
    var mediaType = ($('#media-type').value||'book');
    if(!title||!author||!reason||!currentRating){ showToast('Title, author/host, rating, and reason are required.',true); return; }
    var book={id:Date.now(),
      type: mediaType,
      title:title, author:author, genre:genre, recommender:recommender,
      image:image, synopsis:synopsis, reason:reason, rating:currentRating, userRatings:[],
      tags:currentTags.slice(), comments:[], postLikes:0, postLikedBy:[], _scope:currentScope,
      seriesName:seriesName || '', seriesNumber:seriesNumber || ''
    };
    if(mediaType==='podcast'){
      var link = $('#book-form').dataset.podcastUrl || '';
      if(link){ book.podcastUrl = link; }
      if(!book.genre || book.genre==='other') book.genre = 'podcast';
      if(book.tags.indexOf('podcast')===-1) book.tags.unshift('podcast');
    }
    // add to current scope store
    BOOKS().unshift(book);

    // watch series if checked
    if($('#watch-series').checked && seriesName){ watchSeriesName(seriesName); }

    // also add to recommender's READ list with rating (like original behavior), tagging wellness flag
    ensureUser(recommender);
    var recMe=userData[recommender];
    var nowTs=Date.now();
    if(!recMe.readList.some(function(x){return x.id===book.id;}))
      recMe.readList.push({id:book.id,title:book.title,author:book.author,_rating:currentRating,_wellness:(currentScope==='wellness'),_finishedAt:nowTs,_changedAt:nowTs});

    addActionComment(book, recommender+' shared this '+(book.type==='podcast'?'podcast':'book')+' ‚Äî '+currentRating+'‚òÖ', recommender);
    mergeOrPostActivity({type:'share',payload:{user:recommender,title:title,author:author,rating:currentRating}});
    if(currentRating===5){ mergeOrPostActivity({type:'five',payload:{user:recommender,title:title,author:author,rating:5}}); }

    $('#book-form').reset(); currentTags=[]; renderTagsDisplay(); currentRating=0;
    $$('#rating-stars .star').forEach(function(s){ s.classList.remove('filled'); });
    $('#rating-feedback').textContent='Click stars to rate (required)';
    $('#book-results').style.display='none'; $('#book-form').dataset.podcastUrl='';
    saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); updateStats(); renderWatchedSeries(); showToast('Shared!');
  });

  // prefs & admin
  $('#prefs-save').addEventListener('click', function(){
    sitePrefs.postNew=$('#pref-post-new').checked;
    sitePrefs.postFinish=$('#pref-post-finish').checked;
    sitePrefs.postFive=$('#pref-post-5').checked;
    saveAll(); showToast('Preferences saved.');
  });
  $('#save-teams-btn').addEventListener('click', function(){ sitePrefs.teamsWebhook=$('#pref-teams-url').value.trim(); saveAll(); showToast('Teams URL saved'); });
  $('#export-csv-btn').addEventListener('click', exportCsvs);
  $('#export-json-btn').addEventListener('click', exportJson);
  $('#import-json').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(f) importJson(f); e.target.value=''; });

  // Admin (inline in Prefs)
  $('#toggle-danger').addEventListener('click', function(){
    var dm=$('#data-management');
    if(dm.style.display==='none' || !dm.style.display){
      var pw=prompt('Enter admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
      dm.style.display='block';
    }else{ dm.style.display='none'; }
  });

  // Cloud Sync UI
  function updateCloudStatus(){
    var chip=$('#cloud-status');
    var custom = (sitePrefs.cloudApiKey||'').trim() && (sitePrefs.cloudBinId||'').trim();
    chip.textContent = custom ? 'Custom bin connected' : 'Default bin';
  }
  updateCloudStatus();
  $('#cloud-save').addEventListener('click', function(){
    sitePrefs.cloudApiKey=$('#cloud-api-key').value.trim();
    sitePrefs.cloudBinId=$('#cloud-bin-id').value.trim();
    saveAll(false); updateCloudStatus(); showToast('Cloud config saved');
  });
  $('#cloud-clear').addEventListener('click', function(){
    sitePrefs.cloudApiKey=''; sitePrefs.cloudBinId=''; $('#cloud-api-key').value=''; $('#cloud-bin-id').value='';
    saveAll(false); updateCloudStatus(); showToast('Cloud config cleared');
  });
  $('#cloud-create').addEventListener('click', async function(){
    try{
      var key = ($('#cloud-api-key').value||'').trim() || DEFAULT_API_KEY;
      const payload={books,wellnessBooks,userData,activity,wellnessActivity,sitePrefs,comingSoon,wellnessComingSoon};
      const r=await fetch(JSONBIN_API+'/b',{method:'POST',headers:{'Content-Type':'application/json','X-Master-Key':key},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error(await r.text());
      const j=await r.json();
      var id = (j && j.metadata && j.metadata.id) || '';
      if(id){ sitePrefs.cloudApiKey=key; sitePrefs.cloudBinId=id; $('#cloud-api-key').value=key; $('#cloud-bin-id').value=id; saveAll(false); updateCloudStatus(); showToast('Created new bin'); }
      else showToast('Could not parse new bin id',true);
    }catch(e){ console.warn(e); showToast('Create failed',true); }
  });
  $('#cloud-pull').addEventListener('click', async function(){
    try{
      const r=await fetch(JSONBIN_API+'/b/'+effectiveBin()+'/latest',{headers:{'X-Master-Key':effectiveApiKey()}});
      if(!r.ok) throw new Error(await r.text());
      const data=await r.json();
      const record=data.record||{};
      books=record.books||books; wellnessBooks=record.wellnessBooks||wellnessBooks; userData=record.userData||userData;
      activity=record.activity||activity; wellnessActivity=record.wellnessActivity||wellnessActivity;
      comingSoon=record.comingSoon||comingSoon; wellnessComingSoon=record.wellnessComingSoon||wellnessComingSoon;
      for(var k2 in (record.sitePrefs||{})){ sitePrefs[k2]=record.sitePrefs[k2]; }
      saveAll(false); populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats(); renderWatchedSeries();
      showToast('Pulled from cloud');
    }catch(e){ console.warn(e); showToast('Pull failed',true); }
  });
  $('#cloud-push').addEventListener('click', async function(){ await saveAll(true); showToast('Pushed to cloud'); });

  // Admin (duplicate controls on separate Admin page)
  function guard(){ var pw=prompt('Admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return false; } return true; }
  function doClear(){ if(!confirm('This will erase ALL data. Continue?'))return;
    books=[]; wellnessBooks=[]; userData={}; activity=[]; wellnessActivity=[]; comingSoon=[]; wellnessComingSoon=[];
    sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true,openaiKey:sitePrefs.openaiKey||'',cloudApiKey:sitePrefs.cloudApiKey||'',cloudBinId:sitePrefs.cloudBinId||'',watchedSeries:sitePrefs.watchedSeries||[]};
    saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats(); renderWatchedSeries(); showToast('All data cleared.');
  }
  $('#clear-data-btn').addEventListener('click', function(){ if(guard()) doClear(); });
  $('#rename-user-btn').addEventListener('click', function(){
    if(!guard()) return;
    var from=$('#rename-from').value.trim(); var to=$('#rename-to').value.trim();
    if(!from||!to){ showToast('Enter both names',true); return; }
    if(!userData[from]){ showToast('From user not found',true); return; }
    ensureUser(to);
    ['readList','wishList','currentReading'].forEach(function(k){
      var a=userData[to][k]; var b=userData[from][k]; var ids={}; a.forEach(function(x){ids[x.id]=1;});
      b.forEach(function(x){ if(!ids[x.id]) a.push(x); });
    });
    delete userData[from];
    saveAll(); updateStats(); showToast('User renamed/merged');
  });
  $('#delete-book-btn').addEventListener('click', function(){
    if(!guard()) return;
    var idStr=$('#delete-book-id').value.trim(); if(!idStr){ showToast('Enter an ID',true); return; }
    var id=Number(idStr);
    var before=(books.length+wellnessBooks.length);
    books = books.filter(function(b){return b.id!==id;});
    wellnessBooks = wellnessBooks.filter(function(b){return b.id!==id;});
    Object.keys(userData).forEach(function(k){
      var u=userData[k];
      ['readList','wishList','currentReading'].forEach(function(key){ u[key]=u[key].filter(function(x){return x.id!==id;}); });
    });
    if((books.length+wellnessBooks.length)===before){ showToast('No item with that ID found',true); return; }
    saveAll(); applyFilters(); renderMyLists(); updateStats(); showToast('Item deleted.');
  });
  $('#purge-activity-btn').addEventListener('click', function(){
    if(!guard()) return;
    var days=parseInt($('#activity-days').value.trim(),10); if(!days||days<1){ showToast('Enter a valid number of days',true); return; }
    var cutoff=Date.now() - days*24*3600*1000;
    var arr=ACTIV(); var before=arr.length;
    var keep=arr.filter(function(a){ return new Date(a.at).getTime() >= cutoff; });
    if(currentScope==='main') activity=keep; else wellnessActivity=keep;
    saveAll(); renderActivity(); showToast('Purged '+(before-keep.length)+' activity items.');
  });
  $('#delete-last-activity-btn').addEventListener('click', function(){
    if(!guard()) return;
    var arr=ACTIV();
    if(arr.length){ arr.shift(); saveAll(); renderActivity(); showToast('Most recent activity deleted.'); }
    else { showToast('No activity to delete'); }
  });

  // Admin separate page mirrors
  function wireAdminPage(){
    $('#a-clear-data-btn').addEventListener('click', function(){ if(guard()) doClear(); });
    $('#a-rename-user-btn').addEventListener('click', function(){
      if(!guard()) return;
      var from=$('#a-rename-from').value.trim(); var to=$('#a-rename-to').value.trim();
      if(!from||!to){ showToast('Enter both names',true); return; }
      if(!userData[from]){ showToast('From user not found',true); return; }
      ensureUser(to);
      ['readList','wishList','currentReading'].forEach(function(k){
        var a=userData[to][k]; var b=userData[from][k]; var ids={}; a.forEach(function(x){ids[x.id]=1;});
        b.forEach(function(x){ if(!ids[x.id]) a.push(x); });
      });
      delete userData[from];
      saveAll(); updateStats(); showToast('User renamed/merged');
    });
    $('#a-delete-book-btn').addEventListener('click', function(){
      if(!guard()) return;
      var idStr=$('#a-delete-book-id').value.trim(); if(!idStr){ showToast('Enter an ID',true); return; }
      var id=Number(idStr);
      var before=(books.length+wellnessBooks.length);
      books = books.filter(function(b){return b.id!==id;});
      wellnessBooks = wellnessBooks.filter(function(b){return b.id!==id;});
      Object.keys(userData).forEach(function(k){
        var u=userData[k];
        ['readList','wishList','currentReading'].forEach(function(key){ u[key]=u[key].filter(function(x){return x.id!==id;}); });
      });
      if((books.length+wellnessBooks.length)===before){ showToast('No item with that ID found',true); return; }
      saveAll(); applyFilters(); renderMyLists(); updateStats(); showToast('Item deleted.');
    });
    $('#a-purge-activity-btn').addEventListener('click', function(){
      if(!guard()) return;
      var days=parseInt($('#a-activity-days').value.trim(),10); if(!days||days<1){ showToast('Enter a valid number of days',true); return; }
      var cutoff=Date.now() - days*24*3600*1000;
      var arr=ACTIV(); var before=arr.length;
      var keep=arr.filter(function(a){ return new Date(a.at).getTime() >= cutoff; });
      if(currentScope==='main') activity=keep; else wellnessActivity=keep;
      saveAll(); renderActivity(); showToast('Purged '+(before-keep.length)+' activity items.');
    });
    $('#a-delete-last-activity-btn').addEventListener('click', function(){
      if(!guard()) return;
      var arr=ACTIV();
      if(arr.length){ arr.shift(); saveAll(); renderActivity(); showToast('Most recent activity deleted.'); }
      else { showToast('No activity to delete'); }
    });
    $('#a-save-teams-btn').addEventListener('click', function(){ sitePrefs.teamsWebhook=$('#a-pref-teams-url').value.trim(); saveAll(); showToast('Teams URL saved'); });
    $('#admin-back').addEventListener('click', closeAdminPage);
  }
  wireAdminPage();
  $('#open-admin-page').addEventListener('click', function(){ if(guard()) openAdminPage(); });
  if(location.hash==='#admin'){ openAdminPage(); }

  // install PWA
  $('#install-app-btn').addEventListener('click', async function(){
    var status=$('#install-status');
    var standalone=(window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)||window.navigator.standalone===true;
    if(standalone){ showToast('Already installed'); return; }
    if(deferredPrompt){
      deferredPrompt.prompt(); var res=await deferredPrompt.userChoice;
      if(res && res.outcome==='accepted'){ status.textContent='Installed'; showToast('Installed'); }
      deferredPrompt=null;
    } else{
      $('#ios-steps').setAttribute('open','open'); showToast('On iPhone/iPad use Share ‚Üí Add to Home Screen');
    }
  });

  // writing assistant key
  $('#save-openai-key').addEventListener('click', function(){ sitePrefs.openaiKey=$('#openai-key').value.trim(); saveAll(); showToast('API key saved (local only)'); });
  $('#clear-openai-key').addEventListener('click', function(){ sitePrefs.openaiKey=''; $('#openai-key').value=''; saveAll(); showToast('API key cleared'); });

  // suggest reason
  $('#reason-suggest').addEventListener('click', async function(){
    var tone=$('#reason-tone').value||'personal'; var btn=$('#reason-suggest');
    setLoading(btn,true); var text=await suggestReason(tone); setLoading(btn,false);
    $('#reason').value=text; $('#reason').focus();
  });

  // global click handlers (comments, likes, lists, series, etc.)
  document.addEventListener('click',function(e){
    var btn=e.target.closest && e.target.closest('[data-action]');
    var jump=e.target.closest && e.target.closest('[data-jump]');
    if(jump){
      var id=jump.getAttribute('data-jump'); var el=$('#book-'+id);
      if(el){ openSection('feed'); el.scrollIntoView({behavior:'smooth',block:'start'}); }
      return;
    }
    if(!btn) return;
    var action=btn.getAttribute('data-action');
    var bookId=btn.getAttribute('data-id');
    var cid=btn.getAttribute('data-cid');

    function findBook(id){ return findBookById(id); }

    if(action==='toggle-comments'){
      var list=$('[data-list="'+bookId+'"]'); if(list) list.style.display=(list.style.display==='none'?'grid':'none'); return;
    }
    if(action==='toggle-synopsis'){
      var full=btn.getAttribute('data-full')||''; var wrap=document.querySelector('.syn[data-syn="'+bookId+'"]');
      if(!wrap) return; var span=wrap.querySelector('.syn-text'); if(!span) return;
      var expanded=span.getAttribute('data-expanded')==='true';
      if(expanded){ span.textContent = (full.length>280? full.slice(0,279)+'‚Ä¶' : full); span.setAttribute('data-expanded','false'); btn.textContent='Read more'; }
      else{ span.textContent = full; span.setAttribute('data-expanded','true'); btn.textContent='Show less'; }
      return;
    }
    if(action==='like'){
      if(!currentUser){ showToast('Log in to like.',true); return; }
      var b=findBook(bookId); if(!b) return;
      b.postLikedBy=b.postLikedBy||[];
      if(b.postLikedBy.indexOf(currentUser)>-1){ b.postLikedBy=b.postLikedBy.filter(function(n){return n!==currentUser;}); b.postLikes=Math.max(0,(b.postLikes||0)-1); }
      else{ b.postLikedBy.push(currentUser); b.postLikes=(b.postLikes||0)+1; mergeOrPostActivity({type:'like',payload:{user:currentUser,title:b.title}}); }
      saveAll(); applyFilters(); return;
    }
    if(action==='wish'){
      if(!currentUser){ showToast('Log in to add to list.',true); return; }
      var bw=findBook(bookId); if(!bw) return;
      ensureUser(currentUser); var mine=me();
      if(!mine.wishList.some(function(x){return String(x.id)===String(bw.id);})){
        var nowTs=Date.now();
        mine.wishList.push({id:bw.id,title:bw.title,author:bw.author,_wellness:(bw._scope==='wellness'),_changedAt:nowTs});
      }
      addActionComment(bw, currentUser+' added to Want to Read', currentUser);
      mergeOrPostActivity({type:'list',payload:{user:currentUser,title:bw.title,action:'added to Want to Read'}});
      saveAll(); renderMyLists(); updateStats(); showToast('Added to Want to Read'); return;
    }
    if(action==='reading'){
      if(!currentUser){ showToast('Log in to add to list.',true); return; }
      var br=findBook(bookId); if(!br) return;
      ensureUser(currentUser); var meData=me();
      var nowTs=Date.now();
      if(!meData.currentReading.some(function(x){return String(x.id)===String(br.id);})){
        meData.currentReading.push({id:br.id,title:br.title,author:br.author,_wellness:(br._scope==='wellness'),_startedAt:nowTs,_changedAt:nowTs});
        meData.wishList=meData.wishList.filter(function(x){return String(x.id)!==String(br.id);});
      }
      addActionComment(br, currentUser+' started reading', currentUser);
      mergeOrPostActivity({type:'list',payload:{user:currentUser,title:br.title,action:'started reading'}});
      saveAll(); renderMyLists(); updateStats(); showToast('Added to Currently Reading'); return;
    }
    if(action==='finish' || action==='rate-again'){
      if(!currentUser){ showToast('Log in to finish.',true); return; }
      var bf=findBook(bookId); if(!bf) return; openFinishModal(bf); return;
    }
    if(action==='remove-current'){
      ensureUser(currentUser); me().currentReading=me().currentReading.filter(function(x){return String(x.id)!==String(bookId);});
      saveAll(); renderMyLists(); updateStats(); return;
    }
    if(action==='remove-wish'){
      ensureUser(currentUser); me().wishList=me().wishList.filter(function(x){return String(x.id)!==String(bookId);});
      saveAll(); renderMyLists(); updateStats(); return;
    }
    if(action==='remove-read'){
      ensureUser(currentUser); me().readList=me().readList.filter(function(x){return String(x.id)!==String(bookId);});
      saveAll(); renderMyLists(); updateStats(); return;
    }
    if(action==='add-comment'){
      var wrap=btn.closest('.c-form'); if(!wrap) return;
      var name=(wrap.querySelector('[data-field="name"]').value||'').trim()||currentUser||'Anonymous';
      var text=(wrap.querySelector('[data-field="text"]').value||'').trim(); if(!text){ showToast('Comment cannot be empty.',true); return; }
      var bb=findBook(bookId); if(!bb) return;
      bb.comments=bb.comments||[]; bb.comments.push({id:Date.now()+Math.random(),commenter:name,text:text,likes:0,likedBy:[],system:false});
      mergeOrPostActivity({type:'comment',payload:{user:name,title:bb.title}});
      saveAll(); applyFilters(); showToast('Comment added!'); return;
    }
    if(action==='like-comment'){
      if(!currentUser){ showToast('Log in to like comments.', true); return; }
      var bl=findBook(bookId); if(!bl) return;
      var c=(bl.comments||[]).find(function(x){return String(x.id)===String(cid);}); if(!c) return;
      c.likedBy=c.likedBy||[];
      if(c.likedBy.indexOf(currentUser)>-1){ c.likedBy=c.likedBy.filter(function(n){return n!==currentUser;}); c.likes=Math.max(0,(c.likes||0)-1); }
      else { c.likedBy.push(currentUser); c.likes=(c.likes||0)+1; }
      saveAll(); applyFilters(); return;
    }
    if(action==='similar'){
      var b=findBook(bookId); if(!b) return;
      var seed = (b.tags && b.tags[0]) || b.author || b.title;
      $('#search-input').value = seed;
      openSection('feed'); applyFilters(); window.scrollTo({top:0,behavior:'smooth'});
      return;
    }
    if(action==='share'){
      var b=findBook(bookId); if(!b) return;
      var avg=averageRatingForBook(b).toFixed(1);
      var text = '‚Äú'+b.title+'‚Äù by '+b.author+' ‚Äî '+avg+'‚òÖ on Book Club. '+mediaUrl(b);
      if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(function(){ showToast('Copied share text!'); }); }
      else { prompt('Copy this:', text); }
      return;
    }
    if(action==='watch-series'){
      var name=btn.getAttribute('data-ser')||''; if(name){ watchSeriesName(name); }
      return;
    }
    if(action==='set-series'){
      var b=findBook(bookId); if(!b) return;
      var val=prompt('Enter series name (optional # at end like "Stormlight 3"):', b.seriesName? (b.seriesNumber? (b.seriesName+' '+b.seriesNumber) : b.seriesName) : '');
      if(val!=null){
        val=String(val).trim();
        if(!val){ b.seriesName=''; b.seriesNumber=''; }
        else{
          var m = val.match(/^(.*?)(?:\s+(\d+))?$/);
          b.seriesName=(m&&m[1]?m[1].trim():val);
          b.seriesNumber=(m&&m[2]?m[2]:'');
        }
        saveAll(); applyFilters(); showToast('Series updated');
      }
      return;
    }
    if(action==='add-series-books'){
      var ser=btn.getAttribute('data-ser')||''; if(!ser) return;
      openSection('add');
      $('#series-name').value=ser;
      $('#watch-series').checked=true;
      $('#book-search').value=ser; $('#book-results').innerHTML=''; $('#book-results').style.display='none';
      $('#media-type').value='book';
      // kick off a search
      searchGoogleBooks(ser);
      showToast('Searching books for series "'+ser+'"‚Ä¶');
      return;
    }
  });

  // Coming Soon checker
  $('#check-new-btn').addEventListener('click', async function(){
    var series = sitePrefs.watchedSeries||[]; if(!series.length){ showToast('No watched series yet', true); return; }
    setLoading(this,true);
    try{
      var found=[];
      for (var i=0;i<series.length;i++){
        var s = series[i];
        try{
          const r = await fetch('https://www.googleapis.com/books/v1/volumes?q='+encodeURIComponent('"'+s+'"')+'&orderBy=newest&maxResults=5');
          if(!r.ok) continue;
          const data = await r.json();
          (data.items||[]).forEach(function(it){
            var v=it.volumeInfo||{}, pd=String(v.publishedDate||'');
            // Only include future-dated (best effort when full date), otherwise newest with year >= current
            var year = parseInt(pd.slice(0,4),10);
            if(!year || year < new Date().getFullYear()) return;
            found.push({title:v.title||'Unknown', author:(v.authors||[]).join(', ')||'Unknown', release:pd, series:s});
          });
        }catch(_e){}
      }
      if(found.length){
        var store = UPCOMING();
        // merge by title
        var seen={}; store.forEach(function(x){ seen[x.title+'|'+x.series]=1; });
        found.forEach(function(x){ if(!seen[x.title+'|'+x.series]) store.push(x); });
        if(currentScope==='main') comingSoon=store; else wellnessComingSoon=store;
        saveAll(); renderComingSoon(); showToast('Found '+found.length+' upcoming title(s)');
      }else{
        showToast('No upcoming releases found');
      }
    }finally{ setLoading(this,false); }
  });

  // trending click scroll
  var t1=$('#trending-prelogin');
  if(t1){ t1.addEventListener('click',function(e){ var r=e.target.closest && e.target.closest('[data-jump]'); if(!r) return; var id=r.getAttribute('data-jump'); var el=$('#book-'+id); if(el){ openSection('feed'); el.scrollIntoView({behavior:'smooth',block:'start'}); } }); }

  // Watched series remove
  document.addEventListener('click', function(e){
    var un=e.target.closest && e.target.closest('[data-unwatch]'); if(!un) return;
    unwatchSeriesName(un.getAttribute('data-unwatch'));
  });

  // open admin page
  $('#admin-back').addEventListener('click', closeAdminPage);
});

/* Helpers */
function openSection(id){
  $$('.section').forEach(function(s){s.classList.remove('active');});
  $('#'+id).classList.add('active');
  $$('.nav-btn').forEach(function(b){ if(['feed-btn','add-btn','my-books-btn','prefs-btn'].indexOf(b.id)>-1) b.classList.remove('active'); });
  if(id==='feed') $('#feed-btn').classList.add('active');
  if(id==='add') $('#add-btn').classList.add('active');
  if(id==='my-books') $('#my-books-btn').classList.add('active');
  if(id==='prefs') $('#prefs-btn').classList.add('active');
}
function addActionComment(book, text, who){
  book.comments=book.comments||[];
  book.comments.unshift({id:Date.now()+Math.random(), commenter: who || 'Anonymous', text: text, likes:0, likedBy:[], system:false});
}
function findBookById(id){
  id=String(id);
  var b = BOOKS().find(function(x){return String(x.id)===id;});
  if(b) return b;
  return OTHER_BOOKS().find(function(x){return String(x.id)===id;});
}
  <script>
/* === Success screen + Series (hidden) + Category/Series autofill ‚Äî drop-in patch === */
document.addEventListener('DOMContentLoaded', function(){

  /* ----------------------- success modal ----------------------- */
  var after = document.createElement('div');
  after.id = 'after-share-modal';
  after.className = 'toast';
  after.style.left = '50%';
  after.style.transform = 'translate(-50%,0)';
  after.style.bottom = 'auto';
  after.style.top = '20%';
  after.style.maxWidth = '520px';
  after.style.pointerEvents = 'auto';
  after.innerHTML = [
    '<div>',
      '<h3 style="margin-bottom:6px">Your recommendation was posted!</h3>',
      '<p class="small" style="margin-bottom:10px">What would you like to do next?</p>',
      '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end">',
        '<button class="nav-btn" data-act="again" type="button">Recommend More</button>',
        '<button class="nav-btn" data-act="fun" type="button">Fun Books</button>',
        '<button class="nav-btn" data-act="well" type="button">Wellness</button>',
        '<button class="nav-btn" data-act="lists" type="button">My Lists</button>',
        '<button class="nav-btn" data-act="close" type="button" style="background:#b74a4a;border-color:#5c1f1f">Close</button>',
      '</div>',
    '</div>'
  ].join('');
  document.body.appendChild(after);

  // make it center like the finish modal
  var st = document.createElement('style');
  st.textContent = '#after-share-modal.show{transform:translate(-50%,0);}';
  document.head.appendChild(st);

  var lastRecommendedScope = null;
  function openAfterShare(){ after.classList.add('show'); }
  function closeAfterShare(){ after.classList.remove('show'); }

  after.addEventListener('click', function(e){
    var act = e.target && e.target.getAttribute('data-act');
    if(!act) return;
    if(act==='again'){
      if(typeof setScope==='function' && lastRecommendedScope){ setScope(lastRecommendedScope); }
      if(typeof openSection==='function'){ openSection('add'); }
      closeAfterShare();
    }else if(act==='fun'){
      if(typeof setScope==='function'){ setScope('main'); }
      if(typeof openSection==='function'){ openSection('feed'); }
      closeAfterShare();
    }else if(act==='well'){
      if(typeof setScope==='function'){ setScope('wellness'); }
      if(typeof openSection==='function'){ openSection('feed'); }
      closeAfterShare();
    }else if(act==='lists'){
      if(typeof openSection==='function'){ openSection('my-books'); }
      closeAfterShare();
    }else if(act==='close'){
      if(typeof setScope==='function' && lastRecommendedScope){ setScope(lastRecommendedScope); }
      if(typeof openSection==='function'){ openSection('feed'); }
      closeAfterShare();
    }
  });

  /* --------- add Series UI (hidden behind a pill button) -------- */
  (function addSeriesUI(){
    var form = document.getElementById('book-form');
    if(!form) return;

    // container right before the Tags block
    var tagsBlock = document.getElementById('tags-container')?.parentNode || form.lastElementChild;

    var wrap = document.createElement('div');
    wrap.id = 'series-wrap';
    wrap.innerHTML = [
      '<div style="display:flex;align-items:center;gap:8px;margin:8px 0">',
        '<button class="pill-btn" id="series-toggle" type="button" title="Show series fields">Series (optional)</button>',
        '<span class="small" id="series-status" style="color:#2b3832;display:none">Auto-detected</span>',
      '</div>',
      '<div id="series-fields" style="display:none">',
        '<div class="search" style="grid-template-columns:2fr 1fr">',
          '<div><label class="small">Series Name</label><input class="input" id="series-name-input" placeholder="e.g., The Stormlight Archive"></div>',
          '<div><label class="small">Series Number</label><input class="input" id="series-number-input" placeholder="e.g., 1"></div>',
        '</div>',
      '</div>'
    ].join('');
    tagsBlock.parentNode.insertBefore(wrap, tagsBlock);

    document.getElementById('series-toggle').addEventListener('click', function(){
      var f = document.getElementById('series-fields');
      f.style.display = (f.style.display==='none' || !f.style.display) ? 'block' : 'none';
    });
  })();

  /* ------------- Category + Series: populate from pick ------------- */
  function normalize(s){ return String(s||'').toLowerCase().replace(/&/g,'and').trim(); }
  function setGenre(value){
    var sel=document.getElementById('genre'); if(!sel) return;
    var want=String(value||'').toLowerCase();
    var ok = Array.prototype.some.call(sel.options, function(o){ return o.value===want; });
    sel.value = ok ? want : (want||'other');
    if(!ok && sel.value!=='other') sel.value='other';
  }
  function guessCategoryFrom(result){
    if(result && result.type==='podcast') return 'podcast';
    var cats = (result && result.categories || []).map(normalize);
    var map = {
      'science fiction':'sci-fi','sci fi':'sci-fi','sci-fi':'sci-fi',
      'young adult':'young adult','ya':'young adult',
      'mystery':'mystery','detective':'mystery',
      'thriller':'thriller','suspense':'thriller',
      'romance':'romance','fantasy':'fantasy','horror':'horror',
      'history':'history','memoir':'memoir','biography':'biography',
      'business and economics':'business','business':'business',
      'self-help':'self-help','self help':'self-help',
      'psychology':'psychology','philosophy':'philosophy',
      'religion':'spirituality/religion','spirituality':'spirituality/religion',
      'health and fitness':'health & fitness','health':'health & fitness','fitness':'health & fitness',
      'technology':'technology','poetry':'poetry',
      'graphic novels':'comics/graphic novel','comics & graphic novels':'comics/graphic novel','comics':'comics/graphic novel',
      'dystopian':'dystopian','literary':'literary fiction','classics':'classics'
    };
    for(var i=0;i<cats.length;i++){
      var raw=cats[i];
      if(map[raw]) return map[raw];
      if(/sci[-\s]?fi|science\s*fiction/.test(raw)) return 'sci-fi';
      if(/young\s*adult|^\s*ya\s*$/.test(raw)) return 'young adult';
      if(/mystery|detective|crime/.test(raw)) return 'mystery';
      if(/thriller|suspense/.test(raw)) return 'thriller';
      if(/fantasy/.test(raw)) return 'fantasy';
      if(/romance/.test(raw)) return 'romance';
      if(/horror/.test(raw)) return 'horror';
      if(/memoir|autobiograph/.test(raw)) return 'memoir';
      if(/biograph/.test(raw)) return 'biography';
      if(/business|economics|finance|management|startup/.test(raw)) return 'business';
      if(/self[-\s]?help|productivity|habits/.test(raw)) return 'self-help';
      if(/psychology|behavior|cognitive/.test(raw)) return 'psychology';
      if(/philosophy|ethic|stoic/.test(raw)) return 'philosophy';
      if(/relig|christian|faith|spirit/.test(raw)) return 'spirituality/religion';
      if(/health|fitness|wellness|sleep|stress/.test(raw)) return 'health & fitness';
      if(/technology|computer|programming|software/.test(raw)) return 'technology';
      if(/poetry/.test(raw)) return 'poetry';
      if(/dystop/.test(raw)) return 'dystopian';
      if(/literary/.test(raw)) return 'literary fiction';
    }
    var s=normalize((result && result.description) || '');
    if(/sci[-\s]?fi|science\s*fiction/.test(s)) return 'sci-fi';
    if(/mystery|detective|crime/.test(s)) return 'mystery';
    if(/fantasy/.test(s)) return 'fantasy';
    if(/romance/.test(s)) return 'romance';
    if(/thriller|suspense/.test(s)) return 'thriller';
    return 'other';
  }

  // series parsing
  function parseSeriesFromTitle(t){
    var out = {name:'', number:''};
    if(!t) return out;
    // Patterns like: "Title (Series Name, #1)" OR "(Series Name Book 1)"
    var m = t.match(/\(([^)]+?)(?:,?\s*(?:book|bk|volume|vol\.?|#)\s*(\d+))?\)/i);
    if(m){
      // m[1] might be "The Stormlight Archive" or "The Stormlight Archive, #1"
      var pNum = m[1].match(/(?:^|,\s*)(?:book|bk|volume|vol\.?|#)\s*(\d+)/i);
      out.name = m[1].replace(/,\s*#?\d+.*$/,'').replace(/\s*(book|bk|volume|vol\.?)\s*\d+$/i,'').trim();
      out.number = (m[2] || (pNum && pNum[1]) || '').trim();
      return out;
    }
    // "#1" somewhere after a dash/colon
    var m2 = t.match(/-\s*([^‚Äì‚Äî:]+)\s*[,‚Äì‚Äî:]?\s*#\s*(\d+)/i);
    if(m2){ out.name = m2[1].trim(); out.number = m2[2].trim(); return out; }
    // "Book 2 of <Series>"
    var m3 = t.match(/book\s*(\d+)\s*of\s*([^:()]+)/i);
    if(m3){ out.number=m3[1]; out.name=m3[2].trim(); return out; }
    return out;
  }
  function parseSeriesFromDesc(d){
    var out = {name:'', number:''};
    if(!d) return out;
    var m = d.match(/(?:book|bk|volume|vol\.?)\s*(\d+)\s*(?:of|in)\s*([A-Z][\w '\-:]+)/i);
    if(m){ out.number=m[1]; out.name=m[2].replace(/\.$/,'').trim(); return out; }
    return out;
  }
  function setSeries(name,num, auto){
    var f = document.getElementById('series-fields');
    var nameEl = document.getElementById('series-name-input');
    var numEl  = document.getElementById('series-number-input');
    var status = document.getElementById('series-status');
    if(!nameEl || !numEl) return;
    if(name) nameEl.value = name;
    if(num)  numEl.value  = num;
    if(auto && (name || num)){
      status.style.display = 'inline';
      // open the fields so they can see/edit
      if(f && (f.style.display==='none' || !f.style.display)){
        f.style.display = 'block';
      }
    }
  }

  // When a search result is picked, fill Category + Series
  document.addEventListener('click', function(e){
    var pick = e.target.closest && e.target.closest('[data-pick]');
    if(!pick) return;
    var i = Number(pick.getAttribute('data-pick'));
    if(isNaN(i) || !Array.isArray(window.lastSearchItems)) return;
    var item = window.lastSearchItems[i]; if(!item) return;

    // Ensure media type matches
    var mt = document.getElementById('media-type');
    if(mt){ mt.value = (item.type==='podcast' ? 'podcast' : 'book'); }

    // Category
    setGenre(guessCategoryFrom(item));

    // Series (books: parse from title/description; podcast: usually show title == series)
    if(item.type==='podcast'){
      // Podcasts are inherently "series" shows; leave number blank
      setSeries(item.title || '', '', true);
    }else{
      var fromT = parseSeriesFromTitle(item.title || '');
      var fromD = parseSeriesFromDesc(item.description || '');
      var name = fromT.name || fromD.name || '';
      var num  = fromT.number || fromD.number || '';
      if(name || num) setSeries(name, num, true);
    }
  }, true); // capture so it runs before default handlers if needed

  // Keep Category in sync with manual media-type flip
  var mtSel = document.getElementById('media-type');
  if(mtSel){
    mtSel.addEventListener('change', function(){
      if(this.value==='podcast'){ setGenre('podcast'); }
    });
  }

  /* --------- show success modal after a real submit success ---------- */
  var formEl = document.getElementById('book-form');
  if(formEl){
    formEl.addEventListener('submit', function(){
      var scopeAtSubmit = (typeof currentScope!=='undefined') ? currentScope : 'main';
      // wait a tick for the original handler to create activity + push book
      setTimeout(function(){
        try{
          var arr = (typeof ACTIV==='function') ? ACTIV() : [];
          var last = arr && arr[0];
          if(last && last.type==='share' && last.payload && last.payload.user===window.currentUser){
            // Add series fields onto the most recent book in current scope
            var b = (typeof BOOKS==='function' && BOOKS()[0]) ? BOOKS()[0] : null;
            var nameEl = document.getElementById('series-name-input');
            var numEl  = document.getElementById('series-number-input');
            if(b && nameEl && numEl){
              b.seriesName   = (nameEl.value||'').trim();
              b.seriesNumber = (numEl.value||'').trim();
              if(typeof saveAll==='function') saveAll();
            }
            lastRecommendedScope = scopeAtSubmit;
            openAfterShare();
          }
        }catch(_e){}
      }, 80);
    });
  }
});
  <script>
/* === Category autopopulate fix (books + podcasts) === */
(function(){
  function normalize(s){ return String(s||'').toLowerCase().replace(/&/g,'and').trim(); }
  function guessCategoryFrom(result){
    if(result && result.type==='podcast') return 'podcast';
    var cats = (result && result.categories || []).map(normalize);
    var map = {
      'science fiction':'sci-fi','sci fi':'sci-fi','sci-fi':'sci-fi',
      'young adult':'young adult','ya':'young adult',
      'mystery':'mystery','detective':'mystery',
      'thriller':'thriller','suspense':'thriller',
      'romance':'romance','fantasy':'fantasy','horror':'horror',
      'history':'history','memoir':'memoir','biography':'biography',
      'business and economics':'business','business':'business',
      'self-help':'self-help','self help':'self-help',
      'psychology':'psychology','philosophy':'philosophy',
      'religion':'spirituality/religion','spirituality':'spirituality/religion',
      'health and fitness':'health & fitness','health':'health & fitness','fitness':'health & fitness',
      'technology':'technology','poetry':'poetry',
      'graphic novels':'comics/graphic novel','comics & graphic novels':'comics/graphic novel','comics':'comics/graphic novel',
      'dystopian':'dystopian','literary':'literary fiction','classics':'classics'
    };
    for(var i=0;i<cats.length;i++){
      var raw=cats[i];
      if(map[raw]) return map[raw];
      if(/sci[-\s]?fi|science\s*fiction/.test(raw)) return 'sci-fi';
      if(/young\s*adult|^\s*ya\s*$/.test(raw)) return 'young adult';
      if(/mystery|detective|crime/.test(raw)) return 'mystery';
      if(/thriller|suspense/.test(raw)) return 'thriller';
      if(/fantasy/.test(raw)) return 'fantasy';
      if(/romance/.test(raw)) return 'romance';
      if(/horror/.test(raw)) return 'horror';
      if(/memoir|autobiograph/.test(raw)) return 'memoir';
      if(/biograph/.test(raw)) return 'biography';
      if(/business|economics|finance|management|startup/.test(raw)) return 'business';
      if(/self[-\s]?help|productivity|habits/.test(raw)) return 'self-help';
      if(/psychology|behavior|cognitive/.test(raw)) return 'psychology';
      if(/philosophy|ethic|stoic/.test(raw)) return 'philosophy';
      if(/relig|christian|faith|spirit/.test(raw)) return 'spirituality/religion';
      if(/health|fitness|wellness|sleep|stress/.test(raw)) return 'health & fitness';
      if(/technology|computer|programming|software/.test(raw)) return 'technology';
      if(/poetry/.test(raw)) return 'poetry';
      if(/dystop/.test(raw)) return 'dystopian';
      if(/literary/.test(raw)) return 'literary fiction';
    }
    var s=normalize((result && result.description) || '');
    if(/sci[-\s]?fi|science\s*fiction/.test(s)) return 'sci-fi';
    if(/mystery|detective|crime/.test(s)) return 'mystery';
    if(/fantasy/.test(s)) return 'fantasy';
    if(/romance/.test(s)) return 'romance';
    if(/thriller|suspense/.test(s)) return 'thriller';
    return 'other';
  }
  function setGenre(value){
    var sel=document.getElementById('genre'); if(!sel) return;
    var want=String(value||'').toLowerCase();
    var ok = Array.prototype.some.call(sel.options, function(o){ return o.value===want; });
    sel.value = ok ? want : 'other';
  }

  /* Run BEFORE your original click handler (capture phase) */
  document.addEventListener('click', function(e){
    var pick = e.target.closest && e.target.closest('[data-pick]');
    if(!pick) return;
    var i = Number(pick.getAttribute('data-pick'));
    if(isNaN(i) || !Array.isArray(window.lastSearchItems)) return;
    var item = window.lastSearchItems[i]; if(!item) return;

    // Ensure media type matches the pick
    var mt = document.getElementById('media-type');
    if(mt){ mt.value = (item.type==='podcast' ? 'podcast' : 'book'); }

    // Auto-set Category
    setGenre(guessCategoryFrom(item));
  }, true); // capture=true so this fires first

  // If user flips to Podcast manually, keep Category in sync
  var mtSel = document.getElementById('media-type');
  if (mtSel) {
    mtSel.addEventListener('change', function () {
      if (this.value === 'podcast') { setGenre('podcast'); }
    });
  }

  /* --------- show success modal after a real submit success ---------- */
  var formEl = document.getElementById('book-form');
  if (formEl) {
    formEl.addEventListener('submit', function () {
      var scopeAtSubmit = (typeof currentScope !== 'undefined') ? currentScope : 'main';
      setTimeout(function () {
        try {
          var arr = (typeof ACTIV === 'function') ? ACTIV() : [];
          var last = arr && arr[0];
          if (last && last.type === 'share' && last.payload && last.payload.user === window.currentUser) {
            var b = (typeof BOOKS === 'function' && BOOKS()[0]) ? BOOKS()[0] : null;
            var nameEl = document.getElementById('series-name-input');
            var numEl  = document.getElementById('series-number-input');
            if (b && nameEl && numEl) {
              b.seriesName   = (nameEl.value || '').trim();
              b.seriesNumber = (numEl.value  || '').trim();
              if (typeof saveAll === 'function') saveAll();
            }
            lastRecommendedScope = scopeAtSubmit;
            openAfterShare();
          }
        } catch (_e) {}
      }, 80);
    });
  }
});  <!-- closes document.addEventListener('DOMContentLoaded', ...) -->
</script>
</body>
</html>


